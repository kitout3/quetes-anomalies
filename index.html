<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QuÃªtes d'Anomalies - Multijoueur</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script>
const { useState, useEffect, useMemo } = React;
const { createRoot } = ReactDOM;

// =============================================
// FIREBASE CONFIG - INJECTED BY GITHUB ACTIONS
// =============================================
const firebaseConfig = {
  apiKey: "__FIREBASE_API_KEY__",
  authDomain: "__FIREBASE_AUTH_DOMAIN__",
  databaseURL: "__FIREBASE_DATABASE_URL__",
  projectId: "__FIREBASE_PROJECT_ID__",
  storageBucket: "__FIREBASE_STORAGE_BUCKET__",
  messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
  appId: "__FIREBASE_APP_ID__"
};

let auth, database;
try {
  if (!firebaseConfig.apiKey.startsWith("__")) {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    database = firebase.database();
  }
} catch (e) { console.error("Firebase error:", e); }

// ============================================================================
// PERSONNAGES
// ============================================================================
const CHARACTERS = {
  CHASSEUR: {
    key: "CHASSEUR", name: "Le Chasseur", emoji: "ðŸ¹", pvMax: 6,
    role: "Harceleur â€“ QuÃªtes â€“ Combat Ã  distance",
    concept: "SpÃ©cialiste du contrÃ´le spatial et de la pression indirecte.",
    skills: [
      "Attaque Ã  distance (1 biome) sans riposte",
      "+1 permanent vs monstres de quÃªte",
      "+1 vs territoires Ã  distance"
    ],
    style: "Tactique, opportuniste, faible en dÃ©fense directe.",
    questBonus: 1, noCounterDamage: true
  },
  MARCHAND: {
    key: "MARCHAND", name: "Le Marchand", emoji: "ðŸª™", pvMax: 6,
    role: "Ã‰conomie â€“ Monopoles â€“ Fin de partie",
    concept: "Transforme l'or en levier stratÃ©gique.",
    skills: [
      "+4 Or au dÃ©part et Ã  chaque passage DÃ©part",
      "AchÃ¨te territoires avec or (sans jet)",
      "+1 PDV/monopole en fin de partie"
    ],
    style: "Gestionnaire, sÃ©curisant, dangereux si non contenu.",
    startGoldBonus: 4, passGoldBonus: 4
  },
  HOMME_BETE: {
    key: "HOMME_BETE", name: "L'Homme-bÃªte", emoji: "ðŸº", pvMax: 10,
    role: "Berserker â€“ Combat prolongÃ©",
    concept: "Convertit sa vitalitÃ© en puissance brute.",
    skills: [
      "Sacrifie PV â†’ bonus au jet d'attaque",
      "+2 PV sur victoire en combat",
      "Inflige 1 dÃ©gÃ¢t de riposte quand attaquÃ©"
    ],
    style: "Agressif, rÃ©silient, trÃ¨s difficile Ã  Ã©liminer.",
    healOnWin: 2, counterDamage: 1
  },
  CHEVALIER: {
    key: "CHEVALIER", name: "Le Chevalier", emoji: "âš”ï¸", pvMax: 10,
    role: "ConquÃªte â€“ ContrÃ´le de carte",
    concept: "Chaque victoire militaire devient expansion durable.",
    skills: [
      "Capture territoire adverse sur victoire",
      "+1 vs territoires neutres",
      "+1 PDV/territoire par biome complet"
    ],
    style: "Expansionniste, dominateur, puissant sur la durÃ©e.",
    territoryBonus: 1
  },
  VICAIRE: {
    key: "VICAIRE", name: "Le Vicaire", emoji: "âœ¨", pvMax: 8,
    role: "Support â€“ Optimisation â€“ ContrÃ´le indirect",
    concept: "Manipule la chance et stabilise les situations critiques.",
    skills: [
      "Relance dÃ© de stat (coÃ»t: 1 ressource)",
      "BÃ©nÃ©diction +2 (coÃ»t: 2 ressources) - Recharge: DÃ©part",
      "+1 PDV par quÃªte accomplie"
    ],
    style: "Flexible, diplomatique, fort en optimisation.",
    questPdvBonus: 1, canReroll: true, canBless: true
  },
  HERETIQUE: {
    key: "HERETIQUE", name: "L'HÃ©rÃ©tique", emoji: "ðŸ’€", pvMax: 8,
    role: "Sabotage â€“ MalÃ©dictions â€“ Assassinat",
    concept: "Affaiblit avant d'achever.",
    skills: [
      "Choisit la stat lors d'un combat vs joueur",
      "MalÃ©diction -2 (coÃ»t: 3 PV) - Recharge: DÃ©part",
      "+1 PDV quand il tue un joueur maudit"
    ],
    style: "Cruel, calculateur, extrÃªmement punitif en duel.",
    chooseStat: true, canCurse: true, cursedKillBonus: 1
  }
};

const STATISTIQUES = ["Endurance", "Force", "Vitesse", "Perception", "Sagesse", "Intelligence"];
const STAT_NAMES = {endurance:"Endurance",force:"Force",vitesse:"Vitesse",perception:"Perception",sagesse:"Sagesse",intelligence:"Intelligence"};
const STAT_MAPPING = {"Endurance":"endurance","Force":"force","Vitesse":"vitesse","Perception":"perception","Sagesse":"sagesse","Intelligence":"intelligence"};

const RESOURCE_MAPPING = {
  "PiÃ¨ce d'Or": { key: "or", displayName: "Or" },
  "Ecorce CuivrÃ©e": { key: "cuivre", displayName: "Cuivre" },
  "Sable ArgentÃ©": { key: "argent", displayName: "Argent" },
  "Roche Obsidienne": { key: "obsidienne", displayName: "Obsidienne" }
};

// ============================================================================
// CARTES ANOMALIES
// ============================================================================
const ANOMALIES = [
  "Soignez 2 [Point de vie].",
  "Soignez 4 [Point de vie].",
  "Soignez 6 [Point de vie].",
  "Perdez 2 [Point de vie].",
  "Perdez 4 [Point de vie].",
  "Perdez 6 [Point de vie].",
  "Obtenez [BÃ©nÃ©diction] de [Endurance].",
  "Obtenez [BÃ©nÃ©diction] de [Force].",
  "Obtenez [BÃ©nÃ©diction] de [Vitesse].",
  "Obtenez [BÃ©nÃ©diction] de [Perception].",
  "Obtenez [BÃ©nÃ©diction] de [Sagesse].",
  "Obtenez [BÃ©nÃ©diction] de [Intelligence].",
  "Obtenez [MalÃ©diction] de [Endurance].",
  "Obtenez [MalÃ©diction] de [Force].",
  "Obtenez [MalÃ©diction] de [Vitesse].",
  "Obtenez [MalÃ©diction] de [Perception].",
  "Obtenez [MalÃ©diction] de [Sagesse].",
  "Obtenez [MalÃ©diction] de [Intelligence].",
  "Gagnez 8 [PiÃ¨ce d'Or].",
  "Gagnez 4 [PiÃ¨ce d'Or].",
  "Gagnez 6 [Ecorce CuivrÃ©e].",
  "Gagnez 3 [Ecorce CuivrÃ©e].",
  "Gagnez 4 [Sable ArgentÃ©].",
  "Gagnez 2 [Sable ArgentÃ©].",
  "Gagnez 2 [Roche Obsidienne].",
  "Gagnez 1 [Roche Obsidienne].",
  "Perdez 4 [PiÃ¨ce d'Or].",
  "Perdez 3 [Ecorce CuivrÃ©e].",
  "Perdez 2 [Sable ArgentÃ©].",
  "Perdez 1 [Roche Obsidienne].",
  "Rechargez votre pouvoir spÃ©cial."
];

// ============================================================================
// CARTES QUÃŠTES
// ============================================================================
const QUETES = [
  "Dans le territoire [ForÃªt], Ã©liminer la crÃ©ature de difficultÃ© 6 en [Endurance] pour gagner 3 [Point de victoire].",
  "Dans le territoire [ForÃªt], Ã©liminer la crÃ©ature de difficultÃ© 8 en [Force] pour gagner 4 [Point de victoire].",
  "Dans le territoire [DÃ©sert], Ã©liminer la crÃ©ature de difficultÃ© 6 en [Vitesse] pour gagner 3 [Point de victoire].",
  "Dans le territoire [DÃ©sert], Ã©liminer la crÃ©ature de difficultÃ© 8 en [Perception] pour gagner 4 [Point de victoire].",
  "Dans le territoire [Montagne], Ã©liminer la crÃ©ature de difficultÃ© 6 en [Sagesse] pour gagner 3 [Point de victoire].",
  "Dans le territoire [Montagne], Ã©liminer la crÃ©ature de difficultÃ© 10 en [Intelligence] pour gagner 5 [Point de victoire].",
  "Echanger 8 [PiÃ¨ce d'Or] contre 2 [Point de victoire].",
  "Echanger 4 [PiÃ¨ce d'Or] contre 1 [Point de victoire].",
  "Echanger 6 [Ecorce CuivrÃ©e] contre 2 [Point de victoire].",
  "Echanger 3 [Ecorce CuivrÃ©e] contre 1 [Point de victoire].",
  "Echanger 4 [Sable ArgentÃ©] contre 2 [Point de victoire].",
  "Echanger 2 [Sable ArgentÃ©] contre 1 [Point de victoire].",
  "Echanger 2 [Roche Obsidienne] contre 2 [Point de victoire].",
  "Echanger 1 [Roche Obsidienne] contre 1 [Point de victoire]."
];

// ============================================================================
// FONCTIONS UTILITAIRES
// ============================================================================
const genCode = () => {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let code = "";
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
};

function parseAnomaly(text) {
  let m;
  if (m = text.match(/Soignez (\d+)/)) return { type: 'heal', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Point de vie\]/)) return { type: 'damage', amount: +m[1] };
  if (m = text.match(/\[BÃ©nÃ©diction\] de \[(.+?)\]/)) {
    const statKey = STAT_MAPPING[m[1]];
    return { type: 'bless', stat: statKey, statName: m[1] };
  }
  if (m = text.match(/\[MalÃ©diction\] de \[(.+?)\]/)) {
    const statKey = STAT_MAPPING[m[1]];
    return { type: 'curse', stat: statKey, statName: m[1] };
  }
  if (m = text.match(/Gagnez (\d+) \[PiÃ¨ce d'Or\]/)) return { type: 'gainOr', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[PiÃ¨ce d'Or\]/)) return { type: 'loseOr', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Ecorce/)) return { type: 'gainCuivre', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Ecorce/)) return { type: 'loseCuivre', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Sable/)) return { type: 'gainArgent', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Sable/)) return { type: 'loseArgent', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Roche/)) return { type: 'gainObsidienne', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Roche/)) return { type: 'loseObsidienne', amount: +m[1] };
  if (text.includes('Rechargez')) return { type: 'recharge' };
  return { type: 'other' };
}

function parseQuest(text) {
  const pdvMatch = text.match(/(\d+) \[Point de victoire\]/);
  const pdv = pdvMatch ? +pdvMatch[1] : 0;
  
  const exchangeMatch = text.match(/Echanger (\d+) \[(.+?)\] contre/);
  if (exchangeMatch) {
    const resourceInfo = RESOURCE_MAPPING[exchangeMatch[2]];
    return {
      pdv, isExchange: true, isCombat: false,
      resourceKey: resourceInfo?.key,
      resourceDisplayName: resourceInfo?.displayName,
      resourceAmount: +exchangeMatch[1]
    };
  }
  
  const combatMatch = text.match(/difficultÃ© (\d+) en \[(.+?)\]/);
  if (combatMatch) {
    const statKey = STAT_MAPPING[combatMatch[2]];
    return {
      pdv, isExchange: false, isCombat: true,
      difficulty: +combatMatch[1],
      stat: statKey,
      statName: combatMatch[2]
    };
  }
  
  return { pdv, isExchange: false, isCombat: false };
}


// ============================================================================
// APP PRINCIPAL
// ============================================================================
function App() {
  const [screen, setScreen] = useState("menu");
  const [user, setUser] = useState(null);
  const [gameId, setGameId] = useState(null);
  const [game, setGame] = useState(null);
  const [playerName, setPlayerName] = useState("");
  const [joinCode, setJoinCode] = useState("");
  const [notif, setNotif] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!auth) { setLoading(false); setUser({ uid: "local_" + Date.now() }); return; }
    const unsub = auth.onAuthStateChanged((u) => {
      if (u) { setUser({ uid: u.uid }); setLoading(false); }
      else auth.signInAnonymously().then(() => setLoading(false)).catch(() => setLoading(false));
    });
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!database || !gameId) return;
    const ref = database.ref("games/" + gameId);
    const cb = ref.on("value", (snap) => {
      const d = snap.val();
      if (d) {
        setGame(d);
        if (d.status === "playing" && screen === "lobby") setScreen("game");
      }
    });
    return () => ref.off("value", cb);
  }, [gameId, screen]);

  const notify = (msg, type) => { setNotif({ msg, type }); setTimeout(() => setNotif(null), 3000); };

  const createGame = async () => {
    if (!playerName.trim()) return notify("Entrez votre nom", "error");
    const code = genCode();
    const newGame = {
      code, hostId: user.uid, status: "waiting",
      players: { [user.uid]: { oderId: user.uid, name: playerName.trim(), isHost: true, charKey: null, stats: null } },
      turnOrder: [], currentTurn: 0, drawnAnomalies: [], drawnQuetes: [], createdAt: Date.now()
    };
    if (database) await database.ref("games/" + code).set(newGame);
    setGameId(code);
    setScreen("lobby");
  };

  const joinGame = async () => {
    if (!playerName.trim() || joinCode.length !== 6) return notify("Nom et code requis", "error");
    const code = joinCode.toUpperCase();
    if (database) {
      const snap = await database.ref("games/" + code).once("value");
      const g = snap.val();
      if (!g) return notify("Partie introuvable", "error");
      if (g.status !== "waiting") return notify("Partie dÃ©jÃ  commencÃ©e", "error");
      if (Object.keys(g.players).length >= 6) return notify("Partie complÃ¨te", "error");
      await database.ref("games/" + code + "/players/" + user.uid).set({ oderId: user.uid, name: playerName.trim(), isHost: false, charKey: null, stats: null });
    }
    setGameId(code);
    setScreen("lobby");
  };

  if (loading) return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-900 to-blue-900 flex items-center justify-center" },
    React.createElement("div", { className: "w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin" })
  );

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100" },
    notif && React.createElement("div", { className: "fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 " + (notif.type === 'error' ? 'bg-red-500' : 'bg-green-500') + " text-white font-semibold" }, notif.msg),
    screen === "menu" && React.createElement(MenuScreen, { playerName, setPlayerName, setScreen }),
    screen === "create" && React.createElement(CreateScreen, { playerName, setPlayerName, createGame, setScreen }),
    screen === "join" && React.createElement(JoinScreen, { playerName, setPlayerName, joinCode, setJoinCode, joinGame, setScreen }),
    screen === "lobby" && React.createElement(LobbyScreen, { gameId, game, user, setScreen, notify }),
    screen === "game" && React.createElement(GameScreen, { gameId, game, user, notify })
  );
}

// ============================================================================
// MENU SCREEN
// ============================================================================
function MenuScreen({ playerName, setPlayerName, setScreen }) {
  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-900 to-blue-900 flex items-center justify-center p-6" },
    React.createElement("div", { className: "bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full" },
      React.createElement("h1", { className: "text-4xl font-bold text-center mb-2 text-gray-800" }, "QuÃªtes d'Anomalies"),
      React.createElement("p", { className: "text-center text-gray-600 mb-8" }, "Multijoueur temps rÃ©el"),
      React.createElement("div", { className: "mb-6" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Votre pseudo"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg", placeholder: "Entrez votre nom...", value: playerName, onChange: (e) => setPlayerName(e.target.value), maxLength: 16 })
      ),
      React.createElement("div", { className: "space-y-3" },
        React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-blue-700 disabled:opacity-50", onClick: () => setScreen("create"), disabled: !playerName.trim() }, "ðŸŽ® CrÃ©er une partie"),
        React.createElement("button", { className: "w-full py-4 bg-white border-2 border-purple-600 text-purple-600 rounded-xl font-bold text-lg hover:bg-purple-50 disabled:opacity-50", onClick: () => setScreen("join"), disabled: !playerName.trim() }, "ðŸ”— Rejoindre")
      ),
      React.createElement("p", { className: "text-center text-gray-500 text-sm mt-6" }, "2-6 joueurs â€¢ Tour par tour")
    )
  );
}

// ============================================================================
// CREATE/JOIN SCREENS
// ============================================================================
function CreateScreen({ playerName, setPlayerName, createGame, setScreen }) {
  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-900 to-blue-900 flex items-center justify-center p-6" },
    React.createElement("div", { className: "bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full" },
      React.createElement("button", { className: "mb-6 text-purple-600 font-semibold", onClick: () => setScreen("menu") }, "â† Retour"),
      React.createElement("h2", { className: "text-2xl font-bold text-center mb-6" }, "ðŸŽ® CrÃ©er une partie"),
      React.createElement("div", { className: "mb-6" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Votre nom"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl", value: playerName, onChange: (e) => setPlayerName(e.target.value) })
      ),
      React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold disabled:opacity-50", onClick: createGame, disabled: !playerName.trim() }, "CrÃ©er la partie")
    )
  );
}

function JoinScreen({ playerName, setPlayerName, joinCode, setJoinCode, joinGame, setScreen }) {
  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-900 to-blue-900 flex items-center justify-center p-6" },
    React.createElement("div", { className: "bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full" },
      React.createElement("button", { className: "mb-6 text-purple-600 font-semibold", onClick: () => setScreen("menu") }, "â† Retour"),
      React.createElement("h2", { className: "text-2xl font-bold text-center mb-6" }, "ðŸ”— Rejoindre"),
      React.createElement("div", { className: "mb-4" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Votre nom"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl", value: playerName, onChange: (e) => setPlayerName(e.target.value) })
      ),
      React.createElement("div", { className: "mb-6" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Code de la partie"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-center text-2xl font-bold tracking-widest uppercase", placeholder: "ABC123", value: joinCode, onChange: (e) => setJoinCode(e.target.value.toUpperCase()), maxLength: 6 })
      ),
      React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold disabled:opacity-50", onClick: joinGame, disabled: !playerName.trim() || joinCode.length !== 6 }, "Rejoindre")
    )
  );
}

// ============================================================================
// LOBBY SCREEN
// ============================================================================
function LobbyScreen({ gameId, game, user, setScreen, notify }) {
  if (!game) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" },
    React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" })
  );

  const players = Object.values(game.players || {});
  const me = players.find(p => p.oderId === user.uid);
  const isHost = me && me.isHost;
  const takenChars = players.map(p => p.charKey).filter(Boolean);
  const allReady = players.length >= 2 && players.every(p => p.charKey && p.stats);

  const selectChar = (ck) => {
    if (takenChars.includes(ck) && me.charKey !== ck) return;
    if (database) database.ref("games/" + gameId + "/players/" + user.uid + "/charKey").set(ck);
  };

  const startGame = () => {
    if (!isHost || !allReady) return;
    const init = {};
    const order = [];
    Object.entries(game.players).forEach(([uid, p], i) => {
      const ch = CHARACTERS[p.charKey];
      order.push(uid);
      const startGold = ch.startGoldBonus ? 10 + ch.startGoldBonus : 10;
      init[uid] = {
        ...p, index: i, character: ch, characterKey: p.charKey,
        pvCurrent: ch.pvMax, or: startGold, cuivre: 0, argent: 0, obsidienne: 0,
        pdv: 0, tourPlateau: 0,
        effects: [], quests: [],
        skills: ch.skills.map((s, idx) => ({ id: "skill_" + idx, description: s, status: 'AVAILABLE' })),
        usedAttackDice: false, blessAvailable: ch.canBless || false, curseAvailable: ch.canCurse || false
      };
    });
    if (database) database.ref("games/" + gameId).update({ status: "playing", players: init, turnOrder: order, currentTurn: 0 });
  };

  const copyCode = () => {
    if (navigator.clipboard) navigator.clipboard.writeText(gameId);
    notify("Code copiÃ© !", "success");
  };

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 p-4" },
    React.createElement("div", { className: "max-w-2xl mx-auto" },
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "text-center text-gray-600 text-sm mb-2" }, "Code de la partie"),
        React.createElement("div", { className: "text-4xl font-bold text-center text-purple-600 tracking-widest cursor-pointer hover:text-purple-700 py-4 bg-purple-50 rounded-xl border-2 border-dashed border-purple-300", onClick: copyCode }, gameId),
        React.createElement("p", { className: "text-center text-gray-500 text-xs mt-2" }, "Cliquez pour copier")
      ),
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, "Joueurs (" + players.length + "/6)"),
        players.map(p => {
          const isMe = p.oderId === user.uid;
          const ready = p.charKey && p.stats;
          return React.createElement("div", { key: p.oderId, className: "flex items-center gap-3 p-3 rounded-xl mb-2 " + (isMe ? 'bg-purple-50 border-2 border-purple-400' : 'bg-gray-50') },
            React.createElement("div", { className: "w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center text-2xl" }, p.charKey ? CHARACTERS[p.charKey].emoji : "ðŸ‘¤"),
            React.createElement("div", { className: "flex-1" },
              React.createElement("div", { className: "font-semibold text-gray-800 flex items-center gap-2" }, p.name,
                p.isHost && React.createElement("span", { className: "text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full" }, "HÃ´te"),
                isMe && React.createElement("span", { className: "text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full" }, "Vous")
              ),
              React.createElement("div", { className: "text-sm text-gray-600" }, p.charKey ? CHARACTERS[p.charKey].name : "Choisit...")
            ),
            ready && React.createElement("span", { className: "text-green-600 font-bold text-xl" }, "âœ“")
          );
        })
      ),
      me && !me.charKey && React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, "Choisissez votre personnage"),
        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
          Object.values(CHARACTERS).map(ch => {
            const taken = takenChars.includes(ch.key);
            return React.createElement("div", { key: ch.key, onClick: () => !taken && selectChar(ch.key), className: "p-4 rounded-xl border-2 cursor-pointer transition-all " + (taken ? 'opacity-40 cursor-not-allowed' : 'hover:border-purple-400 hover:bg-purple-50') },
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("span", { className: "text-3xl" }, ch.emoji),
                React.createElement("div", { className: "flex-1" },
                  React.createElement("div", { className: "font-bold" }, ch.name),
                  React.createElement("div", { className: "text-xs text-gray-600" }, ch.role),
                  React.createElement("div", { className: "text-sm text-purple-600 font-semibold" }, "â¤ï¸ " + ch.pvMax + " PV")
                ),
                taken && React.createElement("span", { className: "text-xs bg-red-500 text-white px-2 py-1 rounded" }, "PRIS")
              )
            );
          })
        )
      ),
      me && me.charKey && !me.stats && React.createElement(StatsAlloc, { gameId, oderId: user.uid, character: CHARACTERS[me.charKey], notify }),
      isHost && React.createElement("button", { className: "w-full py-4 rounded-xl font-bold text-lg transition-all " + (allReady ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'), onClick: startGame, disabled: !allReady }, allReady ? "ðŸš€ Lancer la partie !" : "En attente (" + players.filter(p => p.charKey && p.stats).length + "/" + players.length + ")")
    )
  );
}

// ============================================================================
// STATS ALLOCATION
// ============================================================================
function StatsAlloc({ gameId, oderId, character, notify }) {
  const MODIFIERS = [-2, -1, 0, 0, 1, 2];
  const [allocation, setAllocation] = useState({ endurance: null, force: null, vitesse: null, perception: null, sagesse: null, intelligence: null });

  const isModifierUsed = (modifier) => {
    const usedCount = Object.values(allocation).filter(v => v === modifier).length;
    const totalCount = MODIFIERS.filter(m => m === modifier).length;
    return usedCount >= totalCount;
  };

  const handleClick = (stat, modifier) => {
    if (allocation[stat] === modifier) setAllocation({ ...allocation, [stat]: null });
    else if (!isModifierUsed(modifier) || allocation[stat] !== null) setAllocation({ ...allocation, [stat]: modifier });
  };

  const isValid = Object.values(allocation).every(v => v !== null);

  const confirmStats = () => {
    if (!isValid) return;
    if (database) database.ref("games/" + gameId + "/players/" + oderId + "/stats").set(allocation);
    notify("Stats enregistrÃ©es !", "success");
  };

  return React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
    React.createElement("h3", { className: "font-bold text-gray-800 mb-2" }, "RÃ©partissez vos stats pour " + character.name),
    React.createElement("p", { className: "text-gray-600 text-sm mb-4" }, "Assignez: -2, -1, 0, 0, +1, +2"),
    React.createElement("div", { className: "space-y-4" },
      Object.entries(STAT_NAMES).map(([key, name]) => {
        const val = allocation[key];
        return React.createElement("div", { key, className: "bg-gray-50 rounded-lg p-3" },
          React.createElement("div", { className: "flex justify-between items-center mb-2" },
            React.createElement("span", { className: "font-semibold text-gray-700" }, name),
            val !== null && React.createElement("span", { className: "font-bold " + (val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-blue-600') }, val > 0 ? "+" + val : val)
          ),
          React.createElement("div", { className: "flex gap-2 justify-center" },
            MODIFIERS.map((mod, idx) => {
              const isSelected = val === mod;
              const isDisabled = !isSelected && isModifierUsed(mod);
              return React.createElement("button", { key: idx, onClick: () => handleClick(key, mod), disabled: isDisabled, className: "w-12 h-12 rounded-full font-bold text-sm transition-all " + (isSelected ? (mod > 0 ? 'bg-green-600 text-white ring-4 ring-green-300' : mod < 0 ? 'bg-red-600 text-white ring-4 ring-red-300' : 'bg-blue-600 text-white ring-4 ring-blue-300') : isDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white border-2 border-gray-300 hover:border-purple-500') }, mod > 0 ? "+" + mod : mod);
            })
          )
        );
      })
    ),
    React.createElement("button", { className: "w-full py-3 rounded-xl font-bold mt-4 " + (isValid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'), onClick: confirmStats, disabled: !isValid }, isValid ? "âœ“ Confirmer" : "ComplÃ©tez toutes les stats")
  );
}

// ============================================================================
// GAME SCREEN
// ============================================================================
function GameScreen({ gameId, game, user, notify }) {
  const [activeTab, setActiveTab] = useState('anomalie');

  if (!game || !game.players || !game.turnOrder) {
    return React.createElement("div", { className: "min-h-screen flex items-center justify-center" },
      React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" })
    );
  }

  const order = game.turnOrder;
  const curIdx = game.currentTurn || 0;
  const curUid = order[curIdx];
  const curPlayer = game.players[curUid];
  const me = game.players[user.uid];
  const isMyTurn = curUid === user.uid;
  const players = order.map(uid => game.players[uid]).filter(Boolean);

  const updateMe = (updates) => database ? database.ref("games/" + gameId + "/players/" + user.uid).update(updates) : null;
  const updatePlayer = (uid, updates) => database ? database.ref("games/" + gameId + "/players/" + uid).update(updates) : null;
  const updateGame = (updates) => database ? database.ref("games/" + gameId).update(updates) : null;

  const nextTurn = () => {
    if (!isMyTurn) return;
    const next = (curIdx + 1) % order.length;
    updateMe({ usedAttackDice: false });
    updateGame({ currentTurn: next });
    notify("Tour terminÃ© !", "success");
  };

  // Death check
  useEffect(() => {
    if (me && me.pvCurrent <= 0) {
      alert(me.name + " est mort ! Retour Ã  la case dÃ©part avec PV max.");
      updateMe({ pvCurrent: me.character.pvMax, effects: [] });
    }
  }, [me?.pvCurrent]);

  const tabs = [
    { id: "anomalie", label: "Anomalie" },
    { id: "quete", label: "QuÃªte" },
    { id: "statistique", label: "Stat" },
    { id: "de", label: "DÃ©" },
    { id: "personnage", label: "Perso" }
  ];

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 flex flex-col" },
    // Header
    React.createElement("div", { className: "bg-gradient-to-r " + (isMyTurn ? "from-green-600 to-teal-600" : "from-purple-600 to-blue-600") + " text-white shadow-lg p-4" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "text-sm font-semibold mb-1" }, isMyTurn ? "ðŸŽ¯ C'EST VOTRE TOUR !" : "Tour de " + (curPlayer?.name || "?")),
        React.createElement("div", { className: "flex items-center justify-between" },
          React.createElement("div", null,
            React.createElement("h2", { className: "text-2xl font-bold" }, me?.name),
            React.createElement("p", { className: "text-sm opacity-90" }, me?.character?.name)
          ),
          React.createElement("div", { className: "text-right" },
            React.createElement("div", { className: "text-3xl font-bold" }, (me?.pvCurrent || 0) + "/" + (me?.character?.pvMax || 0)),
            React.createElement("div", { className: "text-xs" }, "Points de Vie")
          )
        ),
        React.createElement("div", { className: "flex gap-2 mt-2 text-xs flex-wrap" },
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, "ðŸª™ " + (me?.or || 0)),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, "ðŸŒ³ " + (me?.cuivre || 0)),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, "ðŸœï¸ " + (me?.argent || 0)),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, "â›°ï¸ " + (me?.obsidienne || 0)),
          React.createElement("span", { className: "bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold" }, "ðŸ† " + (me?.pdv || 0) + " PDV")
        )
      )
    ),
    // Tabs
    React.createElement("div", { className: "bg-white shadow-md" },
      React.createElement("div", { className: "max-w-4xl mx-auto overflow-x-auto" },
        React.createElement("div", { className: "flex" },
          tabs.map(t => React.createElement("button", { key: t.id, onClick: () => setActiveTab(t.id), className: "flex-shrink-0 px-6 py-3 font-semibold transition-colors border-b-4 " + (activeTab === t.id ? 'bg-blue-600 text-white border-blue-800' : 'bg-gray-100 text-gray-600 border-transparent hover:bg-gray-200') }, t.label))
        )
      )
    ),
    // Content
    React.createElement("div", { className: "flex-1 overflow-y-auto" },
      React.createElement("div", { className: "max-w-4xl mx-auto p-6" },
        React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-6" },
          activeTab === 'anomalie' && React.createElement(AnomalieTab, { me, isMyTurn, updateMe, notify, game, updateGame }),
          activeTab === 'quete' && React.createElement(QueteTab, { me, isMyTurn, updateMe, notify, game, updateGame }),
          activeTab === 'statistique' && React.createElement(StatistiqueTab, null),
          activeTab === 'de' && React.createElement(DeTab, { me, isMyTurn, updateMe, notify, game, updateGame, updatePlayer, players, user }),
          activeTab === 'personnage' && React.createElement(PersonnageTab, { me, updateMe, notify, gameId, user })
        ),
        // End turn button
        React.createElement("div", { className: "grid grid-cols-1 gap-4" },
          React.createElement("button", { onClick: nextTurn, disabled: !isMyTurn, className: "py-4 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-xl font-bold text-lg hover:from-green-700 hover:to-teal-700 transition-colors shadow-lg disabled:opacity-50" }, "âœ“ Fin du tour")
        )
      )
    )
  );
}

// ============================================================================
// ANOMALIE TAB
// ============================================================================
function AnomalieTab({ me, isMyTurn, updateMe, notify, game, updateGame }) {
  const [currentCard, setCurrentCard] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [appliedEffect, setAppliedEffect] = useState(null);

  const drawCard = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    
    const drawn = game.drawnAnomalies || [];
    const availableCards = ANOMALIES.filter((_, index) => !drawn.includes(index));
    if (availableCards.length === 0) return notify("Toutes les anomalies ont Ã©tÃ© tirÃ©es !", "error");

    setIsAnimating(true);
    setCurrentCard(null);
    setAppliedEffect(null);

    setTimeout(() => {
      const randomIndex = Math.floor(Math.random() * availableCards.length);
      const selectedCard = availableCards[randomIndex];
      const originalIndex = ANOMALIES.indexOf(selectedCard);

      updateGame({ drawnAnomalies: [...drawn, originalIndex] });
      setCurrentCard(selectedCard);
      setIsAnimating(false);

      const effect = parseAnomaly(selectedCard);
      applyEffect(effect);
    }, 300);
  };

  const applyEffect = (effect) => {
    let msg = "";
    if (effect.type === 'heal') {
      const newPV = Math.min(me.character.pvMax, me.pvCurrent + effect.amount);
      updateMe({ pvCurrent: newPV });
      msg = "+" + effect.amount + " PV";
    } else if (effect.type === 'damage') {
      const newPV = Math.max(0, me.pvCurrent - effect.amount);
      updateMe({ pvCurrent: newPV });
      msg = "-" + effect.amount + " PV";
    } else if (effect.type === 'bless') {
      const newEffect = { id: "effect_" + Date.now(), type: 'BLESS', stat: effect.stat, delta: 2, name: "BÃ©nÃ©diction de " + effect.statName };
      updateMe({ effects: [...(me.effects || []), newEffect] });
      msg = "BÃ©nÃ©diction " + effect.statName + " (+2)";
    } else if (effect.type === 'curse') {
      const newEffect = { id: "effect_" + Date.now(), type: 'CURSE', stat: effect.stat, delta: -2, name: "MalÃ©diction de " + effect.statName };
      updateMe({ effects: [...(me.effects || []), newEffect] });
      msg = "MalÃ©diction " + effect.statName + " (-2)";
    } else if (effect.type === 'gainOr') {
      updateMe({ or: (me.or || 0) + effect.amount });
      msg = "+" + effect.amount + " Or";
    } else if (effect.type === 'loseOr') {
      updateMe({ or: Math.max(0, (me.or || 0) - effect.amount) });
      msg = "-" + effect.amount + " Or";
    } else if (effect.type === 'gainCuivre') {
      updateMe({ cuivre: (me.cuivre || 0) + effect.amount });
      msg = "+" + effect.amount + " Cuivre";
    } else if (effect.type === 'loseCuivre') {
      updateMe({ cuivre: Math.max(0, (me.cuivre || 0) - effect.amount) });
      msg = "-" + effect.amount + " Cuivre";
    } else if (effect.type === 'gainArgent') {
      updateMe({ argent: (me.argent || 0) + effect.amount });
      msg = "+" + effect.amount + " Argent";
    } else if (effect.type === 'loseArgent') {
      updateMe({ argent: Math.max(0, (me.argent || 0) - effect.amount) });
      msg = "-" + effect.amount + " Argent";
    } else if (effect.type === 'gainObsidienne') {
      updateMe({ obsidienne: (me.obsidienne || 0) + effect.amount });
      msg = "+" + effect.amount + " Obsidienne";
    } else if (effect.type === 'loseObsidienne') {
      updateMe({ obsidienne: Math.max(0, (me.obsidienne || 0) - effect.amount) });
      msg = "-" + effect.amount + " Obsidienne";
    } else if (effect.type === 'recharge') {
      updateMe({ blessAvailable: me.character?.canBless || false, curseAvailable: me.character?.canCurse || false });
      msg = "Pouvoir rechargÃ© !";
    }
    setAppliedEffect(msg);
  };

  const resetDeck = () => {
    if (confirm("RÃ©initialiser le deck d'anomalies ?")) {
      updateGame({ drawnAnomalies: [] });
      setCurrentCard(null);
      setAppliedEffect(null);
    }
  };

  const remaining = ANOMALIES.length - (game.drawnAnomalies || []).length;

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("div", { className: "text-center" },
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800 mb-2" }, "Anomalies"),
      React.createElement("p", { className: "text-gray-600" }, "Cartes restantes: ", React.createElement("strong", null, remaining), " / " + ANOMALIES.length)
    ),
    React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-purple-600 to-purple-800 rounded-xl p-8 flex flex-col items-center justify-center transition-all " + (isAnimating ? 'scale-95 opacity-50' : 'scale-100') },
      currentCard ? React.createElement("div", { className: "text-center" },
        React.createElement("p", { className: "text-xl text-white font-medium" }, currentCard),
        appliedEffect && React.createElement("p", { className: "text-yellow-300 font-bold mt-3 text-lg" }, "âœ¨ " + appliedEffect)
      ) : React.createElement("p", { className: "text-gray-300 text-center italic" }, 'Cliquez sur "Tirer une anomalie"')
    ),
    React.createElement("div", { className: "grid grid-cols-2 gap-4" },
      React.createElement("button", { onClick: drawCard, disabled: isAnimating || !isMyTurn, className: "py-4 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 transition-colors disabled:opacity-50" }, "ðŸ”® Tirer une anomalie"),
      React.createElement("button", { onClick: resetDeck, className: "py-4 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700 transition-colors" }, "ðŸ”„ RÃ©initialiser")
    ),
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("p", { className: "text-sm text-gray-700" }, React.createElement("strong", null, "â„¹ï¸ Application automatique:")),
      React.createElement("ul", { className: "text-xs text-gray-600 mt-2 space-y-1" },
        React.createElement("li", null, "â€¢ Soins/DÃ©gÃ¢ts â†’ PV modifiÃ©s âœ“"),
        React.createElement("li", null, "â€¢ BÃ©nÃ©dictions â†’ +2 Ã  la stat âœ“"),
        React.createElement("li", null, "â€¢ MalÃ©dictions â†’ -2 Ã  la stat âœ“"),
        React.createElement("li", null, "â€¢ Ressources â†’ AjoutÃ©es/RetirÃ©es âœ“")
      )
    )
  );
}

// ============================================================================
// QUETE TAB
// ============================================================================
function QueteTab({ me, isMyTurn, updateMe, notify, game, updateGame }) {
  const [currentCard, setCurrentCard] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [attemptResult, setAttemptResult] = useState(null);
  const [showQuestChoice, setShowQuestChoice] = useState(false);
  const [pendingQuest, setPendingQuest] = useState(null);

  const drawCard = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    
    const drawn = game.drawnQuetes || [];
    const availableCards = QUETES.filter((_, index) => !drawn.includes(index));
    if (availableCards.length === 0) return notify("Toutes les quÃªtes ont Ã©tÃ© tirÃ©es !", "error");

    setIsAnimating(true);
    setCurrentCard(null);

    setTimeout(() => {
      const randomIndex = Math.floor(Math.random() * availableCards.length);
      const selectedCard = availableCards[randomIndex];
      const originalIndex = QUETES.indexOf(selectedCard);

      updateGame({ drawnQuetes: [...drawn, originalIndex] });
      setCurrentCard(selectedCard);
      setIsAnimating(false);

      const newQuest = { id: "quest_" + Date.now(), text: selectedCard, completed: false };

      if ((me.quests || []).length >= 2) {
        setPendingQuest(newQuest);
        setShowQuestChoice(true);
      } else {
        updateMe({ quests: [...(me.quests || []), newQuest] });
      }
    }, 300);
  };

  const handleQuestChoice = (action, questIdToRemove) => {
    if (action === 'refuse') {
      setShowQuestChoice(false);
      setPendingQuest(null);
    } else if (action === 'replace') {
      const newQuests = (me.quests || []).filter(q => q.id !== questIdToRemove);
      newQuests.push(pendingQuest);
      updateMe({ quests: newQuests });
      setShowQuestChoice(false);
      setPendingQuest(null);
    }
  };

  const attemptQuest = (questId, questText) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("Jet d'attaque dÃ©jÃ  utilisÃ© ce tour", "error");

    const questInfo = parseQuest(questText);
    if (!questInfo.isCombat) return notify("Cette quÃªte ne nÃ©cessite pas de jet !", "error");

    const statKey = questInfo.stat;
    const diceRoll = Math.floor(Math.random() * 10);
    const baseStat = me.stats?.[statKey] || 0;
    const effectsBonus = (me.effects || []).filter(e => e.stat === statKey).reduce((sum, e) => sum + e.delta, 0);
    const questBonus = me.character?.questBonus || 0;
    const total = diceRoll + baseStat + effectsBonus + questBonus;
    const difficulty = questInfo.difficulty;
    const success = total >= difficulty;

    setAttemptResult({ stat: questInfo.statName, diceRoll, baseStat, effectsBonus, questBonus, total, difficulty, success, pdv: questInfo.pdv });

    if (success) {
      const newQuests = (me.quests || []).filter(q => q.id !== questId);
      const pdvBonus = me.character?.questPdvBonus || 0;
      updateMe({ quests: newQuests, pdv: (me.pdv || 0) + questInfo.pdv + pdvBonus, usedAttackDice: true });
      setTimeout(() => { notify("QuÃªte rÃ©ussie ! +" + (questInfo.pdv + pdvBonus) + " PDV", "success"); setAttemptResult(null); }, 2000);
    } else {
      const damage = Math.max(1, difficulty - total);
      updateMe({ pvCurrent: Math.max(0, me.pvCurrent - damage), usedAttackDice: true });
      setTimeout(() => { notify("QuÃªte Ã©chouÃ©e ! -" + damage + " PV", "error"); setAttemptResult(null); }, 2000);
    }
  };

  const completeExchangeQuest = (questId, questText) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    
    const questInfo = parseQuest(questText);
    if (!questInfo.isExchange) return;

    const playerResource = me[questInfo.resourceKey] || 0;
    if (playerResource < questInfo.resourceAmount) {
      return notify("Ressources insuffisantes ! Requis: " + questInfo.resourceAmount + ", Disponible: " + playerResource, "error");
    }

    const newQuests = (me.quests || []).filter(q => q.id !== questId);
    const pdvBonus = me.character?.questPdvBonus || 0;
    updateMe({
      quests: newQuests,
      pdv: (me.pdv || 0) + questInfo.pdv + pdvBonus,
      [questInfo.resourceKey]: playerResource - questInfo.resourceAmount
    });
    notify("QuÃªte terminÃ©e ! -" + questInfo.resourceAmount + " " + questInfo.resourceDisplayName + ", +" + (questInfo.pdv + pdvBonus) + " PDV", "success");
  };

  const resetDeck = () => {
    if (confirm("RÃ©initialiser le deck de quÃªtes ?")) {
      updateGame({ drawnQuetes: [] });
      setCurrentCard(null);
    }
  };

  const remaining = QUETES.length - (game.drawnQuetes || []).length;

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("div", { className: "text-center" },
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800 mb-2" }, "QuÃªtes"),
      React.createElement("p", { className: "text-gray-600" }, "Cartes restantes: ", React.createElement("strong", null, remaining), " / " + QUETES.length)
    ),
    React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-8 flex items-center justify-center transition-all " + (isAnimating ? 'scale-95 opacity-50' : 'scale-100') },
      currentCard ? React.createElement("p", { className: "text-lg text-center text-white font-medium" }, currentCard) : React.createElement("p", { className: "text-gray-300 text-center italic" }, 'Cliquez sur "Tirer une quÃªte"')
    ),
    attemptResult && React.createElement("div", { className: "bg-gradient-to-r " + (attemptResult.success ? 'from-green-600 to-green-800' : 'from-red-600 to-red-800') + " rounded-xl p-6 text-white" },
      React.createElement("div", { className: "text-center mb-4" },
        React.createElement("div", { className: "text-2xl font-bold mb-2" }, attemptResult.success ? "âœ… SUCCÃˆS" : "âŒ Ã‰CHEC"),
        React.createElement("div", { className: "text-xl" }, attemptResult.stat),
        React.createElement("div", { className: "text-5xl font-bold my-2" }, attemptResult.total + " vs " + attemptResult.difficulty)
      ),
      React.createElement("div", { className: "bg-white bg-opacity-20 rounded-lg p-4 text-sm" },
        React.createElement("div", { className: "flex justify-between mb-1" }, React.createElement("span", null, "DÃ©:"), React.createElement("span", { className: "font-bold" }, attemptResult.diceRoll)),
        React.createElement("div", { className: "flex justify-between mb-1" }, React.createElement("span", null, "Base:"), React.createElement("span", { className: "font-bold" }, attemptResult.baseStat >= 0 ? "+" + attemptResult.baseStat : attemptResult.baseStat)),
        React.createElement("div", { className: "flex justify-between mb-1" }, React.createElement("span", null, "Ã‰tats:"), React.createElement("span", { className: "font-bold" }, attemptResult.effectsBonus >= 0 ? "+" + attemptResult.effectsBonus : attemptResult.effectsBonus)),
        attemptResult.questBonus > 0 && React.createElement("div", { className: "flex justify-between mb-1" }, React.createElement("span", null, "Bonus quÃªte:"), React.createElement("span", { className: "font-bold" }, "+" + attemptResult.questBonus))
      )
    ),
    showQuestChoice && pendingQuest && React.createElement("div", { className: "bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-800 mb-3" }, "âš ï¸ Limite de quÃªtes atteinte (2 max)"),
      React.createElement("p", { className: "text-sm text-gray-700 mb-4" }, React.createElement("strong", null, "Nouvelle quÃªte:"), " " + pendingQuest.text),
      React.createElement("div", { className: "space-y-2 mb-4" },
        (me.quests || []).map(quest => React.createElement("button", { key: quest.id, onClick: () => handleQuestChoice('replace', quest.id), className: "w-full text-left p-3 bg-white border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50" },
          React.createElement("p", { className: "text-xs text-gray-700" }, "Remplacer: " + quest.text)
        ))
      ),
      React.createElement("button", { onClick: () => handleQuestChoice('refuse'), className: "w-full py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700" }, "Refuser la nouvelle quÃªte")
    ),
    React.createElement("div", { className: "grid grid-cols-2 gap-4" },
      React.createElement("button", { onClick: drawCard, disabled: isAnimating || !isMyTurn || showQuestChoice, className: "py-4 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors disabled:opacity-50" }, "ðŸ“œ Tirer une quÃªte"),
      React.createElement("button", { onClick: resetDeck, className: "py-4 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700 transition-colors" }, "ðŸ”„ RÃ©initialiser")
    ),
    React.createElement("div", null,
      React.createElement("h4", { className: "text-lg font-bold text-gray-800 mb-3" }, "Mes quÃªtes (" + (me.quests || []).length + "/2)"),
      (me.quests || []).length === 0 ? React.createElement("p", { className: "text-gray-500 text-center py-4" }, "Aucune quÃªte active") :
      React.createElement("div", { className: "space-y-3" },
        (me.quests || []).map(quest => {
          const questInfo = parseQuest(quest.text);
          const isExchange = questInfo.isExchange;
          const isCombat = questInfo.isCombat;
          const hasEnoughResources = isExchange && (me[questInfo.resourceKey] || 0) >= questInfo.resourceAmount;
          
          return React.createElement("div", { key: quest.id, className: "bg-gray-50 rounded-lg p-4 border-2 border-gray-300" },
            React.createElement("p", { className: "text-sm text-gray-700 mb-3" }, quest.text),
            isExchange && React.createElement("p", { className: "text-xs mb-2 font-semibold " + (hasEnoughResources ? 'text-green-600' : 'text-red-600') },
              hasEnoughResources ? "âœ“ Ressources disponibles (" + (me[questInfo.resourceKey] || 0) + "/" + questInfo.resourceAmount + ")" : "âœ— Insuffisant (" + (me[questInfo.resourceKey] || 0) + "/" + questInfo.resourceAmount + ")"
            ),
            isCombat && React.createElement("p", { className: "text-xs mb-2 font-semibold text-blue-600" }, "DifficultÃ©: " + questInfo.difficulty + " en " + questInfo.statName),
            React.createElement("div", { className: "flex gap-2" },
              isExchange && React.createElement("button", { onClick: () => completeExchangeQuest(quest.id, quest.text), disabled: !isMyTurn || !hasEnoughResources, className: "flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50 text-sm" }, "âœ“ Ã‰changer"),
              isCombat && React.createElement("button", { onClick: () => attemptQuest(quest.id, quest.text), disabled: !isMyTurn || me.usedAttackDice || attemptResult, className: "flex-1 py-2 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700 disabled:opacity-50 text-sm" }, "âš”ï¸ Tenter")
            )
          );
        })
      )
    )
  );
}

// ============================================================================
// STATISTIQUE TAB
// ============================================================================
function StatistiqueTab() {
  const [currentStat, setCurrentStat] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);

  const drawStat = () => {
    setIsAnimating(true);
    setCurrentStat(null);
    setTimeout(() => {
      const randomIndex = Math.floor(Math.random() * STATISTIQUES.length);
      setCurrentStat(STATISTIQUES[randomIndex]);
      setIsAnimating(false);
    }, 300);
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "Statistique alÃ©atoire"),
    React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-8 flex items-center justify-center transition-all " + (isAnimating ? 'scale-95 opacity-50' : 'scale-100') },
      currentStat ? React.createElement("p", { className: "text-4xl text-center text-white font-bold" }, currentStat) : React.createElement("p", { className: "text-gray-300 text-center italic" }, 'Cliquez sur "Tirer une statistique"')
    ),
    React.createElement("button", { onClick: drawStat, disabled: isAnimating, className: "w-full py-4 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50" }, "ðŸŽ² Tirer une statistique")
  );
}

// ============================================================================
// DE TAB - DÃ©placement, Attaque, Combat
// ============================================================================
function DeTab({ me, isMyTurn, updateMe, notify, game, updateGame, updatePlayer, players, user }) {
  const [moveResult, setMoveResult] = useState(null);
  const [attackResult, setAttackResult] = useState(null);
  const [isAnimating, setIsAnimating] = useState(false);
  const [combatMode, setCombatMode] = useState(null);
  const [selectedOpponent, setSelectedOpponent] = useState(null);
  const [combatResult, setCombatResult] = useState(null);
  const [chosenStat, setChosenStat] = useState(null);

  const rollMoveDice = () => {
    setIsAnimating(true);
    setMoveResult(null);
    setTimeout(() => {
      const result = Math.floor(Math.random() * 10);
      setMoveResult(result);
      setIsAnimating(false);
    }, 600);
  };

  const rollAttackDice = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("Jet dÃ©jÃ  utilisÃ© ce tour", "error");

    setIsAnimating(true);
    setAttackResult(null);

    setTimeout(() => {
      const statIndex = Math.floor(Math.random() * STATISTIQUES.length);
      const stat = STATISTIQUES[statIndex];
      const statKey = STAT_MAPPING[stat];

      setTimeout(() => {
        const diceRoll = Math.floor(Math.random() * 10);
        const baseStat = me.stats?.[statKey] || 0;
        const effectsBonus = (me.effects || []).filter(e => e.stat === statKey).reduce((sum, e) => sum + e.delta, 0);
        const total = diceRoll + baseStat + effectsBonus;

        setAttackResult({ stat, statKey, diceRoll, baseStat, effectsBonus, total });
        updateMe({ usedAttackDice: true });
        setIsAnimating(false);
      }, 400);
    }, 400);
  };

  const startCombat = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("Jet dÃ©jÃ  utilisÃ© ce tour", "error");
    setCombatMode('select_opponent');
  };

  const selectOpponent = (oppUid) => {
    setSelectedOpponent(oppUid);
    if (me.character?.chooseStat) {
      setCombatMode('choose_stat');
    } else {
      executeCombat(oppUid, null);
    }
  };

  const executeCombat = (oppUid, forcedStatKey) => {
    setCombatMode('rolling');
    setIsAnimating(true);

    setTimeout(() => {
      const opponent = players.find(p => p.oderId === oppUid);
      if (!opponent) { setCombatMode(null); return; }

      // Determine stat
      let statKey, statName;
      if (forcedStatKey) {
        statKey = forcedStatKey;
        statName = STAT_NAMES[statKey];
      } else {
        const statIndex = Math.floor(Math.random() * STATISTIQUES.length);
        statName = STATISTIQUES[statIndex];
        statKey = STAT_MAPPING[statName];
      }

      // Roll dice
      const attackerDice = Math.floor(Math.random() * 10);
      const defenderDice = Math.floor(Math.random() * 10);

      // Calculate totals
      const attackerBase = me.stats?.[statKey] || 0;
      const attackerEffects = (me.effects || []).filter(e => e.stat === statKey).reduce((sum, e) => sum + e.delta, 0);
      const attackerTotal = attackerDice + attackerBase + attackerEffects;

      const defenderBase = opponent.stats?.[statKey] || 0;
      const defenderEffects = (opponent.effects || []).filter(e => e.stat === statKey).reduce((sum, e) => sum + e.delta, 0);
      const defenderTotal = defenderDice + defenderBase + defenderEffects;

      const difference = attackerTotal - defenderTotal;

      let result = {
        statName,
        attacker: { name: me.name, dice: attackerDice, base: attackerBase, effects: attackerEffects, total: attackerTotal },
        defender: { name: opponent.name, dice: defenderDice, base: defenderBase, effects: defenderEffects, total: defenderTotal },
        difference,
        attackerWins: difference > 0
      };

      let myPvChange = 0;
      let oppPvChange = 0;
      let pdvGained = 0;

      if (difference > 0) {
        // Attacker wins
        const damage = Math.abs(difference);
        oppPvChange = -damage;
        result.damage = damage;

        const newOppHP = Math.max(0, opponent.pvCurrent - damage);
        if (newOppHP === 0) {
          pdvGained = 1;
          result.defenderDied = true;
          // Cursed kill bonus for HÃ©rÃ©tique
          if (me.character?.cursedKillBonus && (opponent.effects || []).some(e => e.type === 'CURSE')) {
            pdvGained += me.character.cursedKillBonus;
            result.cursedKillBonus = true;
          }
        }

        // Riposte from Homme-bÃªte
        if (opponent.character?.counterDamage && !me.character?.noCounterDamage) {
          myPvChange -= opponent.character.counterDamage;
          result.riposteDamage = opponent.character.counterDamage;
        }

        // Heal on win for Homme-bÃªte
        if (me.character?.healOnWin) {
          const healAmount = Math.min(me.character.healOnWin, me.character.pvMax - me.pvCurrent);
          if (healAmount > 0) {
            myPvChange += healAmount;
            result.healed = healAmount;
          }
        }

        result.pdvGained = pdvGained;
      } else if (difference < 0) {
        // Defender wins - counter damage unless Chasseur
        if (!me.character?.noCounterDamage) {
          myPvChange = -1;
          result.counterDamage = 1;
        } else {
          result.noDamage = true;
        }
      } else {
        result.draw = true;
      }

      // Apply changes
      if (oppPvChange !== 0) {
        updatePlayer(oppUid, { pvCurrent: Math.max(0, opponent.pvCurrent + oppPvChange) });
      }

      const updates = { usedAttackDice: true };
      if (myPvChange !== 0) updates.pvCurrent = Math.max(0, me.pvCurrent + myPvChange);
      if (pdvGained > 0) updates.pdv = (me.pdv || 0) + pdvGained;
      updateMe(updates);

      setCombatResult(result);
      setCombatMode('result');
      setIsAnimating(false);
    }, 800);
  };

  const resetCombat = () => {
    setCombatMode(null);
    setSelectedOpponent(null);
    setCombatResult(null);
    setChosenStat(null);
  };

  const opponents = players.filter(p => p.oderId !== user.uid);

  // Combat: Select opponent
  if (combatMode === 'select_opponent') {
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ SÃ©lection d'adversaire"),
      React.createElement("div", { className: "space-y-3" },
        opponents.map(opp => React.createElement("button", { key: opp.oderId, onClick: () => selectOpponent(opp.oderId), className: "w-full p-4 bg-red-50 border-2 border-red-300 rounded-xl hover:bg-red-100 text-left" },
          React.createElement("div", { className: "flex justify-between items-center" },
            React.createElement("div", null,
              React.createElement("div", { className: "font-bold text-gray-800" }, opp.name),
              React.createElement("div", { className: "text-sm text-gray-600" }, opp.character?.name)
            ),
            React.createElement("div", { className: "text-right" },
              React.createElement("div", { className: "text-2xl font-bold text-red-600" }, opp.pvCurrent + "/" + opp.character?.pvMax),
              React.createElement("div", { className: "text-xs text-gray-500" }, "PV")
            )
          )
        ))
      ),
      React.createElement("button", { onClick: resetCombat, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold" }, "Annuler")
    );
  }

  // Combat: Choose stat (HÃ©rÃ©tique)
  if (combatMode === 'choose_stat') {
    const opponent = players.find(p => p.oderId === selectedOpponent);
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ Choix de statistique"),
      React.createElement("p", { className: "text-center text-gray-600" }, "Adversaire: ", React.createElement("strong", null, opponent?.name)),
      React.createElement("p", { className: "text-center text-sm text-purple-600 font-semibold" }, "Pouvoir HÃ©rÃ©tique: choisissez la stat !"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        Object.entries(STAT_NAMES).map(([key, name]) => React.createElement("button", { key: key, onClick: () => executeCombat(selectedOpponent, key), className: "py-4 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700" }, name))
      ),
      React.createElement("button", { onClick: resetCombat, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold" }, "Annuler")
    );
  }

  // Combat: Rolling
  if (combatMode === 'rolling') {
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ Combat en cours..."),
      React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-red-600 to-red-800 rounded-xl p-6 flex items-center justify-center animate-pulse" },
        React.createElement("p", { className: "text-white text-xl" }, "ðŸŽ² Lancement des dÃ©s...")
      )
    );
  }

  // Combat: Result
  if (combatMode === 'result' && combatResult) {
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ RÃ©sultat du combat"),
      React.createElement("div", { className: "text-center mb-4" },
        React.createElement("div", { className: "text-xl font-bold text-purple-600 mb-2" }, combatResult.statName),
        React.createElement("div", { className: "text-4xl font-bold" }, combatResult.attacker.total + " vs " + combatResult.defender.total)
      ),
      React.createElement("div", { className: "grid grid-cols-2 gap-4" },
        // Attacker card
        React.createElement("div", { className: "bg-blue-50 border-2 border-blue-300 rounded-xl p-4" },
          React.createElement("div", { className: "text-center mb-3" },
            React.createElement("div", { className: "font-bold text-gray-700" }, "Attaquant"),
            React.createElement("div", { className: "text-sm text-gray-600" }, combatResult.attacker.name)
          ),
          React.createElement("div", { className: "space-y-1 text-sm" },
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "DÃ©:"), React.createElement("span", { className: "font-bold" }, combatResult.attacker.dice)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Base:"), React.createElement("span", { className: "font-bold" }, combatResult.attacker.base >= 0 ? "+" + combatResult.attacker.base : combatResult.attacker.base)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Ã‰tats:"), React.createElement("span", { className: "font-bold" }, combatResult.attacker.effects >= 0 ? "+" + combatResult.attacker.effects : combatResult.attacker.effects)),
            React.createElement("div", { className: "border-t pt-1 mt-1 flex justify-between" }, React.createElement("span", { className: "font-bold" }, "Total:"), React.createElement("span", { className: "font-bold text-xl text-blue-600" }, combatResult.attacker.total))
          )
        ),
        // Defender card
        React.createElement("div", { className: "bg-red-50 border-2 border-red-300 rounded-xl p-4" },
          React.createElement("div", { className: "text-center mb-3" },
            React.createElement("div", { className: "font-bold text-gray-700" }, "DÃ©fenseur"),
            React.createElement("div", { className: "text-sm text-gray-600" }, combatResult.defender.name)
          ),
          React.createElement("div", { className: "space-y-1 text-sm" },
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "DÃ©:"), React.createElement("span", { className: "font-bold" }, combatResult.defender.dice)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Base:"), React.createElement("span", { className: "font-bold" }, combatResult.defender.base >= 0 ? "+" + combatResult.defender.base : combatResult.defender.base)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Ã‰tats:"), React.createElement("span", { className: "font-bold" }, combatResult.defender.effects >= 0 ? "+" + combatResult.defender.effects : combatResult.defender.effects)),
            React.createElement("div", { className: "border-t pt-1 mt-1 flex justify-between" }, React.createElement("span", { className: "font-bold" }, "Total:"), React.createElement("span", { className: "font-bold text-xl text-red-600" }, combatResult.defender.total))
          )
        )
      ),
      // Result banner
      React.createElement("div", { className: "rounded-xl p-6 text-white text-center " + (combatResult.draw ? 'bg-gradient-to-r from-gray-600 to-gray-800' : combatResult.attackerWins ? 'bg-gradient-to-r from-green-600 to-green-800' : 'bg-gradient-to-r from-orange-600 to-orange-800') },
        combatResult.draw ? React.createElement("div", null,
          React.createElement("div", { className: "text-3xl font-bold mb-2" }, "ðŸ¤ Ã‰GALITÃ‰"),
          React.createElement("div", { className: "text-xl" }, "Aucun dÃ©gÃ¢t")
        ) : combatResult.attackerWins ? React.createElement("div", null,
          React.createElement("div", { className: "text-3xl font-bold mb-2" }, "âœ… VICTOIRE"),
          React.createElement("div", { className: "text-xl mb-2" }, combatResult.attacker.name + " inflige " + combatResult.damage + " dÃ©gÃ¢ts"),
          combatResult.defenderDied && React.createElement("div", { className: "text-lg mt-2" }, "ðŸ’€ " + combatResult.defender.name + " est mort ! +" + combatResult.pdvGained + " PDV"),
          combatResult.healed && React.createElement("div", { className: "text-sm mt-1" }, "â¤ï¸ Soin: +" + combatResult.healed + " PV"),
          combatResult.riposteDamage && React.createElement("div", { className: "text-sm mt-1 bg-white bg-opacity-20 rounded p-2" }, "âš ï¸ Riposte: -" + combatResult.riposteDamage + " PV")
        ) : React.createElement("div", null,
          React.createElement("div", { className: "text-3xl font-bold mb-2" }, "ðŸ›¡ï¸ Ã‰CHEC"),
          combatResult.noDamage ? React.createElement("div", { className: "text-xl" }, combatResult.attacker.name + " ne prend pas de dÃ©gÃ¢ts (Pouvoir)") : React.createElement("div", { className: "text-xl" }, combatResult.attacker.name + " prend " + combatResult.counterDamage + " dÃ©gÃ¢t")
        )
      ),
      React.createElement("button", { onClick: resetCombat, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700" }, "Fermer")
    );
  }

  // Default: Dice view
  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "LancÃ©s de DÃ©s"),
    // Movement dice
    React.createElement("div", { className: "bg-white border-2 border-gray-300 rounded-xl p-6" },
      React.createElement("h4", { className: "text-lg font-bold text-gray-800 mb-4 text-center" }, "ðŸŽ² DÃ© de DÃ©placement"),
      React.createElement("div", { className: "min-h-[150px] bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 flex flex-col items-center justify-center mb-4 " + (isAnimating ? 'animate-pulse' : '') },
        moveResult !== null ? React.createElement(React.Fragment, null,
          React.createElement("div", { className: "text-7xl font-bold text-white mb-2" }, moveResult),
          moveResult === 0 && React.createElement("div", { className: "text-xl font-bold text-yellow-300" }, "âœ¨ SuccÃ¨s Critique !")
        ) : React.createElement("p", { className: "text-gray-300 text-center italic" }, "Lancer le dÃ©")
      ),
      React.createElement("button", { onClick: rollMoveDice, disabled: isAnimating, className: "w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 disabled:opacity-50" }, "ðŸŽ² Lancer (0-9)")
    ),
    // Attack dice
    React.createElement("div", { className: "bg-white border-2 border-gray-300 rounded-xl p-6" },
      React.createElement("h4", { className: "text-lg font-bold text-gray-800 mb-4 text-center" }, "âš”ï¸ DÃ© d'Attaque"),
      me.usedAttackDice && React.createElement("div", { className: "mb-4 p-3 bg-yellow-50 border-2 border-yellow-300 rounded-lg text-center" },
        React.createElement("p", { className: "text-sm font-semibold text-yellow-800" }, "âš ï¸ Jet dÃ©jÃ  utilisÃ© ce tour")
      ),
      React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-red-600 to-red-800 rounded-xl p-6 flex flex-col items-center justify-center mb-4 " + (isAnimating ? 'animate-pulse' : '') },
        attackResult ? React.createElement("div", { className: "w-full" },
          React.createElement("div", { className: "text-center mb-4" },
            React.createElement("div", { className: "text-2xl font-bold text-yellow-300 mb-2" }, attackResult.stat),
            React.createElement("div", { className: "text-6xl font-bold text-white mb-4" }, attackResult.total)
          ),
          React.createElement("div", { className: "bg-white bg-opacity-20 rounded-lg p-4 text-white" },
            React.createElement("div", { className: "flex justify-between mb-2" }, React.createElement("span", { className: "text-sm" }, "DÃ©:"), React.createElement("span", { className: "font-bold text-lg" }, attackResult.diceRoll)),
            React.createElement("div", { className: "flex justify-between mb-2" }, React.createElement("span", { className: "text-sm" }, "Base:"), React.createElement("span", { className: "font-bold" }, attackResult.baseStat >= 0 ? "+" + attackResult.baseStat : attackResult.baseStat)),
            React.createElement("div", { className: "flex justify-between mb-2" }, React.createElement("span", { className: "text-sm" }, "Ã‰tats:"), React.createElement("span", { className: "font-bold " + (attackResult.effectsBonus >= 0 ? 'text-green-300' : 'text-red-300') }, attackResult.effectsBonus >= 0 ? "+" + attackResult.effectsBonus : attackResult.effectsBonus))
          )
        ) : React.createElement("p", { className: "text-gray-300 text-center italic" }, "Lancer le dÃ© d'attaque")
      ),
      React.createElement("button", { onClick: rollAttackDice, disabled: isAnimating || !isMyTurn || me.usedAttackDice, className: "w-full py-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 disabled:opacity-50 mb-2" }, "âš”ï¸ Lancer Attaque"),
      React.createElement("button", { onClick: startCombat, disabled: isAnimating || !isMyTurn || me.usedAttackDice || opponents.length === 0, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 disabled:opacity-50" }, "âš”ï¸ Combat contre un joueur")
    ),
    // Character bonuses reminder
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("p", { className: "text-xs font-bold text-gray-700 mb-2" }, "ðŸ’¡ Bonus de " + me.character?.name + ":"),
      React.createElement("ul", { className: "text-xs text-gray-600 space-y-1" },
        me.character?.skills.map((skill, i) => React.createElement("li", { key: i }, "â€¢ " + skill))
      )
    )
  );
}

// ============================================================================
// PERSONNAGE TAB
// ============================================================================
function PersonnageTab({ me, updateMe, notify, gameId, user }) {
  const [showAddEffect, setShowAddEffect] = useState(false);
  const [newEffect, setNewEffect] = useState({ type: 'BLESS', stat: 'endurance', name: '' });

  const adjustPV = (delta) => {
    const newPV = Math.max(0, Math.min(me.character.pvMax, me.pvCurrent + delta));
    updateMe({ pvCurrent: newPV });
  };

  const resetPV = () => updateMe({ pvCurrent: me.character.pvMax });

  const adjustResource = (resource, delta) => {
    updateMe({ [resource]: Math.max(0, (me[resource] || 0) + delta) });
  };

  const addEffect = () => {
    if (!newEffect.name.trim()) return notify("Donnez un nom Ã  l'Ã©tat", "error");
    const effect = {
      id: "effect_" + Date.now(),
      type: newEffect.type,
      stat: newEffect.stat,
      delta: newEffect.type === 'BLESS' ? 2 : -2,
      name: newEffect.name.trim()
    };
    updateMe({ effects: [...(me.effects || []), effect] });
    setNewEffect({ type: 'BLESS', stat: 'endurance', name: '' });
    setShowAddEffect(false);
    notify("Ã‰tat ajoutÃ© !", "success");
  };

  const removeEffect = (effectId) => {
    if (confirm("Supprimer cet Ã©tat ?")) {
      updateMe({ effects: (me.effects || []).filter(e => e.id !== effectId) });
    }
  };

  const passageDepart = () => {
    const updates = {};
    const goldBonus = me.character?.passGoldBonus || 0;
    if (goldBonus > 0) updates.or = (me.or || 0) + goldBonus;
    updates.blessAvailable = me.character?.canBless || false;
    updates.curseAvailable = me.character?.canCurse || false;
    updates.tourPlateau = (me.tourPlateau || 0) + 1;
    updateMe(updates);
    notify("Passage DÃ©part ! " + (goldBonus > 0 ? "+" + goldBonus + " Or, " : "") + "Pouvoirs rechargÃ©s", "success");
  };

  const toggleSkill = (skillId) => {
    const newSkills = (me.skills || []).map(s => s.id === skillId ? { ...s, status: s.status === 'AVAILABLE' ? 'UNAVAILABLE' : 'AVAILABLE' } : s);
    updateMe({ skills: newSkills });
  };

  return React.createElement("div", { className: "space-y-6" },
    // Header
    React.createElement("div", { className: "text-center" },
      React.createElement("div", { className: "text-5xl mb-2" }, me.character?.emoji),
      React.createElement("h2", { className: "text-3xl font-bold text-gray-800" }, me.character?.name),
      React.createElement("p", { className: "text-gray-600" }, me.name)
    ),
    // Passage DÃ©part button
    React.createElement("button", { onClick: passageDepart, className: "w-full py-3 bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-xl font-bold hover:from-teal-600 hover:to-blue-600" }, "ðŸ Passage par la case DÃ©part"),
    // PV Section
    React.createElement("div", { className: "bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl p-6 text-white" },
      React.createElement("div", { className: "text-center mb-4" },
        React.createElement("div", { className: "text-sm font-semibold mb-2" }, "Points de Vie"),
        React.createElement("div", { className: "text-5xl font-bold" }, me.pvCurrent + " / " + me.character?.pvMax)
      ),
      React.createElement("div", { className: "grid grid-cols-3 gap-2" },
        React.createElement("button", { onClick: () => adjustPV(-1), className: "bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg py-3 font-semibold text-lg" }, "-1"),
        React.createElement("button", { onClick: resetPV, className: "bg-white text-red-600 rounded-lg py-3 font-semibold text-sm" }, "Reset"),
        React.createElement("button", { onClick: () => adjustPV(1), className: "bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg py-3 font-semibold text-lg" }, "+1")
      )
    ),
    // Resources Section
    React.createElement("div", { className: "bg-gradient-to-r from-amber-500 to-yellow-500 rounded-2xl p-6 text-white" },
      React.createElement("h3", { className: "text-xl font-bold mb-4 text-center" }, "Ressources"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        [{ key: 'or', emoji: 'ðŸª™', name: 'Or' }, { key: 'cuivre', emoji: 'ðŸŒ³', name: 'Cuivre' }, { key: 'argent', emoji: 'ðŸœï¸', name: 'Argent' }, { key: 'obsidienne', emoji: 'â›°ï¸', name: 'Obsidienne' }].map(r =>
          React.createElement("div", { key: r.key, className: "bg-white bg-opacity-20 rounded-lg p-3" },
            React.createElement("div", { className: "text-sm font-semibold mb-2 text-center" }, r.emoji + " " + r.name),
            React.createElement("div", { className: "text-3xl font-bold text-center mb-2" }, me[r.key] || 0),
            React.createElement("div", { className: "flex gap-2" },
              React.createElement("button", { onClick: () => adjustResource(r.key, -1), className: "flex-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded py-2 font-semibold" }, "-1"),
              React.createElement("button", { onClick: () => adjustResource(r.key, 1), className: "flex-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded py-2 font-semibold" }, "+1")
            )
          )
        )
      ),
      React.createElement("div", { className: "mt-4 bg-white bg-opacity-20 rounded-lg p-3 text-center" },
        React.createElement("div", { className: "text-sm font-semibold mb-1" }, "ðŸ† Points de Victoire"),
        React.createElement("div", { className: "text-4xl font-bold" }, me.pdv || 0)
      )
    ),
    // Stats Section
    React.createElement("div", { className: "bg-blue-50 rounded-2xl p-6" },
      React.createElement("h3", { className: "text-xl font-bold text-gray-800 mb-4" }, "Statistiques"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        Object.entries(STAT_NAMES).map(([key, name]) => {
          const baseStat = me.stats?.[key] || 0;
          const effectsBonus = (me.effects || []).filter(e => e.stat === key).reduce((sum, e) => sum + e.delta, 0);
          const total = baseStat + effectsBonus;
          return React.createElement("div", { key, className: "bg-white rounded-lg p-3" },
            React.createElement("div", { className: "text-sm text-gray-600 mb-1" }, name),
            React.createElement("div", { className: "flex items-center justify-between" },
              React.createElement("span", { className: "text-lg font-bold text-gray-700" }, baseStat >= 0 ? "+" + baseStat : baseStat),
              effectsBonus !== 0 && React.createElement("span", { className: "text-sm " + (effectsBonus > 0 ? 'text-green-600' : 'text-red-600') }, effectsBonus > 0 ? "+" + effectsBonus : effectsBonus),
              React.createElement("span", { className: "text-lg font-bold " + (total >= 0 ? 'text-green-600' : 'text-red-600') }, "= " + (total >= 0 ? "+" + total : total))
            )
          );
        })
      )
    ),
    // Effects Section
    React.createElement("div", null,
      React.createElement("div", { className: "flex items-center justify-between mb-3" },
        React.createElement("h3", { className: "text-xl font-bold text-gray-800" }, "Ã‰tats actifs (" + (me.effects || []).length + ")"),
        React.createElement("button", { onClick: () => setShowAddEffect(!showAddEffect), className: "px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 text-sm" }, showAddEffect ? 'âœ• Annuler' : '+ Ajouter')
      ),
      showAddEffect && React.createElement("div", { className: "bg-gray-50 rounded-xl p-4 mb-4" },
        React.createElement("div", { className: "space-y-3" },
          React.createElement("div", { className: "grid grid-cols-2 gap-2" },
            React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'BLESS' }), className: "py-2 rounded-lg font-semibold " + (newEffect.type === 'BLESS' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700') }, "âœ¨ BÃ©nÃ©diction (+2)"),
            React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'CURSE' }), className: "py-2 rounded-lg font-semibold " + (newEffect.type === 'CURSE' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700') }, "ðŸ’€ MalÃ©diction (-2)")
          ),
          React.createElement("select", { value: newEffect.stat, onChange: (e) => setNewEffect({ ...newEffect, stat: e.target.value }), className: "w-full px-3 py-2 border-2 border-gray-300 rounded-lg" },
            Object.entries(STAT_NAMES).map(([key, name]) => React.createElement("option", { key, value: key }, name))
          ),
          React.createElement("input", { type: "text", value: newEffect.name, onChange: (e) => setNewEffect({ ...newEffect, name: e.target.value }), placeholder: "Nom de l'Ã©tat", className: "w-full px-3 py-2 border-2 border-gray-300 rounded-lg" }),
          React.createElement("button", { onClick: addEffect, className: "w-full py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700" }, "Ajouter l'Ã©tat")
        )
      ),
      (me.effects || []).length === 0 ? React.createElement("p", { className: "text-gray-500 text-center py-4" }, "Aucun Ã©tat actif") :
      React.createElement("div", { className: "space-y-2" },
        (me.effects || []).map(effect => React.createElement("div", { key: effect.id, className: "rounded-lg p-3 flex items-center justify-between " + (effect.type === 'BLESS' ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200') },
          React.createElement("div", null,
            React.createElement("span", { className: "font-bold text-gray-800" }, (effect.type === 'BLESS' ? 'âœ¨' : 'ðŸ’€') + " " + effect.name),
            React.createElement("p", { className: "text-sm text-gray-600" }, STAT_NAMES[effect.stat] + ": " + (effect.delta > 0 ? "+" + effect.delta : effect.delta))
          ),
          React.createElement("button", { onClick: () => removeEffect(effect.id), className: "px-3 py-1 bg-red-600 text-white rounded-lg text-xs font-semibold hover:bg-red-700" }, "âœ•")
        ))
      )
    ),
    // Skills Section
    React.createElement("div", null,
      React.createElement("h3", { className: "text-xl font-bold text-gray-800 mb-3" }, "CapacitÃ©s"),
      React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
        React.createElement("p", { className: "text-sm text-gray-600 mb-3" }, React.createElement("strong", null, "RÃ´le:"), " " + me.character?.role),
        React.createElement("p", { className: "text-sm text-gray-700 mb-4 italic" }, me.character?.concept),
        React.createElement("div", { className: "space-y-2" },
          (me.skills || []).map(skill => React.createElement("div", { key: skill.id, className: "bg-white rounded-lg p-3 flex items-center justify-between" },
            React.createElement("p", { className: "text-sm text-gray-700 flex-1" }, skill.description),
            React.createElement("button", { onClick: () => toggleSkill(skill.id), className: "ml-3 px-3 py-1 rounded-lg font-semibold text-xs " + (skill.status === 'AVAILABLE' ? 'bg-green-600 text-white' : 'bg-gray-400 text-white') }, skill.status === 'AVAILABLE' ? 'Dispo' : 'Indispo')
          ))
        ),
        React.createElement("p", { className: "text-xs text-gray-600 mt-4 italic" }, React.createElement("strong", null, "Style:"), " " + me.character?.style)
      )
    ),
    // Quests Section
    React.createElement("div", null,
      React.createElement("h3", { className: "text-xl font-bold text-gray-800 mb-3" }, "Mes quÃªtes (" + (me.quests || []).length + "/2)"),
      (me.quests || []).length === 0 ? React.createElement("p", { className: "text-gray-500 text-center py-4" }, "Aucune quÃªte") :
      React.createElement("div", { className: "space-y-2" },
        (me.quests || []).map(quest => React.createElement("div", { key: quest.id, className: "rounded-lg p-3 bg-gray-50 border-2 border-gray-300" },
          React.createElement("p", { className: "text-sm text-gray-700" }, quest.text)
        ))
      )
    )
  );
}

// ============================================================================
// RENDER
// ============================================================================
const root = createRoot(document.getElementById('root'));
root.render(React.createElement(App));
  </script>
</body>
</html>
