<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#7c3aed">
  <title>QuÃªtes d'Anomalies - Multijoueur</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script>
const { useState, useEffect, useMemo } = React;
const { createRoot } = ReactDOM;

// ============================================================================
// FIREBASE CONFIG - REMPLACEZ PAR VOS PROPRES VALEURS
// ============================================================================
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "VOTRE_PROJECT.firebaseapp.com",
  databaseURL: "https://VOTRE_PROJECT-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "VOTRE_PROJECT",
  storageBucket: "VOTRE_PROJECT.appspot.com",
  messagingSenderId: "VOTRE_SENDER_ID",
  appId: "VOTRE_APP_ID"
};

let auth, database;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  database = firebase.database();
  console.log("Firebase OK");
} catch (e) { console.warn("Firebase non configurÃ©", e); }

// ============================================================================
// CONSTANTES
// ============================================================================
const STAT_NAMES = { endurance: "Endurance", force: "Force", vitesse: "Vitesse", perception: "Perception", sagesse: "Sagesse", intelligence: "Intelligence" };
const STAT_MAPPING = { "Endurance": "endurance", "Force": "force", "AgilitÃ©": "vitesse", "Perception": "perception", "Sagesse": "sagesse", "Intelligence": "intelligence" };
const STATISTIQUES = ["Endurance", "Force", "Vitesse", "Perception", "Sagesse", "Intelligence"];

const PDV_SOURCES = {
  KILL: { label: "Ã‰limination", emoji: "ðŸ’€", color: "text-red-600" },
  QUEST_COMBAT: { label: "QuÃªte combat", emoji: "âš”ï¸", color: "text-orange-600" },
  QUEST_EXCHANGE: { label: "QuÃªte Ã©change", emoji: "ðŸ”„", color: "text-blue-600" },
  TERRITORY: { label: "Territoire", emoji: "ðŸ°", color: "text-green-600" },
  BOSS: { label: "Boss", emoji: "ðŸ‰", color: "text-yellow-600" },
  START: { label: "Passage DÃ©part", emoji: "ðŸ", color: "text-teal-600" },
  BONUS: { label: "Bonus", emoji: "âœ¨", color: "text-pink-600" }
};

const BIOMES = {
  FORET: { name: "ForÃªt CuivrÃ©e", resource: "cuivre", emoji: "ðŸŒ³" },
  DESERT: { name: "DÃ©sert ArgentÃ©", resource: "argent", emoji: "ðŸœï¸" },
  MONTAGNE: { name: "Montagne Obsidienne", resource: "obsidienne", emoji: "â›°ï¸" }
};

const BOSSES = {
  FORET: { name: "Gardien de la ForÃªt", difficulty: 6, pdv: 3, emoji: "ðŸŒ²" },
  DESERT: { name: "Titan du DÃ©sert", difficulty: 8, pdv: 4, emoji: "ðŸœï¸" },
  MONTAGNE: { name: "Seigneur de la Montagne", difficulty: 10, pdv: 5, emoji: "â›°ï¸" }
};

const OBJECTIVES = [
  { id: 'OBJ_OR', resource: 'or', amount: 12, pdv: 3, label: '12 Or', emoji: 'ðŸ’°' },
  { id: 'OBJ_CUIVRE', resource: 'cuivre', amount: 9, pdv: 3, label: '9 Cuivre', emoji: 'ðŸ¥‰' },
  { id: 'OBJ_ARGENT', resource: 'argent', amount: 6, pdv: 3, label: '6 Argent', emoji: 'ðŸ¥ˆ' },
  { id: 'OBJ_OBSIDIENNE', resource: 'obsidienne', amount: 3, pdv: 3, label: '3 Obsidienne', emoji: 'â¬›' }
];

const EXCHANGE_RATES = { cuivre: { toOr: 2 }, argent: { toOr: 3 }, obsidienne: { toOr: 4 } };

const RESOURCE_MAPPING = {
  "PiÃ¨ce d'Or": { key: "or" }, "Ecorce CuivrÃ©e": { key: "cuivre" },
  "Sable ArgentÃ©": { key: "argent" }, "Roche Obsidienne": { key: "obsidienne" }
};

const BASE_GOLD = 10;

// ============================================================================
// RULES ENGINE
// ============================================================================
const rulesEngine = {
  getAttackBonus: (player, ctx) => {
    let bonus = 0;
    if (player.characterKey === 'CHASSEUR' && (ctx.type === 'QUEST' || ctx.isRanged)) bonus += 1;
    if (player.characterKey === 'CHEVALIER' && ctx.type === 'TERRITORY' && ctx.isNeutral) bonus += 1;
    return { bonus };
  },
  getCounterDamage: (defender) => defender.characterKey === 'HOMME_BETE' ? 1 : 0,
  avoidsCounter: (attacker, ctx) => attacker.characterKey === 'CHASSEUR' && ctx.isRanged,
  getHealOnSuccess: (attacker) => attacker.characterKey === 'HOMME_BETE' ? 2 : 0,
  getKillBonus: (attacker, defender) => (attacker.characterKey === 'HERETIQUE' && defender.effects?.some(e => e.type === 'CURSE')) ? 1 : 0,
  getQuestBonus: (player) => player.characterKey === 'VICAIRE' ? 1 : 0,
  getStartGold: (charKey) => charKey === 'MARCHAND' ? BASE_GOLD + 4 : BASE_GOLD,
  getPassBonus: (player) => player.characterKey === 'MARCHAND' ? { or: 4 } : {},
  canSacrificePv: (player) => player.characterKey === 'HOMME_BETE',
  canReroll: (player) => player.characterKey === 'VICAIRE',
  canBless: (player) => player.characterKey === 'VICAIRE',
  canCurse: (player) => player.characterKey === 'HERETIQUE',
  canChooseStat: (player) => player.characterKey === 'HERETIQUE'
};

// ============================================================================
// PERSONNAGES
// ============================================================================
const CHARACTERS = {
  CHASSEUR: { key: "CHASSEUR", name: "Le Chasseur", emoji: "ðŸ¹", pvMax: 6, role: "Harceleur â€“ Distance", skills: ["Attaque Ã  distance", "Pas de riposte Ã  distance", "+1 attaques Ã  distance"] },
  MARCHAND: { key: "MARCHAND", name: "Le Marchand", emoji: "ðŸª™", pvMax: 6, role: "Ã‰conomie â€“ Monopoles", skills: ["+4 Or au dÃ©part et passage DÃ©part", "AchÃ¨te territoires avec or", "+1 PDV/monopole fin"] },
  HOMME_BETE: { key: "HOMME_BETE", name: "L'Homme-bÃªte", emoji: "ðŸº", pvMax: 10, role: "Berserker â€“ Tank", skills: ["Sacrifie PV â†’ bonus jet", "+2 PV sur victoire", "Riposte 1 dÃ©gÃ¢t"] },
  CHEVALIER: { key: "CHEVALIER", name: "Le Chevalier", emoji: "âš”ï¸", pvMax: 10, role: "ConquÃªte â€“ Territoires", skills: ["Capture territoire adverse", "+1 vs territoires neutres", "+1 PDV/biome fin"] },
  VICAIRE: { key: "VICAIRE", name: "Le Vicaire", emoji: "âœ¨", pvMax: 8, role: "Support â€“ Optimisation", skills: ["Relance stat (1 ressource)", "BÃ©nÃ©diction +2 (2 ress.)", "+1 PDV/quÃªte"] },
  HERETIQUE: { key: "HERETIQUE", name: "L'HÃ©rÃ©tique", emoji: "ðŸ’€", pvMax: 8, role: "Sabotage â€“ Assassinat", skills: ["Choisit stat vs joueur", "MalÃ©diction -2 (3 PV)", "+1 PDV kill maudit"] }
};

// ============================================================================
// CARTES
// ============================================================================
const ANOMALIES = [
  "Soignez 2 [Point de vie].", "Soignez 4 [Point de vie].", "Soignez 6 [Point de vie].",
  "Perdez 2 [Point de vie].", "Perdez 4 [Point de vie].", "Perdez 6 [Point de vie].",
  "Obtenez [BÃ©nÃ©diction].", "Obtenez [BÃ©nÃ©diction].", "Obtenez [MalÃ©diction].", "Obtenez [MalÃ©diction].",
  "Gagnez 8 [PiÃ¨ce d'Or].", "Gagnez 4 [PiÃ¨ce d'Or].",
  "Gagnez 6 [Ecorce CuivrÃ©e].", "Gagnez 3 [Ecorce CuivrÃ©e].",
  "Gagnez 4 [Sable ArgentÃ©].", "Gagnez 2 [Sable ArgentÃ©].",
  "Gagnez 2 [Roche Obsidienne].", "Gagnez 1 [Roche Obsidienne].",
  "Perdez 4 [PiÃ¨ce d'Or].", "Perdez 3 [Ecorce CuivrÃ©e].", "Perdez 2 [Sable ArgentÃ©].",
  "Recharger votre pouvoir."
];

const QUETES = [
  "Dans le territoire [ForÃªt aux arbres CuivrÃ©s], Ã©liminer la crÃ©ature de difficultÃ© 6 pour gagner 3 [Point de victoire].",
  "Dans le territoire [ForÃªt aux arbres CuivrÃ©s], Ã©liminer la crÃ©ature de difficultÃ© 8 pour gagner 4 [Point de victoire].",
  "Dans le territoire [DÃ©sert aux sables ArgentÃ©s], Ã©liminer la crÃ©ature de difficultÃ© 6 pour gagner 3 [Point de victoire].",
  "Dans le territoire [DÃ©sert aux sables ArgentÃ©s], Ã©liminer la crÃ©ature de difficultÃ© 8 pour gagner 4 [Point de victoire].",
  "Dans le territoire [Montagne aux roches Obsidiennes], Ã©liminer la crÃ©ature de difficultÃ© 6 pour gagner 3 [Point de victoire].",
  "Dans le territoire [Montagne aux roches Obsidiennes], Ã©liminer la crÃ©ature de difficultÃ© 10 pour gagner 5 [Point de victoire].",
  "Echanger 8 [PiÃ¨ce d'Or] contre 2 [Point de victoire].",
  "Echanger 4 [PiÃ¨ce d'Or] contre 1 [Point de victoire].",
  "Echanger 6 [Ecorce CuivrÃ©e] contre 2 [Point de victoire].",
  "Echanger 3 [Ecorce CuivrÃ©e] contre 1 [Point de victoire].",
  "Echanger 4 [Sable ArgentÃ©] contre 2 [Point de victoire].",
  "Echanger 2 [Sable ArgentÃ©] contre 1 [Point de victoire].",
  "Echanger 2 [Roche Obsidienne] contre 2 [Point de victoire].",
  "Echanger 1 [Roche Obsidienne] contre 1 [Point de victoire]."
];

// ============================================================================
// UTILITAIRES
// ============================================================================
const genCode = () => { const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let r = ""; for (let i = 0; i < 6; i++) r += c[Math.floor(Math.random() * c.length)]; return r; };

const getRandomAvailableResource = (player) => {
  const a = [];
  if (player.or > 0) a.push('or');
  if (player.cuivre > 0) a.push('cuivre');
  if (player.argent > 0) a.push('argent');
  if (player.obsidienne > 0) a.push('obsidienne');
  return a.length ? a[Math.floor(Math.random() * a.length)] : null;
};

function parseAnomaly(text) {
  let m;
  if (m = text.match(/Soignez (\d+)/)) return { type: 'heal', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Point de vie\]/)) return { type: 'damage', amount: +m[1] };
  if (text.includes('[BÃ©nÃ©diction]')) {
    const stats = Object.keys(STAT_NAMES);
    return { type: 'bless', stat: stats[Math.floor(Math.random() * stats.length)] };
  }
  if (text.includes('[MalÃ©diction]')) {
    const stats = Object.keys(STAT_NAMES);
    return { type: 'curse', stat: stats[Math.floor(Math.random() * stats.length)] };
  }
  if (m = text.match(/Gagnez (\d+) \[PiÃ¨ce/)) return { type: 'gain', resource: 'or', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Ecorce/)) return { type: 'gain', resource: 'cuivre', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Sable/)) return { type: 'gain', resource: 'argent', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Roche/)) return { type: 'gain', resource: 'obsidienne', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[PiÃ¨ce/)) return { type: 'lose', resource: 'or', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Ecorce/)) return { type: 'lose', resource: 'cuivre', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Sable/)) return { type: 'lose', resource: 'argent', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Roche/)) return { type: 'lose', resource: 'obsidienne', amount: +m[1] };
  if (text.includes('Recharger')) return { type: 'recharge' };
  return { type: 'other' };
}

function parseQuest(text) {
  const pdvMatch = text.match(/(\d+) \[Point de victoire\]/);
  const pdv = pdvMatch ? +pdvMatch[1] : 0;
  const exchMatch = text.match(/Echanger (\d+) \[(.+?)\] contre/);
  if (exchMatch) {
    const resInfo = RESOURCE_MAPPING[exchMatch[2]];
    return { pdv, isExchange: true, isCombat: false, resourceKey: resInfo?.key, resourceAmount: +exchMatch[1] };
  }
  const combatMatch = text.match(/difficultÃ© (\d+) pour gagner/);
  if (combatMatch) {
    const statKeys = Object.keys(STAT_NAMES);
    return { pdv, isExchange: false, isCombat: true, difficulty: +combatMatch[1], stat: statKeys[Math.floor(Math.random() * statKeys.length)] };
  }
  return { pdv, isExchange: false, isCombat: false };
}

function countTerritoriesByBiome(territories) {
  const c = { FORET: 0, DESERT: 0, MONTAGNE: 0 };
  (territories || []).forEach(t => { if (c[t.biome] !== undefined) c[t.biome]++; });
  return c;
}

// ============================================================================
// APP PRINCIPAL
// ============================================================================
function App() {
  const [screen, setScreen] = useState("menu");
  const [user, setUser] = useState(null);
  const [gameId, setGameId] = useState(null);
  const [game, setGame] = useState(null);
  const [playerName, setPlayerName] = useState("");
  const [joinCode, setJoinCode] = useState("");
  const [notif, setNotif] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!auth) { setLoading(false); setUser({ uid: "local_" + Date.now() }); return; }
    const unsub = auth.onAuthStateChanged((u) => {
      if (u) setUser({ uid: u.uid });
      else auth.signInAnonymously().catch(console.error);
      setLoading(false);
    });
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!database || !gameId) return;
    const ref = database.ref(`games/${gameId}`);
    const cb = ref.on("value", (snap) => {
      const d = snap.val();
      if (d) { setGame(d); if (d.status === "playing" && screen === "lobby") setScreen("game"); }
    });
    return () => ref.off("value", cb);
  }, [gameId, screen]);

  const notify = (msg, type = "info") => { setNotif({ msg, type }); setTimeout(() => setNotif(null), 3000); };

  const createGame = async () => {
    if (!playerName.trim()) return notify("Entrez votre nom", "error");
    const code = genCode();
    const newGame = {
      code, hostId: user.uid, status: "waiting",
      players: { [user.uid]: { oderId: user.uid, name: playerName.trim(), isHost: true, charKey: null, stats: null } },
      turnOrder: [], currentTurn: 0, drawnAnomalies: [], drawnQuetes: [], completedObjectives: [], createdAt: Date.now()
    };
    if (database) await database.ref(`games/${code}`).set(newGame);
    else setGame(newGame);
    setGameId(code);
    setScreen("lobby");
  };

  const joinGame = async () => {
    if (!playerName.trim() || joinCode.length !== 6) return notify("Nom et code requis", "error");
    const code = joinCode.toUpperCase();
    if (database) {
      const snap = await database.ref(`games/${code}`).once("value");
      const g = snap.val();
      if (!g) return notify("Partie introuvable", "error");
      if (g.status !== "waiting") return notify("Partie dÃ©jÃ  commencÃ©e", "error");
      if (Object.keys(g.players).length >= 6) return notify("Partie complÃ¨te", "error");
      await database.ref(`games/${code}/players/${user.uid}`).set({ oderId: user.uid, name: playerName.trim(), isHost: false, charKey: null, stats: null });
    }
    setGameId(code);
    setScreen("lobby");
  };

  if (loading) return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center" },
    React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" })
  );

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100" },
    notif && React.createElement("div", { className: `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 ${notif.type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white` }, notif.msg),
    screen === "menu" && React.createElement(MenuScreen, { playerName, setPlayerName, setScreen }),
    screen === "create" && React.createElement(CreateScreen, { playerName, setPlayerName, createGame, setScreen }),
    screen === "join" && React.createElement(JoinScreen, { playerName, setPlayerName, joinCode, setJoinCode, joinGame, setScreen }),
    screen === "lobby" && React.createElement(LobbyScreen, { gameId, game, user, setScreen, notify }),
    screen === "game" && React.createElement(GameScreen, { gameId, game, user, notify })
  );
}

// ============================================================================
// Ã‰CRANS MENU/CREATE/JOIN
// ============================================================================
function MenuScreen({ playerName, setPlayerName, setScreen }) {
  return React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6" },
    React.createElement("div", { className: "bg-white rounded-2xl shadow-xl p-8 max-w-md w-full" },
      React.createElement("div", { className: "text-center mb-8" },
        React.createElement("div", { className: "text-5xl mb-4" }, "ðŸŽ²"),
        React.createElement("h1", { className: "text-3xl font-bold text-gray-800 mb-2" }, "QuÃªtes d'Anomalies"),
        React.createElement("p", { className: "text-gray-600" }, "Multijoueur temps rÃ©el")
      ),
      React.createElement("div", { className: "mb-6" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Votre pseudo"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg", placeholder: "Entrez votre nom...", value: playerName, onChange: (e) => setPlayerName(e.target.value), maxLength: 16 })
      ),
      React.createElement("div", { className: "space-y-3" },
        React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-blue-700 disabled:opacity-50", onClick: () => setScreen("create"), disabled: !playerName.trim() }, "ðŸŽ® CrÃ©er une partie"),
        React.createElement("button", { className: "w-full py-4 bg-white border-2 border-purple-600 text-purple-600 rounded-xl font-bold text-lg hover:bg-purple-50 disabled:opacity-50", onClick: () => setScreen("join"), disabled: !playerName.trim() }, "ðŸ”— Rejoindre")
      ),
      React.createElement("p", { className: "text-center text-gray-500 text-sm mt-6" }, "2-6 joueurs â€¢ Tour par tour")
    )
  );
}

function CreateScreen({ playerName, setPlayerName, createGame, setScreen }) {
  return React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6" },
    React.createElement("div", { className: "bg-white rounded-2xl shadow-xl p-8 max-w-md w-full" },
      React.createElement("button", { className: "mb-6 text-purple-600 font-semibold", onClick: () => setScreen("menu") }, "â† Retour"),
      React.createElement("h2", { className: "text-2xl font-bold text-center mb-6" }, "ðŸŽ® CrÃ©er une partie"),
      React.createElement("div", { className: "mb-6" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Votre nom"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl", value: playerName, onChange: (e) => setPlayerName(e.target.value) })
      ),
      React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold disabled:opacity-50", onClick: createGame, disabled: !playerName.trim() }, "CrÃ©er")
    )
  );
}

function JoinScreen({ playerName, setPlayerName, joinCode, setJoinCode, joinGame, setScreen }) {
  return React.createElement("div", { className: "min-h-screen flex items-center justify-center p-6" },
    React.createElement("div", { className: "bg-white rounded-2xl shadow-xl p-8 max-w-md w-full" },
      React.createElement("button", { className: "mb-6 text-purple-600 font-semibold", onClick: () => setScreen("menu") }, "â† Retour"),
      React.createElement("h2", { className: "text-2xl font-bold text-center mb-6" }, "ðŸ”— Rejoindre"),
      React.createElement("div", { className: "mb-4" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Votre nom"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl", value: playerName, onChange: (e) => setPlayerName(e.target.value) })
      ),
      React.createElement("div", { className: "mb-6" },
        React.createElement("label", { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Code"),
        React.createElement("input", { type: "text", className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-center text-2xl font-bold tracking-widest uppercase", placeholder: "ABC123", value: joinCode, onChange: (e) => setJoinCode(e.target.value.toUpperCase()), maxLength: 6 })
      ),
      React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold disabled:opacity-50", onClick: joinGame, disabled: !playerName.trim() || joinCode.length !== 6 }, "Rejoindre")
    )
  );
}


// ============================================================================
// Ã‰CRAN LOBBY
// ============================================================================
function LobbyScreen({ gameId, game, user, setScreen, notify }) {
  if (!game) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" }, React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" }));

  const players = Object.values(game.players || {});
  const me = players.find(p => p.oderId === user?.uid);
  const isHost = me?.isHost;
  const takenChars = players.map(p => p.charKey).filter(Boolean);
  const allReady = players.length >= 2 && players.every(p => p.charKey && p.stats);

  const selectChar = async (ck) => {
    if (takenChars.includes(ck) && me?.charKey !== ck) return;
    if (database) await database.ref(`games/${gameId}/players/${user.uid}/charKey`).set(ck);
  };

  const startGame = async () => {
    if (!isHost || !allReady) return;
    const init = {};
    const order = [];
    Object.entries(game.players).forEach(([uid, p], i) => {
      const ch = CHARACTERS[p.charKey];
      order.push(uid);
      init[uid] = {
        ...p, index: i, character: ch, characterKey: p.charKey,
        pvCurrent: ch.pvMax, or: rulesEngine.getStartGold(p.charKey),
        cuivre: 0, argent: 0, obsidienne: 0, pdv: 0, pdvHistory: [],
        territories: [], defeatedBosses: [], effects: [], quests: [],
        skills: ch.skills.map((s, idx) => ({ id: `skill_${idx}`, description: s, status: 'AVAILABLE' })),
        usedAttackDice: false, rerollAvailable: true,
        blessAvailable: p.charKey === 'VICAIRE', curseAvailable: p.charKey === 'HERETIQUE'
      };
    });
    if (database) await database.ref(`games/${gameId}`).update({ status: "playing", players: init, turnOrder: order, currentTurn: 0, targetPdv: order.length * 10 });
  };

  const copyCode = () => { navigator.clipboard?.writeText(gameId); notify("Code copiÃ© !", "success"); };

  return React.createElement("div", { className: "min-h-screen p-4" },
    React.createElement("div", { className: "max-w-2xl mx-auto" },
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "text-center text-gray-600 text-sm mb-2" }, "Code de la partie"),
        React.createElement("div", { className: "text-4xl font-bold text-center text-purple-600 tracking-widest cursor-pointer hover:text-purple-700 py-4 bg-purple-50 rounded-xl border-2 border-dashed border-purple-300", onClick: copyCode }, gameId),
        React.createElement("p", { className: "text-center text-gray-500 text-xs mt-2" }, "Cliquez pour copier")
      ),
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, `Joueurs (${players.length}/6)`),
        players.map(p => {
          const isMe = p.oderId === user?.uid;
          return React.createElement("div", { key: p.oderId, className: `flex items-center gap-3 p-3 rounded-xl mb-2 ${isMe ? 'bg-purple-50 border-2 border-purple-400' : 'bg-gray-50'} ${p.charKey && p.stats ? 'border-green-400' : ''}` },
            React.createElement("div", { className: "w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center text-2xl" }, p.charKey ? CHARACTERS[p.charKey].emoji : "ðŸ‘¤"),
            React.createElement("div", { className: "flex-1" },
              React.createElement("div", { className: "font-semibold flex items-center gap-2" }, p.name, p.isHost && React.createElement("span", { className: "text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full" }, "HÃ´te"), isMe && React.createElement("span", { className: "text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full" }, "Vous")),
              React.createElement("div", { className: "text-sm text-gray-600" }, p.charKey ? CHARACTERS[p.charKey].name : "Choisit...")
            ),
            p.charKey && p.stats && React.createElement("span", { className: "text-green-600 font-bold text-xl" }, "âœ“")
          );
        })
      ),
      !me?.charKey && React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, "Choisissez votre personnage"),
        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
          Object.values(CHARACTERS).map(ch => {
            const taken = takenChars.includes(ch.key);
            return React.createElement("div", { key: ch.key, onClick: () => !taken && selectChar(ch.key), className: `p-4 rounded-xl border-2 cursor-pointer transition-all ${taken ? 'opacity-40 cursor-not-allowed' : 'hover:border-purple-400 hover:bg-purple-50'}` },
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("span", { className: "text-3xl" }, ch.emoji),
                React.createElement("div", { className: "flex-1" },
                  React.createElement("div", { className: "font-bold" }, ch.name),
                  React.createElement("div", { className: "text-xs text-gray-600" }, ch.role),
                  React.createElement("div", { className: "text-sm text-purple-600 font-semibold" }, `â¤ï¸ ${ch.pvMax} PV`)
                ),
                taken && React.createElement("span", { className: "text-xs bg-red-500 text-white px-2 py-1 rounded" }, "PRIS")
              )
            );
          })
        )
      ),
      me?.charKey && !me?.stats && React.createElement(StatsAlloc, { gameId, oderId: user?.uid, character: CHARACTERS[me.charKey], notify }),
      isHost && React.createElement("button", { className: `w-full py-4 rounded-xl font-bold text-lg ${allReady ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`, onClick: startGame, disabled: !allReady }, allReady ? "ðŸš€ Lancer la partie !" : `En attente (${players.filter(p => p.charKey && p.stats).length}/${players.length})`)
    )
  );
}

// ============================================================================
// ALLOCATION STATS
// ============================================================================
function StatsAlloc({ gameId, oderId, character, notify }) {
  const MODIFIERS = [-2, -1, 0, 0, 1, 2];
  const [allocation, setAllocation] = useState({ endurance: null, force: null, vitesse: null, perception: null, sagesse: null, intelligence: null });

  const isModifierUsed = (mod) => {
    const usedCount = Object.values(allocation).filter(v => v === mod).length;
    const totalCount = MODIFIERS.filter(m => m === mod).length;
    return usedCount >= totalCount;
  };

  const handleClick = (stat, mod) => {
    if (allocation[stat] === mod) setAllocation({ ...allocation, [stat]: null });
    else if (!isModifierUsed(mod) || allocation[stat] !== null) setAllocation({ ...allocation, [stat]: mod });
  };

  const isValid = Object.values(allocation).every(v => v !== null);

  const confirmStats = async () => {
    if (!isValid) return;
    if (database) await database.ref(`games/${gameId}/players/${oderId}/stats`).set(allocation);
    notify("Stats enregistrÃ©es !", "success");
  };

  return React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
    React.createElement("h3", { className: "font-bold text-gray-800 mb-2" }, "RÃ©partissez vos statistiques"),
    React.createElement("p", { className: "text-gray-600 text-sm mb-4" }, "Assignez: -2, -1, 0, 0, +1, +2"),
    React.createElement("div", { className: "space-y-4" },
      Object.entries(STAT_NAMES).map(([key, name]) => {
        const val = allocation[key];
        return React.createElement("div", { key, className: "bg-gray-50 rounded-lg p-3" },
          React.createElement("div", { className: "flex justify-between items-center mb-2" },
            React.createElement("span", { className: "font-semibold" }, name),
            val !== null && React.createElement("span", { className: `font-bold ${val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-blue-600'}` }, val > 0 ? `+${val}` : val)
          ),
          React.createElement("div", { className: "flex gap-2 justify-center" },
            MODIFIERS.map((mod, idx) => {
              const sel = val === mod;
              const dis = !sel && isModifierUsed(mod);
              return React.createElement("button", { key: idx, onClick: () => handleClick(key, mod), disabled: dis, className: `w-12 h-12 rounded-full font-bold ${sel ? mod >= 0 ? 'bg-green-600 text-white ring-4 ring-green-300' : 'bg-red-600 text-white ring-4 ring-red-300' : dis ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white border-2 border-gray-300 hover:border-purple-500'}` }, mod > 0 ? `+${mod}` : mod);
            })
          )
        );
      })
    ),
    React.createElement("button", { className: `w-full py-3 rounded-xl font-bold mt-4 ${isValid ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`, onClick: confirmStats, disabled: !isValid }, isValid ? "âœ“ Confirmer" : "ComplÃ©tez tout")
  );
}

// ============================================================================
// Ã‰CRAN DE JEU PRINCIPAL
// ============================================================================
function GameScreen({ gameId, game, user, notify }) {
  const [activeTab, setActiveTab] = useState('tirages');

  if (!game?.players || !game.turnOrder) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" }, React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" }));

  const order = game.turnOrder;
  const curIdx = game.currentTurn || 0;
  const curUid = order[curIdx];
  const curPlayer = game.players[curUid];
  const me = game.players[user?.uid];
  const isMyTurn = curUid === user?.uid;

  const players = order.map(uid => game.players[uid]).filter(Boolean);
  const totalPdv = players.reduce((s, p) => s + (p.pdv || 0), 0);
  const targetPdv = game.targetPdv || players.length * 10;

  const updateMe = async (updates) => {
    if (database) await database.ref(`games/${gameId}/players/${user.uid}`).update(updates);
  };

  const updatePlayer = async (uid, updates) => {
    if (database) await database.ref(`games/${gameId}/players/${uid}`).update(updates);
  };

  const updateGame = async (updates) => {
    if (database) await database.ref(`games/${gameId}`).update(updates);
  };

  const addPdvWithHistory = async (amount, source, details = {}) => {
    const newPdv = (me.pdv || 0) + amount;
    const newHistory = [...(me.pdvHistory || []), { id: Date.now(), amount, source, details }];
    await updateMe({ pdv: newPdv, pdvHistory: newHistory });
  };

  const nextTurn = async () => {
    if (!isMyTurn) return;
    const next = (curIdx + 1) % order.length;
    if (database) {
      await database.ref(`games/${gameId}/players/${user.uid}`).update({ usedAttackDice: false, rerollAvailable: true });
      await database.ref(`games/${gameId}/currentTurn`).set(next);
    }
    notify("Tour passÃ© !", "success");
  };

  const tabs = [
    { id: "tirages", label: "Tirages" },
    { id: "de", label: "DÃ©" },
    { id: "attaque", label: "Attaque" },
    { id: "objectif", label: "Objectif" },
    { id: "echange", label: "Ã‰change" },
    { id: "personnage", label: "Perso" },
    { id: "pdv", label: "PDV" }
  ];

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 flex flex-col pb-24" },
    React.createElement("div", { className: `p-4 text-white ${isMyTurn ? 'bg-gradient-to-r from-green-600 to-teal-600' : 'bg-gradient-to-r from-orange-500 to-red-500'}` },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "text-sm font-bold mb-1" }, isMyTurn ? "ðŸŽ¯ C'EST VOTRE TOUR !" : `â³ Tour de ${curPlayer?.name || '?'}`),
        React.createElement("div", { className: "flex justify-between items-center" },
          React.createElement("div", null,
            React.createElement("div", { className: "text-xl font-bold" }, me?.name),
            React.createElement("div", { className: "text-sm opacity-90" }, me?.character?.name)
          ),
          React.createElement("div", { className: "text-right" },
            React.createElement("div", { className: "text-2xl font-bold" }, `${me?.pvCurrent || 0}/${me?.character?.pvMax || 0}`),
            React.createElement("div", { className: "text-xs" }, "PV")
          )
        ),
        React.createElement("div", { className: "flex gap-2 mt-2 text-xs flex-wrap" },
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸ’° ${me?.or || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸŒ³ ${me?.cuivre || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸœï¸ ${me?.argent || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `â›°ï¸ ${me?.obsidienne || 0}`),
          React.createElement("span", { className: "bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold" }, `ðŸ† ${me?.pdv || 0}`)
        )
      )
    ),
    React.createElement("div", { className: "bg-white shadow px-4 py-2" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "flex justify-between text-xs text-gray-600 mb-1" },
          React.createElement("span", null, "Progression"),
          React.createElement("span", null, `${totalPdv} / ${targetPdv} PDV`)
        ),
        React.createElement("div", { className: "h-2 bg-gray-200 rounded-full overflow-hidden" },
          React.createElement("div", { className: "h-full bg-gradient-to-r from-purple-600 to-blue-600 rounded-full", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        )
      )
    ),
    React.createElement("div", { className: "bg-white shadow-md overflow-x-auto" },
      React.createElement("div", { className: "flex max-w-4xl mx-auto" },
        tabs.map(t => React.createElement("button", { key: t.id, onClick: () => setActiveTab(t.id), className: `flex-shrink-0 px-4 py-3 font-semibold text-sm border-b-4 ${activeTab === t.id ? 'bg-purple-600 text-white border-purple-800' : 'bg-gray-100 text-gray-600 border-transparent hover:bg-gray-200'}` }, t.label))
      )
    ),
    React.createElement("div", { className: "flex-1 overflow-y-auto p-4" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6" },
          activeTab === 'tirages' && React.createElement(TiragesTab, { player: me, isMyTurn, updateMe, notify, game, updateGame }),
          activeTab === 'de' && React.createElement(DeTab, { player: me, isMyTurn, updateMe, notify }),
          activeTab === 'attaque' && React.createElement(AttaqueTab, { player: me, isMyTurn, updateMe, notify, players, updatePlayer, addPdvWithHistory }),
          activeTab === 'objectif' && React.createElement(ObjectifTab, { player: me, isMyTurn, updateMe, notify, game, updateGame, addPdvWithHistory }),
          activeTab === 'echange' && React.createElement(EchangeTab, { player: me, isMyTurn, updateMe, notify, players, updatePlayer, user }),
          activeTab === 'personnage' && React.createElement(PersonnageTab, { player: me, updateMe }),
          activeTab === 'pdv' && React.createElement(PdvTab, { player: me, players })
        )
      )
    ),
    isMyTurn && React.createElement("div", { className: "fixed bottom-0 left-0 right-0 p-4 bg-white shadow-lg border-t" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-bold text-lg", onClick: nextTurn }, "âœ… Fin de mon tour")
      )
    )
  );
}

// ============================================================================
// ONGLET TIRAGES
// ============================================================================
function TiragesTab({ player, isMyTurn, updateMe, notify, game, updateGame }) {
  const [anomCard, setAnomCard] = useState(null);
  const [questCard, setQuestCard] = useState(null);
  const [applied, setApplied] = useState(null);

  const drawAnomaly = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const available = ANOMALIES.filter((_, i) => !(game.drawnAnomalies || []).includes(i));
    if (available.length === 0) return notify("Deck vide !", "error");
    
    const idx = Math.floor(Math.random() * available.length);
    const card = available[idx];
    const origIdx = ANOMALIES.indexOf(card);
    
    await updateGame({ drawnAnomalies: [...(game.drawnAnomalies || []), origIdx] });
    setAnomCard(card);
    
    const effect = parseAnomaly(card);
    let msg = "";
    if (effect.type === 'heal') {
      const newPv = Math.min(player.character.pvMax, player.pvCurrent + effect.amount);
      await updateMe({ pvCurrent: newPv });
      msg = `+${effect.amount} PV`;
    } else if (effect.type === 'damage') {
      const newPv = Math.max(0, player.pvCurrent - effect.amount);
      await updateMe({ pvCurrent: newPv });
      msg = `-${effect.amount} PV`;
    } else if (effect.type === 'bless') {
      const newEffects = [...(player.effects || []), { id: Date.now(), type: 'BLESS', stat: effect.stat, delta: 2, name: `BÃ©nÃ©diction ${STAT_NAMES[effect.stat]}` }];
      await updateMe({ effects: newEffects });
      msg = `âœ¨ BÃ©nÃ©diction ${STAT_NAMES[effect.stat]}`;
    } else if (effect.type === 'curse') {
      const newEffects = [...(player.effects || []), { id: Date.now(), type: 'CURSE', stat: effect.stat, delta: -2, name: `MalÃ©diction ${STAT_NAMES[effect.stat]}` }];
      await updateMe({ effects: newEffects });
      msg = `ðŸ’€ MalÃ©diction ${STAT_NAMES[effect.stat]}`;
    } else if (effect.type === 'gain') {
      await updateMe({ [effect.resource]: (player[effect.resource] || 0) + effect.amount });
      msg = `+${effect.amount} ${effect.resource}`;
    } else if (effect.type === 'lose') {
      await updateMe({ [effect.resource]: Math.max(0, (player[effect.resource] || 0) - effect.amount) });
      msg = `-${effect.amount} ${effect.resource}`;
    } else if (effect.type === 'recharge') {
      await updateMe({ blessAvailable: player.characterKey === 'VICAIRE', curseAvailable: player.characterKey === 'HERETIQUE' });
      msg = "Pouvoir rechargÃ© !";
    }
    setApplied(msg);
  };

  const drawQuest = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if ((player.quests || []).length >= 2) return notify("Max 2 quÃªtes !", "error");
    
    const available = QUETES.filter((_, i) => !(game.drawnQuetes || []).includes(i));
    if (available.length === 0) return notify("Deck vide !", "error");
    
    const idx = Math.floor(Math.random() * available.length);
    const card = available[idx];
    const origIdx = QUETES.indexOf(card);
    
    await updateGame({ drawnQuetes: [...(game.drawnQuetes || []), origIdx] });
    setQuestCard(card);
    
    const newQuests = [...(player.quests || []), { id: Date.now(), text: card, completed: false }];
    await updateMe({ quests: newQuests });
  };

  const remainingAnom = ANOMALIES.length - (game.drawnAnomalies || []).length;
  const remainingQuest = QUETES.length - (game.drawnQuetes || []).length;

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ´ Tirages"),
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `Anomalie (${remainingAnom} restantes)`),
      React.createElement("div", { className: "min-h-32 bg-gradient-to-r from-purple-600 to-purple-800 rounded-xl p-6 flex items-center justify-center text-white mb-3" },
        anomCard ? React.createElement("div", { className: "text-center" },
          React.createElement("p", { className: "font-medium" }, anomCard),
          applied && React.createElement("p", { className: "text-yellow-300 font-bold mt-2" }, `âœ¨ ${applied}`)
        ) : React.createElement("p", { className: "text-purple-200 italic" }, "Tirez une carte...")
      ),
      React.createElement("button", { onClick: drawAnomaly, disabled: !isMyTurn, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 disabled:opacity-50" }, "ðŸ”® Tirer une Anomalie")
    ),
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `QuÃªte (${(player.quests || []).length}/2) - ${remainingQuest} restantes`),
      React.createElement("div", { className: "min-h-32 bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-6 flex items-center justify-center text-white mb-3" },
        questCard ? React.createElement("p", { className: "font-medium text-center" }, questCard) : React.createElement("p", { className: "text-green-200 italic" }, "Tirez une quÃªte...")
      ),
      React.createElement("button", { onClick: drawQuest, disabled: !isMyTurn || (player.quests || []).length >= 2, className: "w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50" }, (player.quests || []).length >= 2 ? "Max atteint" : "ðŸ“œ Tirer une QuÃªte")
    ),
    (player.quests || []).length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "Mes quÃªtes"),
      React.createElement("div", { className: "space-y-2" },
        (player.quests || []).map(q => React.createElement("div", { key: q.id, className: "bg-gray-50 rounded-lg p-3 text-sm" }, q.text))
      )
    )
  );
}

// ============================================================================
// ONGLET DÃ‰
// ============================================================================
function DeTab({ player, isMyTurn, updateMe, notify }) {
  const [moveResult, setMoveResult] = useState(null);
  const [attackResult, setAttackResult] = useState(null);
  const [rolling, setRolling] = useState(false);
  const [showReroll, setShowReroll] = useState(false);

  const rollMove = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    setRolling(true);
    setTimeout(() => {
      setMoveResult(Math.floor(Math.random() * 10) + 1);
      setRolling(false);
    }, 500);
  };

  const rollAttack = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (player.usedAttackDice) return notify("DÃ©jÃ  utilisÃ© ce tour", "error");
    setRolling(true);
    setTimeout(async () => {
      const statIdx = Math.floor(Math.random() * STATISTIQUES.length);
      const stat = STATISTIQUES[statIdx];
      const statKey = STAT_MAPPING[stat] || stat.toLowerCase();
      const dice = Math.floor(Math.random() * 10) + 1;
      const base = player.stats?.[statKey] || 0;
      const effects = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
      const total = dice + base + effects;
      const result = { stat, statKey, dice, base, effects, total, crit: dice === 10 };
      setAttackResult(result);
      
      if (player.characterKey === 'VICAIRE' && player.rerollAvailable) {
        setShowReroll(true);
      } else {
        await updateMe({ usedAttackDice: true });
      }
      setRolling(false);
    }, 500);
  };

  const handleReroll = async (accept) => {
    if (accept) {
      const resource = getRandomAvailableResource(player);
      if (!resource) {
        notify("Pas de ressource !", "error");
        await updateMe({ usedAttackDice: true });
        setShowReroll(false);
        return;
      }
      const stats = STATISTIQUES.filter(s => (STAT_MAPPING[s] || s.toLowerCase()) !== attackResult.statKey);
      const newStat = stats[Math.floor(Math.random() * stats.length)];
      const newKey = STAT_MAPPING[newStat] || newStat.toLowerCase();
      const base = player.stats?.[newKey] || 0;
      const effects = (player.effects || []).filter(e => e.stat === newKey).reduce((s, e) => s + e.delta, 0);
      const total = attackResult.dice + base + effects;
      setAttackResult({ ...attackResult, stat: newStat, statKey: newKey, base, effects, total, rerolled: true });
      await updateMe({ usedAttackDice: true, rerollAvailable: false, [resource]: Math.max(0, (player[resource] || 0) - 1) });
      notify(`Relance ! -1 ${resource}`, "success");
    } else {
      await updateMe({ usedAttackDice: true });
    }
    setShowReroll(false);
  };

  return React.createElement("div", { className: "space-y-6" },
    showReroll && React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" },
      React.createElement("div", { className: "bg-white rounded-2xl p-6 max-w-sm w-full" },
        React.createElement("h3", { className: "text-xl font-bold text-center mb-4" }, "ðŸ”„ Relance Vicaire"),
        React.createElement("p", { className: "text-center text-gray-600 mb-4" }, "Changer la statistique ? (coÃ»t: 1 ressource)"),
        React.createElement("div", { className: "bg-purple-100 rounded-xl p-4 mb-4 text-center" },
          React.createElement("div", { className: "text-lg font-bold text-purple-600" }, attackResult?.stat),
          React.createElement("div", { className: "text-3xl font-bold" }, attackResult?.total)
        ),
        React.createElement("div", { className: "flex gap-3" },
          React.createElement("button", { onClick: () => handleReroll(true), className: "flex-1 py-3 bg-green-600 text-white rounded-xl font-bold" }, "âœ… Oui"),
          React.createElement("button", { onClick: () => handleReroll(false), className: "flex-1 py-3 bg-gray-400 text-white rounded-xl font-bold" }, "âŒ Non")
        )
      )
    ),
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ² DÃ©s"),
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "DÃ©placement"),
      React.createElement("div", { className: `min-h-32 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 flex flex-col items-center justify-center text-white mb-3 ${rolling ? 'animate-pulse' : ''}` },
        moveResult !== null ? React.createElement(React.Fragment, null,
          React.createElement("div", { className: "text-6xl font-bold" }, moveResult),
          moveResult === 10 && React.createElement("div", { className: "text-yellow-300 font-bold mt-2" }, "âœ¨ Critique !")
        ) : React.createElement("p", { className: "text-blue-200" }, "Lancez le dÃ©")
      ),
      React.createElement("button", { onClick: rollMove, disabled: !isMyTurn || rolling, className: "w-full py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "ðŸŽ² Lancer (1-10)")
    ),
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Attaque"),
      player.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-2 mb-3 text-center text-sm text-yellow-800" }, "âš ï¸ DÃ©jÃ  utilisÃ©"),
      React.createElement("div", { className: `min-h-40 bg-gradient-to-r from-red-600 to-red-800 rounded-xl p-6 flex flex-col items-center justify-center text-white mb-3 ${rolling ? 'animate-pulse' : ''}` },
        attackResult ? React.createElement("div", { className: "text-center w-full" },
          React.createElement("div", { className: "text-yellow-300 font-bold text-xl mb-2" }, attackResult.stat, attackResult.rerolled && " ðŸ”„"),
          React.createElement("div", { className: "text-5xl font-bold mb-3" }, attackResult.total),
          attackResult.crit && React.createElement("div", { className: "text-yellow-300 font-bold" }, "âœ¨ Critique !"),
          React.createElement("div", { className: "bg-white bg-opacity-20 rounded-lg p-3 mt-2 text-sm" },
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "DÃ©:"), React.createElement("span", { className: "font-bold" }, attackResult.dice)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Base:"), React.createElement("span", { className: "font-bold" }, attackResult.base >= 0 ? `+${attackResult.base}` : attackResult.base)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Ã‰tats:"), React.createElement("span", { className: `font-bold ${attackResult.effects >= 0 ? 'text-green-300' : 'text-red-300'}` }, attackResult.effects >= 0 ? `+${attackResult.effects}` : attackResult.effects))
          )
        ) : React.createElement("p", { className: "text-red-200" }, "Lancez le dÃ©")
      ),
      React.createElement("button", { onClick: rollAttack, disabled: !isMyTurn || rolling || player.usedAttackDice, className: "w-full py-3 bg-red-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "âš”ï¸ Lancer Attaque")
    )
  );
}

// ============================================================================
// ONGLET ATTAQUE
// ============================================================================
function AttaqueTab({ player, isMyTurn, updateMe, notify, players, updatePlayer, addPdvWithHistory }) {
  const [mode, setMode] = useState(null);
  const [selectedBiome, setSelectedBiome] = useState(null);
  const [selectedDiff, setSelectedDiff] = useState(null);
  const [result, setResult] = useState(null);
  const [sacrifice, setSacrifice] = useState(0);
  const [showSacrifice, setShowSacrifice] = useState(false);

  const canSac = rulesEngine.canSacrificePv(player);

  const attackTerritory = async (sac = 0) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (player.usedAttackDice) return notify("DÃ© dÃ©jÃ  utilisÃ©", "error");
    if (!selectedBiome || !selectedDiff) return notify("SÃ©lectionnez biome et difficultÃ©", "error");
    
    const statKeys = Object.keys(STAT_NAMES);
    const statKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const dice = Math.floor(Math.random() * 10) + 1;
    const base = player.stats?.[statKey] || 0;
    const effects = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const bonus = rulesEngine.getAttackBonus(player, { type: 'TERRITORY', isNeutral: true });
    const total = dice + base + effects + bonus.bonus + sac;
    const success = total >= selectedDiff;
    
    const pdv = selectedDiff === 6 ? 3 : selectedDiff === 8 ? 4 : 5;
    const resource = BIOMES[selectedBiome].resource;
    
    let newPv = player.pvCurrent - sac;
    
    if (success) {
      const newTerritories = [...(player.territories || []), { biome: selectedBiome, difficulty: selectedDiff }];
      const newPdv = player.pdv + pdv;
      const newHistory = [...(player.pdvHistory || []), { id: Date.now(), amount: pdv, source: 'TERRITORY' }];
      const heal = rulesEngine.getHealOnSuccess(player);
      if (heal > 0) newPv = Math.min(player.character.pvMax, newPv + heal);
      await updateMe({ territories: newTerritories, pdv: newPdv, pdvHistory: newHistory, [resource]: (player[resource] || 0) + 1, usedAttackDice: true, pvCurrent: Math.max(0, newPv) });
    } else {
      const damage = Math.max(1, selectedDiff - total);
      await updateMe({ pvCurrent: Math.max(0, newPv - damage), usedAttackDice: true });
    }
    
    setResult({ stat: STAT_NAMES[statKey], dice, base, effects, bonus: bonus.bonus, sacrifice: sac, total, difficulty: selectedDiff, success, pdv, biome: selectedBiome });
    setMode('result');
    setShowSacrifice(false);
    setSacrifice(0);
  };

  const startAttack = () => {
    if (canSac && player.pvCurrent > 1) {
      setShowSacrifice(true);
    } else {
      attackTerritory(0);
    }
  };

  if (showSacrifice) {
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, "ðŸ©¸ Furie Sacrificielle"),
      React.createElement("p", { className: "text-center text-red-600" }, "Sacrifiez des PV pour bonus au jet"),
      React.createElement("div", { className: "text-center" },
        React.createElement("div", { className: "text-gray-600 mb-4" }, `PV: ${player.pvCurrent}`),
        React.createElement("div", { className: "flex items-center justify-center gap-4 my-4" },
          React.createElement("button", { onClick: () => setSacrifice(Math.max(0, sacrifice - 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold text-xl" }, "-"),
          React.createElement("span", { className: "text-5xl font-bold text-red-600" }, sacrifice),
          React.createElement("button", { onClick: () => setSacrifice(Math.min(player.pvCurrent - 1, sacrifice + 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold text-xl" }, "+")
        ),
        React.createElement("p", { className: "text-gray-600" }, `Bonus: +${sacrifice}`)
      ),
      React.createElement("div", { className: "grid grid-cols-2 gap-4" },
        React.createElement("button", { onClick: () => { setShowSacrifice(false); setSacrifice(0); }, className: "py-3 bg-gray-600 text-white rounded-lg font-semibold" }, "Annuler"),
        React.createElement("button", { onClick: () => attackTerritory(sacrifice), className: "py-3 bg-red-600 text-white rounded-lg font-bold" }, "Confirmer")
      )
    );
  }

  if (mode === 'result' && result) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-2xl font-bold text-center" }, "âš”ï¸ RÃ©sultat"),
      React.createElement("div", { className: `rounded-xl p-6 text-white text-center ${result.success ? 'bg-gradient-to-r from-green-500 to-teal-500' : 'bg-gradient-to-r from-red-500 to-orange-500'}` },
        React.createElement("div", { className: "text-4xl font-bold mb-2" }, result.success ? "âœ… VICTOIRE !" : "âŒ Ã‰CHEC"),
        React.createElement("div", { className: "text-xl mb-4" }, `${result.total} vs ${result.difficulty}`),
        result.success && React.createElement("div", { className: "text-lg" }, `+${result.pdv} PDV | +1 ${BIOMES[result.biome].resource}`),
        !result.success && React.createElement("div", { className: "text-lg" }, `${Math.max(1, result.difficulty - result.total)} dÃ©gÃ¢ts`)
      ),
      React.createElement("button", { onClick: () => { setMode(null); setResult(null); setSelectedBiome(null); setSelectedDiff(null); }, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold" }, "Fermer")
    );
  }

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ Attaque"),
    player.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-3 text-center text-yellow-800" }, "âš ï¸ DÃ© dÃ©jÃ  utilisÃ©"),
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ° ConquÃ©rir un territoire"),
      React.createElement("div", { className: "mb-3" },
        React.createElement("label", { className: "text-sm text-gray-600 mb-2 block" }, "Biome"),
        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
          Object.entries(BIOMES).map(([k, b]) => React.createElement("button", { key: k, onClick: () => setSelectedBiome(k), className: `p-3 rounded-lg text-center ${selectedBiome === k ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200 hover:border-purple-400'}` },
            React.createElement("div", { className: "text-2xl" }, b.emoji),
            React.createElement("div", { className: "text-xs mt-1" }, b.name.split(' ')[0])
          ))
        )
      ),
      React.createElement("div", { className: "mb-3" },
        React.createElement("label", { className: "text-sm text-gray-600 mb-2 block" }, "DifficultÃ©"),
        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
          [6, 8, 10].map(d => React.createElement("button", { key: d, onClick: () => setSelectedDiff(d), className: `p-3 rounded-lg text-center ${selectedDiff === d ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200 hover:border-purple-400'}` },
            React.createElement("div", { className: "font-bold" }, d),
            React.createElement("div", { className: "text-xs" }, `${d === 6 ? 3 : d === 8 ? 4 : 5} PDV`)
          ))
        )
      ),
      React.createElement("button", { onClick: startAttack, disabled: !isMyTurn || player.usedAttackDice || !selectedBiome || !selectedDiff, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "âš”ï¸ Attaquer")
    ),
    (player.territories || []).length > 0 && React.createElement("div", { className: "bg-green-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `ðŸ° Territoires (${(player.territories || []).length})`),
      React.createElement("div", { className: "flex flex-wrap gap-2" },
        (player.territories || []).map((t, i) => React.createElement("span", { key: i, className: "bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm" }, `${BIOMES[t.biome].emoji} Diff.${t.difficulty}`))
      )
    )
  );
}

// ============================================================================
// ONGLET OBJECTIF
// ============================================================================
function ObjectifTab({ player, isMyTurn, updateMe, notify, game, updateGame, addPdvWithHistory }) {
  const completeObjective = async (obj) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if ((game.completedObjectives || []).includes(obj.id)) return notify("DÃ©jÃ  complÃ©tÃ©", "error");
    if ((player[obj.resource] || 0) < obj.amount) return notify("Ressources insuffisantes", "error");
    
    await updateMe({ [obj.resource]: (player[obj.resource] || 0) - obj.amount });
    await updateGame({ completedObjectives: [...(game.completedObjectives || []), obj.id] });
    await addPdvWithHistory(obj.pdv, 'BONUS', { reason: `Objectif ${obj.label}` });
    notify(`+${obj.pdv} PDV !`, "success");
  };

  const exchangeQuest = async (quest) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const info = parseQuest(quest.text);
    if (!info.isExchange) return;
    if ((player[info.resourceKey] || 0) < info.resourceAmount) return notify("Ressources insuffisantes", "error");
    
    const newQuests = (player.quests || []).filter(q => q.id !== quest.id);
    const questBonus = rulesEngine.getQuestBonus(player);
    await updateMe({ quests: newQuests, [info.resourceKey]: (player[info.resourceKey] || 0) - info.resourceAmount });
    await addPdvWithHistory(info.pdv + questBonus, 'QUEST_EXCHANGE', { resource: info.resourceKey });
    notify(`+${info.pdv + questBonus} PDV !`, "success");
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ¯ Objectifs"),
    React.createElement("div", { className: "grid grid-cols-1 gap-4" },
      OBJECTIVES.map(obj => {
        const completed = (game.completedObjectives || []).includes(obj.id);
        const canComplete = (player[obj.resource] || 0) >= obj.amount && !completed;
        return React.createElement("div", { key: obj.id, className: `p-4 rounded-xl border-2 ${completed ? 'bg-green-50 border-green-400' : canComplete ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-300'}` },
          React.createElement("div", { className: "flex justify-between items-center" },
            React.createElement("div", { className: "flex items-center gap-3" },
              React.createElement("span", { className: "text-3xl" }, obj.emoji),
              React.createElement("div", null,
                React.createElement("div", { className: "font-bold" }, obj.label),
                React.createElement("div", { className: "text-sm text-gray-600" }, `Vous: ${player[obj.resource] || 0}/${obj.amount}`)
              )
            ),
            completed ? React.createElement("span", { className: "text-green-600 font-bold" }, "âœ…") :
            React.createElement("button", { onClick: () => completeObjective(obj), disabled: !canComplete || !isMyTurn, className: `px-4 py-2 rounded-lg font-semibold ${canComplete ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}` }, `+${obj.pdv} PDV`)
          )
        );
      })
    ),
    (player.quests || []).length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ“œ Mes quÃªtes"),
      React.createElement("div", { className: "space-y-3" },
        (player.quests || []).map(q => {
          const info = parseQuest(q.text);
          const canExchange = info.isExchange && (player[info.resourceKey] || 0) >= info.resourceAmount;
          return React.createElement("div", { key: q.id, className: "bg-gray-50 rounded-xl p-4" },
            React.createElement("p", { className: "text-gray-700 mb-3" }, q.text),
            info.isExchange && React.createElement("button", { onClick: () => exchangeQuest(q), disabled: !canExchange || !isMyTurn, className: `w-full py-2 rounded-lg font-semibold ${canExchange ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}` }, canExchange ? `âœ… Ã‰changer (+${info.pdv} PDV)` : "Ressources manquantes")
          );
        })
      )
    ),
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold mb-2" }, "ðŸ“Š Ressources"),
      React.createElement("div", { className: "grid grid-cols-4 gap-2 text-center" },
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "ðŸ’°"), React.createElement("div", { className: "font-bold" }, player.or || 0)),
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "ðŸŒ³"), React.createElement("div", { className: "font-bold" }, player.cuivre || 0)),
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "ðŸœï¸"), React.createElement("div", { className: "font-bold" }, player.argent || 0)),
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "â›°ï¸"), React.createElement("div", { className: "font-bold" }, player.obsidienne || 0))
      )
    )
  );
}

// ============================================================================
// ONGLET Ã‰CHANGE
// ============================================================================
function EchangeTab({ player, isMyTurn, updateMe, notify, players, updatePlayer, user }) {
  const [selectedTarget, setSelectedTarget] = useState(null);
  const [giveRes, setGiveRes] = useState(null);
  const [giveAmt, setGiveAmt] = useState(1);
  const [receiveRes, setReceiveRes] = useState(null);
  const [receiveAmt, setReceiveAmt] = useState(1);

  const RESOURCES = [
    { key: 'or', emoji: 'ðŸ’°', name: 'Or', value: 1 },
    { key: 'cuivre', emoji: 'ðŸŒ³', name: 'Cuivre', value: 2 },
    { key: 'argent', emoji: 'ðŸœï¸', name: 'Argent', value: 3 },
    { key: 'obsidienne', emoji: 'â›°ï¸', name: 'Obsidienne', value: 4 }
  ];

  const opponents = players.filter(p => p.oderId !== user?.uid);
  const target = selectedTarget ? players.find(p => p.oderId === selectedTarget) : null;

  const giveValue = giveRes ? giveAmt * RESOURCES.find(r => r.key === giveRes)?.value : 0;
  const receiveValue = receiveRes ? receiveAmt * RESOURCES.find(r => r.key === receiveRes)?.value : 0;
  const isBalanced = giveValue > 0 && giveValue === receiveValue;

  const canExchange = selectedTarget && giveRes && receiveRes && 
    (player[giveRes] || 0) >= giveAmt && 
    target && (target[receiveRes] || 0) >= receiveAmt && isBalanced;

  const executeExchange = async () => {
    if (!canExchange || !isMyTurn) return;
    await updateMe({ [giveRes]: (player[giveRes] || 0) - giveAmt, [receiveRes]: (player[receiveRes] || 0) + receiveAmt });
    await updatePlayer(selectedTarget, { [giveRes]: (target[giveRes] || 0) + giveAmt, [receiveRes]: (target[receiveRes] || 0) - receiveAmt });
    notify("Ã‰change effectuÃ© !", "success");
    setSelectedTarget(null);
    setGiveRes(null);
    setReceiveRes(null);
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸ”„ Ã‰change"),
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Choisir un joueur"),
      React.createElement("div", { className: "grid grid-cols-2 gap-2" },
        opponents.map(p => React.createElement("button", { key: p.oderId, onClick: () => setSelectedTarget(p.oderId), className: `p-3 rounded-lg ${selectedTarget === p.oderId ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200'}` },
          React.createElement("div", { className: "flex items-center gap-2" },
            React.createElement("span", { className: "text-xl" }, p.character?.emoji),
            React.createElement("span", null, p.name)
          )
        ))
      )
    ),
    target && React.createElement(React.Fragment, null,
      React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
        React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Vous donnez"),
        React.createElement("div", { className: "grid grid-cols-4 gap-2 mb-3" },
          RESOURCES.map(r => React.createElement("button", { key: r.key, onClick: () => setGiveRes(r.key), className: `p-2 rounded-lg text-center ${giveRes === r.key ? 'bg-blue-600 text-white' : 'bg-white border-2'}` },
            React.createElement("div", { className: "text-xl" }, r.emoji),
            React.createElement("div", { className: "text-xs" }, player[r.key] || 0)
          ))
        ),
        giveRes && React.createElement("div", { className: "flex items-center justify-center gap-4" },
          React.createElement("button", { onClick: () => setGiveAmt(Math.max(1, giveAmt - 1)), className: "w-10 h-10 bg-gray-200 rounded-full font-bold" }, "-"),
          React.createElement("span", { className: "text-2xl font-bold" }, giveAmt),
          React.createElement("button", { onClick: () => setGiveAmt(Math.min(player[giveRes] || 0, giveAmt + 1)), className: "w-10 h-10 bg-gray-200 rounded-full font-bold" }, "+")
        )
      ),
      React.createElement("div", { className: "bg-green-50 rounded-xl p-4" },
        React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Vous recevez de {target.name}"),
        React.createElement("div", { className: "grid grid-cols-4 gap-2 mb-3" },
          RESOURCES.map(r => React.createElement("button", { key: r.key, onClick: () => setReceiveRes(r.key), className: `p-2 rounded-lg text-center ${receiveRes === r.key ? 'bg-green-600 text-white' : 'bg-white border-2'}` },
            React.createElement("div", { className: "text-xl" }, r.emoji),
            React.createElement("div", { className: "text-xs" }, target[r.key] || 0)
          ))
        ),
        receiveRes && React.createElement("div", { className: "flex items-center justify-center gap-4" },
          React.createElement("button", { onClick: () => setReceiveAmt(Math.max(1, receiveAmt - 1)), className: "w-10 h-10 bg-gray-200 rounded-full font-bold" }, "-"),
          React.createElement("span", { className: "text-2xl font-bold" }, receiveAmt),
          React.createElement("button", { onClick: () => setReceiveAmt(Math.min(target[receiveRes] || 0, receiveAmt + 1)), className: "w-10 h-10 bg-gray-200 rounded-full font-bold" }, "+")
        )
      ),
      React.createElement("div", { className: `p-3 rounded-lg text-center ${isBalanced ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}` },
        isBalanced ? "âœ… Ã‰change Ã©quilibrÃ©" : `âš ï¸ DÃ©sÃ©quilibrÃ©: ${giveValue} vs ${receiveValue}`
      ),
      React.createElement("button", { onClick: executeExchange, disabled: !canExchange || !isMyTurn, className: `w-full py-3 rounded-xl font-bold ${canExchange ? 'bg-purple-600 text-white' : 'bg-gray-300 text-gray-500'}` }, "Confirmer l'Ã©change")
    )
  );
}

// ============================================================================
// ONGLET PERSONNAGE
// ============================================================================
function PersonnageTab({ player, updateMe }) {
  const adjustPv = async (delta) => await updateMe({ pvCurrent: Math.max(0, Math.min(player.character.pvMax, player.pvCurrent + delta)) });
  const adjustResource = async (key, delta) => await updateMe({ [key]: Math.max(0, (player[key] || 0) + delta) });

  const removeEffect = async (id) => {
    const newEffects = (player.effects || []).filter(e => e.id !== id);
    await updateMe({ effects: newEffects });
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("div", { className: "text-center" },
      React.createElement("div", { className: "text-5xl mb-2" }, player.character?.emoji),
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, player.character?.name),
      React.createElement("p", { className: "text-gray-600" }, player.character?.role)
    ),
    React.createElement("div", { className: "bg-red-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "â¤ï¸ Points de Vie"),
      React.createElement("div", { className: "text-center text-3xl font-bold text-red-600 mb-3" }, `${player.pvCurrent} / ${player.character?.pvMax}`),
      React.createElement("div", { className: "flex gap-2 justify-center" },
        React.createElement("button", { onClick: () => adjustPv(-1), className: "px-4 py-2 bg-red-200 rounded-lg font-bold" }, "-1"),
        React.createElement("button", { onClick: () => updateMe({ pvCurrent: player.character.pvMax }), className: "px-4 py-2 bg-green-200 rounded-lg font-bold" }, "Max"),
        React.createElement("button", { onClick: () => adjustPv(1), className: "px-4 py-2 bg-green-200 rounded-lg font-bold" }, "+1")
      )
    ),
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ“Š Statistiques"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        Object.entries(STAT_NAMES).map(([k, n]) => {
          const base = player.stats?.[k] || 0;
          const bonus = (player.effects || []).filter(e => e.stat === k).reduce((s, e) => s + e.delta, 0);
          return React.createElement("div", { key: k, className: "bg-white rounded-lg p-3 text-center" },
            React.createElement("div", { className: "text-xs text-gray-500" }, n),
            React.createElement("div", { className: "text-xl font-bold" }, base >= 0 ? `+${base}` : base, bonus !== 0 && React.createElement("span", { className: `text-sm ml-1 ${bonus > 0 ? 'text-green-600' : 'text-red-600'}` }, bonus > 0 ? `+${bonus}` : bonus))
          );
        })
      )
    ),
    React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’Ž Ressources"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        [{ k: 'or', e: 'ðŸ’°' }, { k: 'cuivre', e: 'ðŸŒ³' }, { k: 'argent', e: 'ðŸœï¸' }, { k: 'obsidienne', e: 'â›°ï¸' }].map(r => React.createElement("div", { key: r.k, className: "bg-white rounded-lg p-3 text-center" },
          React.createElement("div", { className: "text-xl" }, r.e),
          React.createElement("div", { className: "text-xl font-bold" }, player[r.k] || 0),
          React.createElement("div", { className: "flex gap-1 justify-center mt-1" },
            React.createElement("button", { onClick: () => adjustResource(r.k, -1), className: "px-2 py-1 bg-gray-200 rounded text-sm" }, "-"),
            React.createElement("button", { onClick: () => adjustResource(r.k, 1), className: "px-2 py-1 bg-gray-200 rounded text-sm" }, "+")
          )
        ))
      )
    ),
    (player.effects || []).length > 0 && React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’« Ã‰tats actifs"),
      React.createElement("div", { className: "space-y-2" },
        (player.effects || []).map(e => React.createElement("div", { key: e.id, className: `flex justify-between items-center p-3 rounded-lg ${e.type === 'BLESS' ? 'bg-green-100' : 'bg-red-100'}` },
          React.createElement("span", null, `${e.type === 'BLESS' ? 'âœ¨' : 'ðŸ’€'} ${e.name} (${e.delta >= 0 ? '+' : ''}${e.delta})`),
          React.createElement("button", { onClick: () => removeEffect(e.id), className: "px-2 py-1 bg-red-500 text-white rounded text-sm" }, "âœ•")
        ))
      )
    ),
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "âš”ï¸ CompÃ©tences"),
      React.createElement("div", { className: "space-y-2" },
        (player.skills || []).map((s, i) => React.createElement("div", { key: s.id, className: "bg-white rounded-lg p-3 flex items-start gap-2" },
          React.createElement("span", { className: "text-xl" }, i === 0 ? 'ðŸ”®' : i === 1 ? 'âš”ï¸' : 'ðŸ›¡ï¸'),
          React.createElement("p", { className: "text-sm text-gray-700" }, s.description)
        ))
      )
    )
  );
}

// ============================================================================
// ONGLET PDV
// ============================================================================
function PdvTab({ player, players }) {
  const history = player.pdvHistory || [];
  const ranking = [...players].sort((a, b) => (b.pdv || 0) - (a.pdv || 0));
  const totalPdv = players.reduce((s, p) => s + (p.pdv || 0), 0);
  const targetPdv = players.length * 10;

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("div", { className: "text-center" },
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, "ðŸ† Points de Victoire"),
      React.createElement("div", { className: "text-5xl font-bold text-yellow-500 my-4" }, player.pdv || 0),
      React.createElement("div", { className: "bg-purple-100 rounded-lg p-3" },
        React.createElement("div", { className: "text-sm text-purple-700 font-bold" }, `Total: ${totalPdv} / ${targetPdv} PDV`),
        React.createElement("div", { className: "w-full bg-purple-200 rounded-full h-3 mt-2" },
          React.createElement("div", { className: "bg-purple-600 h-3 rounded-full", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        )
      )
    ),
    React.createElement("div", { className: "bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-4 text-white" },
      React.createElement("h4", { className: "font-bold mb-3" }, "ðŸ… Classement"),
      React.createElement("div", { className: "space-y-2" },
        ranking.map((p, i) => React.createElement("div", { key: p.oderId || i, className: `flex items-center gap-3 p-2 rounded-lg ${p.oderId === player.oderId ? 'bg-white bg-opacity-20' : ''}` },
          React.createElement("span", { className: `text-lg font-bold ${i === 0 ? 'text-yellow-300' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-300' : ''}` }, `#${i + 1}`),
          React.createElement("span", { className: "text-xl" }, p.character?.emoji),
          React.createElement("span", { className: "flex-1" }, p.name),
          React.createElement("span", { className: "font-bold text-xl" }, p.pdv || 0)
        ))
      )
    ),
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-800 mb-3" }, "ðŸ“Š RÃ©partition"),
      React.createElement("div", { className: "grid grid-cols-3 gap-3" },
        Object.entries(PDV_SOURCES).slice(0, 6).map(([k, info]) => {
          const total = history.filter(h => h.source === k).reduce((s, h) => s + h.amount, 0);
          return React.createElement("div", { key: k, className: "bg-white rounded-lg p-3 text-center shadow" },
            React.createElement("div", { className: "text-2xl" }, info.emoji),
            React.createElement("div", { className: `text-xl font-bold ${info.color}` }, total),
            React.createElement("div", { className: "text-xs text-gray-500" }, info.label)
          );
        })
      )
    ),
    history.length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `ðŸ“œ Historique (${history.length})`),
      React.createElement("div", { className: "space-y-2 max-h-48 overflow-y-auto" },
        [...history].reverse().map(e => {
          const info = PDV_SOURCES[e.source] || PDV_SOURCES.BONUS;
          return React.createElement("div", { key: e.id, className: "flex items-center gap-3 bg-gray-50 rounded-lg p-2" },
            React.createElement("span", { className: "text-xl" }, info.emoji),
            React.createElement("span", { className: `font-bold ${info.color}` }, `+${e.amount}`),
            React.createElement("span", { className: "text-gray-600 text-sm" }, info.label)
          );
        })
      )
    )
  );
}

// ============================================================================
// RENDER
// ============================================================================
createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>

// ============================================================================
// LOBBY SCREEN
// ============================================================================
function LobbyScreen({ gameId, game, user, setScreen, notify }) {
  if (!game) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" }, React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" }));

  const players = Object.values(game.players || {});
  const me = players.find(p => p.oderId === user?.uid);
  const isHost = me?.isHost;
  const takenChars = players.map(p => p.charKey).filter(Boolean);
  const allReady = players.length >= 2 && players.every(p => p.charKey && p.stats);

  const selectChar = async (ck) => {
    if (takenChars.includes(ck) && me?.charKey !== ck) return;
    if (database) await database.ref(`games/${gameId}/players/${user.uid}/charKey`).set(ck);
  };

  const startGame = async () => {
    if (!isHost || !allReady) return;
    const init = {};
    const order = [];
    Object.entries(game.players).forEach(([uid, p], i) => {
      const ch = CHARACTERS[p.charKey];
      order.push(uid);
      init[uid] = {
        ...p, index: i, character: ch, characterKey: p.charKey,
        pvCurrent: ch.pvMax, or: rulesEngine.getStartGold(p.charKey),
        cuivre: 0, argent: 0, obsidienne: 0, pdv: 0, pdvHistory: [],
        territories: [], defeatedBosses: [], effects: [], quests: [],
        skills: ch.skills.map((s, idx) => ({ id: `skill_${idx}`, description: s })),
        usedAttackDice: false, rerollAvailable: true,
        blessAvailable: p.charKey === 'VICAIRE', curseAvailable: p.charKey === 'HERETIQUE'
      };
    });
    if (database) await database.ref(`games/${gameId}`).update({ status: "playing", players: init, turnOrder: order, currentTurn: 0, targetPdv: order.length * 10 });
  };

  const copyCode = () => { navigator.clipboard?.writeText(gameId); notify("Code copiÃ© !", "success"); };

  return React.createElement("div", { className: "min-h-screen p-4" },
    React.createElement("div", { className: "max-w-2xl mx-auto" },
      // Code
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "text-center text-gray-600 text-sm mb-2" }, "Code de la partie"),
        React.createElement("div", { className: "text-4xl font-bold text-center text-purple-600 tracking-widest cursor-pointer hover:text-purple-700 py-4 bg-purple-50 rounded-xl border-2 border-dashed border-purple-300", onClick: copyCode }, gameId),
        React.createElement("p", { className: "text-center text-gray-500 text-xs mt-2" }, "Cliquez pour copier")
      ),
      // Joueurs
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, `Joueurs (${players.length}/6)`),
        players.map(p => {
          const isMe = p.oderId === user?.uid;
          return React.createElement("div", { key: p.oderId, className: `flex items-center gap-3 p-3 rounded-xl mb-2 ${isMe ? 'bg-purple-50 border-2 border-purple-400' : 'bg-gray-50'}` },
            React.createElement("div", { className: "w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center text-2xl" }, p.charKey ? CHARACTERS[p.charKey].emoji : "ðŸ‘¤"),
            React.createElement("div", { className: "flex-1" },
              React.createElement("div", { className: "font-semibold flex items-center gap-2" }, p.name, p.isHost && React.createElement("span", { className: "text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full" }, "HÃ´te"), isMe && React.createElement("span", { className: "text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full" }, "Vous")),
              React.createElement("div", { className: "text-sm text-gray-600" }, p.charKey ? CHARACTERS[p.charKey].name : "Choisit...")
            ),
            p.charKey && p.stats && React.createElement("span", { className: "text-green-600 font-bold text-xl" }, "âœ“")
          );
        })
      ),
      // SÃ©lection personnage
      !me?.charKey && React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, "Choisissez votre personnage"),
        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
          Object.values(CHARACTERS).map(ch => {
            const taken = takenChars.includes(ch.key);
            return React.createElement("div", { key: ch.key, onClick: () => !taken && selectChar(ch.key), className: `p-4 rounded-xl border-2 cursor-pointer transition-all ${taken ? 'opacity-40 cursor-not-allowed' : 'hover:border-purple-400 hover:bg-purple-50'}` },
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("span", { className: "text-3xl" }, ch.emoji),
                React.createElement("div", { className: "flex-1" },
                  React.createElement("div", { className: "font-bold" }, ch.name),
                  React.createElement("div", { className: "text-xs text-gray-600" }, ch.role),
                  React.createElement("div", { className: "text-sm text-purple-600 font-semibold" }, `â¤ï¸ ${ch.pvMax} PV`)
                ),
                taken && React.createElement("span", { className: "text-xs bg-red-500 text-white px-2 py-1 rounded" }, "PRIS")
              )
            );
          })
        )
      ),
      // Stats
      me?.charKey && !me?.stats && React.createElement(StatsAlloc, { gameId, userId: user?.uid, character: CHARACTERS[me.charKey], notify }),
      // Bouton start
      isHost && React.createElement("button", { className: `w-full py-4 rounded-xl font-bold text-lg ${allReady ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`, onClick: startGame, disabled: !allReady }, allReady ? "ðŸš€ Lancer la partie !" : `En attente (${players.filter(p => p.charKey && p.stats).length}/${players.length})`)
    )
  );
}

// ============================================================================
// STATS ALLOCATION
// ============================================================================
function StatsAlloc({ gameId, userId, character, notify }) {
  const MODIFIERS = [-2, -1, 0, 0, 1, 2];
  const [allocation, setAllocation] = useState({ endurance: null, force: null, vitesse: null, perception: null, sagesse: null, intelligence: null });

  const isModifierUsed = (modifier) => {
    const usedCount = Object.values(allocation).filter(v => v === modifier).length;
    const totalCount = MODIFIERS.filter(m => m === modifier).length;
    return usedCount >= totalCount;
  };

  const handleModifierClick = (stat, modifier) => {
    if (allocation[stat] === modifier) setAllocation({ ...allocation, [stat]: null });
    else if (!isModifierUsed(modifier) || allocation[stat] !== null) setAllocation({ ...allocation, [stat]: modifier });
  };

  const isValid = Object.values(allocation).every(v => v !== null);

  const confirmStats = async () => {
    if (!isValid) return;
    if (database) await database.ref(`games/${gameId}/players/${userId}/stats`).set(allocation);
    notify("Stats enregistrÃ©es !", "success");
  };

  return React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
    React.createElement("h3", { className: "font-bold text-gray-800 mb-2" }, "RÃ©partissez vos statistiques"),
    React.createElement("p", { className: "text-gray-600 text-sm mb-4" }, "Assignez: -2, -1, 0, 0, +1, +2"),
    React.createElement("div", { className: "space-y-4" },
      Object.entries(STAT_NAMES).map(([key, name]) => {
        const val = allocation[key];
        return React.createElement("div", { key, className: "bg-gray-50 rounded-lg p-3" },
          React.createElement("div", { className: "flex justify-between items-center mb-2" },
            React.createElement("span", { className: "font-semibold" }, name),
            val !== null && React.createElement("span", { className: `font-bold ${val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-blue-600'}` }, val > 0 ? `+${val}` : val)
          ),
          React.createElement("div", { className: "flex gap-2 justify-center" },
            MODIFIERS.map((mod, idx) => {
              const isSelected = val === mod;
              const isDisabled = !isSelected && isModifierUsed(mod);
              return React.createElement("button", { key: idx, onClick: () => handleModifierClick(key, mod), disabled: isDisabled, className: `w-12 h-12 rounded-full font-bold text-sm ${isSelected ? mod >= 0 ? 'bg-green-600 text-white ring-4 ring-green-300' : 'bg-red-600 text-white ring-4 ring-red-300' : isDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white border-2 border-gray-300 hover:border-purple-500'}` }, mod > 0 ? `+${mod}` : mod);
            })
          )
        );
      })
    ),
    React.createElement("button", { className: `w-full py-3 rounded-xl font-bold mt-4 ${isValid ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`, onClick: confirmStats, disabled: !isValid }, isValid ? "âœ“ Confirmer" : "ComplÃ©tez tout")
  );
}

// ============================================================================
// GAME SCREEN
// ============================================================================
function GameScreen({ gameId, game, user, notify }) {
  const [activeTab, setActiveTab] = useState('tirages');
  const [showDeath, setShowDeath] = useState(false);
  const [showStart, setShowStart] = useState(false);
  const [startGains, setStartGains] = useState({});

  if (!game?.players || !game.turnOrder) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" }, React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" }));

  const order = game.turnOrder;
  const curIdx = game.currentTurn || 0;
  const curUid = order[curIdx];
  const curPlayer = game.players[curUid];
  const me = game.players[user?.uid];
  const isMyTurn = curUid === user?.uid;

  const players = order.map(uid => game.players[uid]).filter(Boolean);
  const totalPdv = players.reduce((s, p) => s + (p.pdv || 0), 0);
  const targetPdv = game.targetPdv || players.length * 10;

  const updateMe = async (updates) => {
    if (database) await database.ref(`games/${gameId}/players/${user.uid}`).update(updates);
  };

  const updateGame = async (updates) => {
    if (database) await database.ref(`games/${gameId}`).update(updates);
  };

  const addPdv = async (amount, source) => {
    const newPdv = (me.pdv || 0) + amount;
    const newHistory = [...(me.pdvHistory || []), { id: Date.now(), amount, source }];
    await updateMe({ pdv: newPdv, pdvHistory: newHistory });
  };

  const nextTurn = async () => {
    if (!isMyTurn) return;
    const next = (curIdx + 1) % order.length;
    if (database) {
      await database.ref(`games/${gameId}/players/${user.uid}`).update({ usedAttackDice: false, rerollAvailable: true });
      await database.ref(`games/${gameId}/currentTurn`).set(next);
    }
    notify("Tour passÃ© !", "success");
  };

  const handlePassStart = () => {
    const bonus = rulesEngine.getPassBonus(me);
    const tc = countTerritoriesByBiome(me.territories);
    setStartGains({ or: bonus.or || 0, cuivre: tc.FORET, argent: tc.DESERT, obsidienne: tc.MONTAGNE });
    setShowStart(true);
  };

  const confirmStart = async () => {
    const bonus = rulesEngine.getPassBonus(me);
    const tc = countTerritoriesByBiome(me.territories);
    await updateMe({
      or: (me.or || 0) + (bonus.or || 0),
      cuivre: (me.cuivre || 0) + tc.FORET,
      argent: (me.argent || 0) + tc.DESERT,
      obsidienne: (me.obsidienne || 0) + tc.MONTAGNE,
      blessAvailable: me.characterKey === 'VICAIRE',
      curseAvailable: me.characterKey === 'HERETIQUE'
    });
    await addPdv(1, 'START');
    setShowStart(false);
  };

  // Check death
  useEffect(() => {
    if (me && me.pvCurrent <= 0 && !showDeath) setShowDeath(true);
  }, [me?.pvCurrent]);

  const handleDeath = async () => {
    await updateMe({ pvCurrent: me.character.pvMax, effects: [] });
    setShowDeath(false);
  };

  const tabs = [
    { id: "tirages", label: "Tirages" },
    { id: "de", label: "DÃ©" },
    { id: "attaque", label: "Attaque" },
    { id: "objectif", label: "Objectif" },
    { id: "echange", label: "Ã‰change" },
    { id: "personnage", label: "Perso" },
    { id: "pdv", label: "PDV" }
  ];

  // Death overlay
  if (showDeath) return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" },
    React.createElement("div", { className: "bg-gradient-to-br from-red-800 to-gray-900 rounded-2xl p-8 max-w-sm w-full text-white text-center" },
      React.createElement("div", { className: "text-6xl mb-4" }, "ðŸ’€"),
      React.createElement("h2", { className: "text-3xl font-bold mb-4" }, "MORT !"),
      React.createElement("p", { className: "mb-6" }, "PV restaurÃ©s, Ã©tats retirÃ©s"),
      React.createElement("button", { onClick: handleDeath, className: "px-8 py-3 bg-red-600 text-white rounded-xl font-bold" }, "Ressusciter")
    )
  );

  // Start overlay
  if (showStart) return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" },
    React.createElement("div", { className: "bg-gradient-to-br from-teal-600 to-blue-700 rounded-2xl p-8 max-w-sm w-full text-white text-center" },
      React.createElement("div", { className: "text-6xl mb-4" }, "ðŸ"),
      React.createElement("h2", { className: "text-3xl font-bold mb-4" }, "PASSAGE DÃ‰PART !"),
      React.createElement("div", { className: "bg-white bg-opacity-20 rounded-xl p-4 mb-6 space-y-2" },
        React.createElement("div", null, "ðŸ† +1 PDV"),
        startGains.or > 0 && React.createElement("div", null, `ðŸ’° +${startGains.or} Or`),
        startGains.cuivre > 0 && React.createElement("div", null, `ðŸŒ³ +${startGains.cuivre} Cuivre`),
        startGains.argent > 0 && React.createElement("div", null, `ðŸœï¸ +${startGains.argent} Argent`),
        startGains.obsidienne > 0 && React.createElement("div", null, `â›°ï¸ +${startGains.obsidienne} Obsidienne`),
        React.createElement("div", { className: "text-sm" }, "âœ¨ Pouvoirs rechargÃ©s")
      ),
      React.createElement("button", { onClick: confirmStart, className: "px-8 py-3 bg-white text-teal-700 rounded-xl font-bold" }, "Continuer")
    )
  );

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 flex flex-col pb-24" },
    // Header
    React.createElement("div", { className: `p-4 text-white ${isMyTurn ? 'bg-gradient-to-r from-green-600 to-teal-600' : 'bg-gradient-to-r from-orange-500 to-red-500'}` },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "text-sm font-bold mb-1" }, isMyTurn ? "ðŸŽ¯ C'EST VOTRE TOUR !" : `â³ Tour de ${curPlayer?.name || '?'}`),
        React.createElement("div", { className: "flex justify-between items-center" },
          React.createElement("div", null,
            React.createElement("div", { className: "text-xl font-bold" }, me?.name),
            React.createElement("div", { className: "text-sm opacity-90" }, me?.character?.name)
          ),
          React.createElement("div", { className: "text-right" },
            React.createElement("div", { className: "text-2xl font-bold" }, `${me?.pvCurrent || 0}/${me?.character?.pvMax || 0}`),
            React.createElement("div", { className: "text-xs" }, "PV")
          )
        ),
        React.createElement("div", { className: "flex gap-2 mt-2 text-xs flex-wrap" },
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸ’° ${me?.or || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸŒ³ ${me?.cuivre || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸœï¸ ${me?.argent || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `â›°ï¸ ${me?.obsidienne || 0}`),
          React.createElement("span", { className: "bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold" }, `ðŸ† ${me?.pdv || 0}`)
        )
      )
    ),
    // Progress
    React.createElement("div", { className: "bg-white shadow px-4 py-2" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "flex justify-between text-xs text-gray-600 mb-1" },
          React.createElement("span", null, "Progression"),
          React.createElement("span", null, `${totalPdv} / ${targetPdv} PDV`)
        ),
        React.createElement("div", { className: "h-2 bg-gray-200 rounded-full overflow-hidden" },
          React.createElement("div", { className: "h-full bg-gradient-to-r from-purple-600 to-blue-600 rounded-full", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        )
      )
    ),
    // Tabs
    React.createElement("div", { className: "bg-white shadow-md overflow-x-auto" },
      React.createElement("div", { className: "flex max-w-4xl mx-auto" },
        tabs.map(t => React.createElement("button", { key: t.id, onClick: () => setActiveTab(t.id), className: `flex-shrink-0 px-4 py-3 font-semibold text-xs border-b-4 ${activeTab === t.id ? 'bg-purple-600 text-white border-purple-800' : 'bg-gray-100 text-gray-600 border-transparent hover:bg-gray-200'}` }, t.label))
      )
    ),
    // Content
    React.createElement("div", { className: "flex-1 overflow-y-auto p-4" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6" },
          activeTab === 'tirages' && React.createElement(TiragesTab, { player: me, isMyTurn, updateMe, notify, game, gameId, updateGame }),
          activeTab === 'de' && React.createElement(DeTab, { player: me, isMyTurn, updateMe, notify }),
          activeTab === 'attaque' && React.createElement(AttaqueTab, { player: me, isMyTurn, updateMe, notify, addPdv, players, game, gameId }),
          activeTab === 'objectif' && React.createElement(ObjectifTab, { player: me, isMyTurn, updateMe, notify, addPdv, game, gameId, updateGame }),
          activeTab === 'echange' && React.createElement(EchangeTab, { player: me, isMyTurn, updateMe, notify, players, game, gameId }),
          activeTab === 'personnage' && React.createElement(PersonnageTab, { player: me, updateMe, handlePassStart, isMyTurn }),
          activeTab === 'pdv' && React.createElement(PdvTab, { player: me, players })
        )
      )
    ),
    // End turn button
    isMyTurn && React.createElement("div", { className: "fixed bottom-0 left-0 right-0 p-4 bg-white shadow-lg border-t" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-bold text-lg", onClick: nextTurn }, "âœ… Fin de mon tour")
      )
    )
  );
}

// ============================================================================
// ONGLET TIRAGES
// ============================================================================
function TiragesTab({ player, isMyTurn, updateMe, notify, game, gameId, updateGame }) {
  const [anomCard, setAnomCard] = useState(null);
  const [questCard, setQuestCard] = useState(null);
  const [applied, setApplied] = useState(null);

  const drawAnomaly = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const available = ANOMALIES.filter((_, i) => !(game.drawnAnomalies || []).includes(i));
    if (available.length === 0) return notify("Deck vide !", "error");
    
    const idx = Math.floor(Math.random() * available.length);
    const card = available[idx];
    const origIdx = ANOMALIES.indexOf(card);
    
    await updateGame({ drawnAnomalies: [...(game.drawnAnomalies || []), origIdx] });
    setAnomCard(card);
    
    const effect = parseAnomaly(card);
    let msg = "";
    if (effect.type === 'heal') {
      await updateMe({ pvCurrent: Math.min(player.character.pvMax, player.pvCurrent + effect.amount) });
      msg = `+${effect.amount} PV`;
    } else if (effect.type === 'damage') {
      await updateMe({ pvCurrent: Math.max(0, player.pvCurrent - effect.amount) });
      msg = `-${effect.amount} PV`;
    } else if (effect.type === 'bless') {
      const newEffects = [...(player.effects || []), { id: Date.now(), type: 'BLESS', stat: effect.stat, delta: 2, name: `BÃ©nÃ©diction ${STAT_NAMES[effect.stat]}` }];
      await updateMe({ effects: newEffects });
      msg = `BÃ©nÃ©diction ${STAT_NAMES[effect.stat]} (+2)`;
    } else if (effect.type === 'curse') {
      const newEffects = [...(player.effects || []), { id: Date.now(), type: 'CURSE', stat: effect.stat, delta: -2, name: `MalÃ©diction ${STAT_NAMES[effect.stat]}` }];
      await updateMe({ effects: newEffects });
      msg = `MalÃ©diction ${STAT_NAMES[effect.stat]} (-2)`;
    } else if (effect.type === 'gain') {
      await updateMe({ [effect.resource]: (player[effect.resource] || 0) + effect.amount });
      msg = `+${effect.amount} ${effect.resource}`;
    } else if (effect.type === 'lose') {
      await updateMe({ [effect.resource]: Math.max(0, (player[effect.resource] || 0) - effect.amount) });
      msg = `-${effect.amount} ${effect.resource}`;
    } else if (effect.type === 'recharge') {
      await updateMe({ blessAvailable: player.characterKey === 'VICAIRE', curseAvailable: player.characterKey === 'HERETIQUE' });
      msg = "Pouvoirs rechargÃ©s !";
    }
    setApplied(msg);
  };

  const drawQuest = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if ((player.quests || []).length >= 2) return notify("Max 2 quÃªtes !", "error");
    
    const available = QUETES.filter((_, i) => !(game.drawnQuetes || []).includes(i));
    if (available.length === 0) return notify("Deck vide !", "error");
    
    const idx = Math.floor(Math.random() * available.length);
    const card = available[idx];
    const origIdx = QUETES.indexOf(card);
    
    await updateGame({ drawnQuetes: [...(game.drawnQuetes || []), origIdx] });
    setQuestCard(card);
    
    const newQuests = [...(player.quests || []), { id: Date.now(), text: card, completed: false }];
    await updateMe({ quests: newQuests });
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ´ Tirages"),
    React.createElement("div", { className: "text-center text-sm text-gray-600" }, 
      `Anomalies: ${ANOMALIES.length - (game.drawnAnomalies || []).length}/${ANOMALIES.length} | QuÃªtes: ${QUETES.length - (game.drawnQuetes || []).length}/${QUETES.length}`
    ),
    // Anomalie
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "Anomalie"),
      React.createElement("div", { className: "min-h-32 bg-gradient-to-r from-purple-600 to-purple-800 rounded-xl p-6 flex items-center justify-center text-white mb-3" },
        anomCard ? React.createElement("div", { className: "text-center" },
          React.createElement("p", { className: "font-medium" }, anomCard),
          applied && React.createElement("p", { className: "text-yellow-300 font-bold mt-2" }, `âœ¨ ${applied}`)
        ) : React.createElement("p", { className: "text-purple-200 italic" }, "Tirez une carte...")
      ),
      React.createElement("button", { onClick: drawAnomaly, disabled: !isMyTurn, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 disabled:opacity-50" }, "ðŸ”® Tirer une Anomalie")
    ),
    // QuÃªte
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `QuÃªte (${(player.quests || []).length}/2)`),
      React.createElement("div", { className: "min-h-32 bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-6 flex items-center justify-center text-white mb-3" },
        questCard ? React.createElement("p", { className: "font-medium text-center" }, questCard) : React.createElement("p", { className: "text-green-200 italic" }, "Tirez une quÃªte...")
      ),
      React.createElement("button", { onClick: drawQuest, disabled: !isMyTurn || (player.quests || []).length >= 2, className: "w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50" }, (player.quests || []).length >= 2 ? "Maximum atteint" : "ðŸ“œ Tirer une QuÃªte")
    ),
    // QuÃªtes actives
    (player.quests || []).length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "Mes quÃªtes"),
      React.createElement("div", { className: "space-y-2" },
        (player.quests || []).map(q => React.createElement("div", { key: q.id, className: "bg-gray-50 rounded-lg p-3 text-sm" }, q.text))
      )
    )
  );
}

// ============================================================================
// ONGLET DÃ‰
// ============================================================================
function DeTab({ player, isMyTurn, updateMe, notify }) {
  const [moveResult, setMoveResult] = useState(null);
  const [attackResult, setAttackResult] = useState(null);
  const [rolling, setRolling] = useState(false);
  const [showReroll, setShowReroll] = useState(false);
  const [sacrifice, setSacrifice] = useState(0);
  const [showSacrifice, setShowSacrifice] = useState(false);

  const canSac = rulesEngine.canSacrificePv(player);
  const canReroll = rulesEngine.canReroll(player);

  const rollMove = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    setRolling(true);
    setTimeout(() => {
      setMoveResult(Math.floor(Math.random() * 10) + 1);
      setRolling(false);
    }, 500);
  };

  const startAttack = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (player.usedAttackDice) return notify("DÃ©jÃ  utilisÃ© ce tour", "error");
    if (canSac && player.pvCurrent > 1) {
      setShowSacrifice(true);
    } else {
      executeAttack(0);
    }
  };

  const executeAttack = async (sac) => {
    setShowSacrifice(false);
    setRolling(true);
    
    setTimeout(async () => {
      const statIdx = Math.floor(Math.random() * STATISTIQUES.length);
      const stat = STATISTIQUES[statIdx];
      const statKey = STAT_MAPPING[stat] || stat.toLowerCase();
      const dice = Math.floor(Math.random() * 10) + 1;
      const base = player.stats?.[statKey] || 0;
      const effects = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
      const total = dice + base + effects + sac;
      const result = { stat, statKey, dice, base, effects, sacrifice: sac, total, crit: dice === 10 };
      setAttackResult(result);
      
      // Apply sacrifice
      if (sac > 0) {
        await updateMe({ pvCurrent: Math.max(1, player.pvCurrent - sac) });
      }
      
      if (canReroll && player.rerollAvailable) {
        setShowReroll(true);
      } else {
        await updateMe({ usedAttackDice: true });
      }
      setRolling(false);
    }, 500);
  };

  const handleReroll = async (accept) => {
    if (accept) {
      const resource = getRandomAvailableResource(player);
      if (!resource) {
        notify("Pas de ressource !", "error");
        await updateMe({ usedAttackDice: true });
        setShowReroll(false);
        return;
      }
      // Nouvelle stat
      const stats = STATISTIQUES.filter(s => (STAT_MAPPING[s] || s.toLowerCase()) !== attackResult.statKey);
      const newStat = stats[Math.floor(Math.random() * stats.length)];
      const newKey = STAT_MAPPING[newStat] || newStat.toLowerCase();
      const base = player.stats?.[newKey] || 0;
      const effects = (player.effects || []).filter(e => e.stat === newKey).reduce((s, e) => s + e.delta, 0);
      const total = attackResult.dice + base + effects + attackResult.sacrifice;
      setAttackResult({ ...attackResult, stat: newStat, statKey: newKey, base, effects, total, rerolled: true });
      await updateMe({ usedAttackDice: true, rerollAvailable: false, [resource]: Math.max(0, (player[resource] || 0) - 1) });
      notify(`Relance ! -1 ${resource}`, "success");
    } else {
      await updateMe({ usedAttackDice: true });
    }
    setShowReroll(false);
  };

  // Sacrifice popup
  if (showSacrifice) return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-xl font-bold text-center text-red-600" }, "ðŸ©¸ Furie Sacrificielle"),
    React.createElement("p", { className: "text-center text-gray-600" }, "Sacrifiez des PV pour +bonus au jet"),
    React.createElement("div", { className: "text-center" },
      React.createElement("div", { className: "text-gray-600 mb-4" }, `PV actuels: ${player.pvCurrent}`),
      React.createElement("div", { className: "flex items-center justify-center gap-4 my-4" },
        React.createElement("button", { onClick: () => setSacrifice(Math.max(0, sacrifice - 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold text-xl" }, "-"),
        React.createElement("span", { className: "text-5xl font-bold text-red-600" }, sacrifice),
        React.createElement("button", { onClick: () => setSacrifice(Math.min(player.pvCurrent - 1, sacrifice + 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold text-xl" }, "+")
      ),
      React.createElement("p", { className: "text-gray-600" }, `Bonus au jet: +${sacrifice}`)
    ),
    React.createElement("div", { className: "grid grid-cols-2 gap-4" },
      React.createElement("button", { onClick: () => { setShowSacrifice(false); setSacrifice(0); }, className: "py-3 bg-gray-600 text-white rounded-lg font-semibold" }, "Annuler"),
      React.createElement("button", { onClick: () => executeAttack(sacrifice), className: "py-3 bg-red-600 text-white rounded-lg font-bold" }, "Confirmer")
    )
  );

  // Reroll popup
  if (showReroll) return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-xl font-bold text-center" }, "ðŸ”„ Relance Vicaire"),
    React.createElement("p", { className: "text-center text-gray-600" }, "Changer la statistique ? (coÃ»t: 1 ressource)"),
    React.createElement("div", { className: "bg-purple-100 rounded-xl p-4 text-center" },
      React.createElement("div", { className: "text-lg font-bold text-purple-600" }, attackResult?.stat),
      React.createElement("div", { className: "text-4xl font-bold" }, attackResult?.total)
    ),
    React.createElement("div", { className: "flex gap-3" },
      React.createElement("button", { onClick: () => handleReroll(true), className: "flex-1 py-3 bg-green-600 text-white rounded-xl font-bold" }, "âœ… Oui"),
      React.createElement("button", { onClick: () => handleReroll(false), className: "flex-1 py-3 bg-gray-400 text-white rounded-xl font-bold" }, "âŒ Non")
    )
  );

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ² LancÃ©s de DÃ©s"),
    // Move
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "DÃ© de DÃ©placement"),
      React.createElement("div", { className: `min-h-32 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 flex flex-col items-center justify-center text-white mb-3 ${rolling ? 'animate-pulse' : ''}` },
        moveResult !== null ? React.createElement(React.Fragment, null,
          React.createElement("div", { className: "text-6xl font-bold" }, moveResult),
          moveResult === 10 && React.createElement("div", { className: "text-yellow-300 font-bold mt-2" }, "âœ¨ Critique !")
        ) : React.createElement("p", { className: "text-blue-200" }, "Lancez le dÃ©")
      ),
      React.createElement("button", { onClick: rollMove, disabled: !isMyTurn || rolling, className: "w-full py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "ðŸŽ² Lancer (1-10)")
    ),
    // Attack
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "DÃ© d'Attaque"),
      player.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-2 mb-3 text-center text-sm text-yellow-800" }, "âš ï¸ DÃ©jÃ  utilisÃ© ce tour"),
      React.createElement("div", { className: `min-h-40 bg-gradient-to-r from-red-600 to-red-800 rounded-xl p-6 flex flex-col items-center justify-center text-white mb-3 ${rolling ? 'animate-pulse' : ''}` },
        attackResult ? React.createElement("div", { className: "text-center w-full" },
          React.createElement("div", { className: "text-yellow-300 font-bold text-xl mb-2" }, attackResult.stat, attackResult.rerolled && " ðŸ”„"),
          React.createElement("div", { className: "text-5xl font-bold mb-3" }, attackResult.total),
          attackResult.crit && React.createElement("div", { className: "text-yellow-300 font-bold" }, "âœ¨ Critique !"),
          React.createElement("div", { className: "bg-white bg-opacity-20 rounded-lg p-3 mt-2 text-sm" },
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "DÃ©:"), React.createElement("span", { className: "font-bold" }, attackResult.dice)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Base:"), React.createElement("span", { className: "font-bold" }, attackResult.base >= 0 ? `+${attackResult.base}` : attackResult.base)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Ã‰tats:"), React.createElement("span", { className: `font-bold ${attackResult.effects >= 0 ? 'text-green-300' : 'text-red-300'}` }, attackResult.effects >= 0 ? `+${attackResult.effects}` : attackResult.effects)),
            attackResult.sacrifice > 0 && React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Sacrifice:"), React.createElement("span", { className: "font-bold text-red-300" }, `+${attackResult.sacrifice}`))
          )
        ) : React.createElement("p", { className: "text-red-200" }, "Lancez le dÃ©")
      ),
      React.createElement("button", { onClick: startAttack, disabled: !isMyTurn || rolling || player.usedAttackDice, className: "w-full py-3 bg-red-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "âš”ï¸ Lancer Attaque")
    )
  );
}

// ============================================================================
// LOBBY SCREEN
// ============================================================================
function LobbyScreen({ gameId, game, user, setScreen, notify }) {
  if (!game) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" }, React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" }));

  const players = Object.values(game.players || {});
  const me = players.find(p => p.oderId === user?.uid);
  const isHost = me?.isHost;
  const takenChars = players.map(p => p.charKey).filter(Boolean);
  const allReady = players.length >= 2 && players.every(p => p.charKey && p.stats);

  const selectChar = async (ck) => {
    if (takenChars.includes(ck) && me?.charKey !== ck) return;
    if (database) await database.ref(`games/${gameId}/players/${user.uid}/charKey`).set(ck);
  };

  const startGame = async () => {
    if (!isHost || !allReady) return;
    const init = {};
    const order = [];
    Object.entries(game.players).forEach(([uid, p], i) => {
      const ch = CHARACTERS[p.charKey];
      order.push(uid);
      init[uid] = {
        ...p, index: i, character: ch, characterKey: p.charKey,
        pvCurrent: ch.pvMax, or: rulesEngine.getStartGold(p.charKey),
        cuivre: 0, argent: 0, obsidienne: 0, pdv: 0, pdvHistory: [],
        territories: [], defeatedBosses: [], effects: [], quests: [],
        skills: ch.skills.map((s, idx) => ({ id: `skill_${idx}`, description: s })),
        usedAttackDice: false, rerollAvailable: true,
        blessAvailable: p.charKey === 'VICAIRE', curseAvailable: p.charKey === 'HERETIQUE'
      };
    });
    if (database) await database.ref(`games/${gameId}`).update({ status: "playing", players: init, turnOrder: order, currentTurn: 0, targetPdv: order.length * 10 });
  };

  const copyCode = () => { navigator.clipboard?.writeText(gameId); notify("Code copiÃ© !", "success"); };

  return React.createElement("div", { className: "min-h-screen p-4" },
    React.createElement("div", { className: "max-w-2xl mx-auto" },
      // Code
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "text-center text-gray-600 text-sm mb-2" }, "Code de la partie"),
        React.createElement("div", { className: "text-4xl font-bold text-center text-purple-600 tracking-widest cursor-pointer hover:text-purple-700 py-4 bg-purple-50 rounded-xl border-2 border-dashed border-purple-300", onClick: copyCode }, gameId),
        React.createElement("p", { className: "text-center text-gray-500 text-xs mt-2" }, "Cliquez pour copier")
      ),
      // Joueurs
      React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, `Joueurs (${players.length}/6)`),
        players.map(p => {
          const isMe = p.oderId === user?.uid;
          return React.createElement("div", { key: p.oderId, className: `flex items-center gap-3 p-3 rounded-xl mb-2 ${isMe ? 'bg-purple-50 border-2 border-purple-400' : 'bg-gray-50'} ${p.charKey && p.stats ? 'border-green-400' : ''}` },
            React.createElement("div", { className: "w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center text-2xl" }, p.charKey ? CHARACTERS[p.charKey].emoji : "ðŸ‘¤"),
            React.createElement("div", { className: "flex-1" },
              React.createElement("div", { className: "font-semibold text-gray-800 flex items-center gap-2" }, p.name, 
                p.isHost && React.createElement("span", { className: "text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full" }, "HÃ´te"),
                isMe && React.createElement("span", { className: "text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full" }, "Vous")
              ),
              React.createElement("div", { className: "text-sm text-gray-600" }, p.charKey ? CHARACTERS[p.charKey].name : "Choisit...")
            ),
            p.charKey && p.stats && React.createElement("span", { className: "text-green-600 font-bold text-xl" }, "âœ“")
          );
        })
      ),
      // SÃ©lection personnage
      !me?.charKey && React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
        React.createElement("h3", { className: "font-bold text-gray-800 mb-4" }, "Choisissez votre personnage"),
        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
          Object.values(CHARACTERS).map(ch => {
            const taken = takenChars.includes(ch.key);
            return React.createElement("div", { key: ch.key, onClick: () => !taken && selectChar(ch.key), className: `p-4 rounded-xl border-2 cursor-pointer transition-all ${taken ? 'opacity-40 cursor-not-allowed' : 'hover:border-purple-400 hover:bg-purple-50'}` },
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("span", { className: "text-3xl" }, ch.emoji),
                React.createElement("div", { className: "flex-1" },
                  React.createElement("div", { className: "font-bold" }, ch.name),
                  React.createElement("div", { className: "text-xs text-gray-600" }, ch.role),
                  React.createElement("div", { className: "text-sm text-purple-600 font-semibold" }, `â¤ï¸ ${ch.pvMax} PV`)
                ),
                taken && React.createElement("span", { className: "text-xs bg-red-500 text-white px-2 py-1 rounded" }, "PRIS")
              )
            );
          })
        )
      ),
      // Stats
      me?.charKey && !me?.stats && React.createElement(StatsAlloc, { gameId, userId: user?.uid, character: CHARACTERS[me.charKey], notify }),
      // Bouton lancer
      isHost && React.createElement("button", { className: `w-full py-4 rounded-xl font-bold text-lg transition-all ${allReady ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`, onClick: startGame, disabled: !allReady }, allReady ? "ðŸš€ Lancer la partie !" : `En attente (${players.filter(p => p.charKey && p.stats).length}/${players.length})`)
    )
  );
}

// ============================================================================
// STATS ALLOCATION
// ============================================================================
function StatsAlloc({ gameId, userId, character, notify }) {
  const MODIFIERS = [-2, -1, 0, 0, 1, 2];
  const [allocation, setAllocation] = useState({ endurance: null, force: null, vitesse: null, perception: null, sagesse: null, intelligence: null });

  const isModifierUsed = (modifier) => {
    const usedCount = Object.values(allocation).filter(v => v === modifier).length;
    const totalCount = MODIFIERS.filter(m => m === modifier).length;
    return usedCount >= totalCount;
  };

  const handleClick = (stat, modifier) => {
    if (allocation[stat] === modifier) setAllocation({ ...allocation, [stat]: null });
    else if (!isModifierUsed(modifier) || allocation[stat] !== null) setAllocation({ ...allocation, [stat]: modifier });
  };

  const isValid = Object.values(allocation).every(v => v !== null);

  const confirmStats = async () => {
    if (!isValid) return;
    if (database) await database.ref(`games/${gameId}/players/${userId}/stats`).set(allocation);
    notify("Stats enregistrÃ©es !", "success");
  };

  return React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6 mb-4" },
    React.createElement("h3", { className: "font-bold text-gray-800 mb-2" }, "RÃ©partissez vos stats"),
    React.createElement("p", { className: "text-gray-600 text-sm mb-4" }, "Assignez: -2, -1, 0, 0, +1, +2"),
    React.createElement("div", { className: "space-y-4" },
      Object.entries(STAT_NAMES).map(([key, name]) => {
        const val = allocation[key];
        return React.createElement("div", { key, className: "bg-gray-50 rounded-lg p-3" },
          React.createElement("div", { className: "flex justify-between items-center mb-2" },
            React.createElement("span", { className: "font-semibold text-gray-700" }, name),
            val !== null && React.createElement("span", { className: `font-bold ${val > 0 ? 'text-green-600' : val < 0 ? 'text-red-600' : 'text-blue-600'}` }, val > 0 ? `+${val}` : val)
          ),
          React.createElement("div", { className: "flex gap-2 justify-center" },
            MODIFIERS.map((mod, idx) => {
              const isSelected = val === mod;
              const isDisabled = !isSelected && isModifierUsed(mod);
              return React.createElement("button", { key: idx, onClick: () => handleClick(key, mod), disabled: isDisabled, className: `w-12 h-12 rounded-full font-bold text-sm transition-all ${isSelected ? mod > 0 ? 'bg-green-600 text-white ring-4 ring-green-300' : mod < 0 ? 'bg-red-600 text-white ring-4 ring-red-300' : 'bg-blue-600 text-white ring-4 ring-blue-300' : isDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white border-2 border-gray-300 hover:border-purple-500'}` }, mod > 0 ? `+${mod}` : mod);
            })
          )
        );
      })
    ),
    React.createElement("button", { className: `w-full py-3 rounded-xl font-bold mt-4 ${isValid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`, onClick: confirmStats, disabled: !isValid }, isValid ? "âœ“ Confirmer" : "ComplÃ©tez tout")
  );
}

// ============================================================================
// GAME SCREEN
// ============================================================================
function GameScreen({ gameId, game, user, notify }) {
  const [activeTab, setActiveTab] = useState('tirages');
  const [showDeath, setShowDeath] = useState(false);
  const [showStart, setShowStart] = useState(false);
  const [startGains, setStartGains] = useState({});

  if (!game?.players || !game.turnOrder) return React.createElement("div", { className: "min-h-screen flex items-center justify-center" }, React.createElement("div", { className: "w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" }));

  const order = game.turnOrder;
  const curIdx = game.currentTurn || 0;
  const curUid = order[curIdx];
  const curPlayer = game.players[curUid];
  const me = game.players[user?.uid];
  const isMyTurn = curUid === user?.uid;
  const players = order.map(uid => game.players[uid]).filter(Boolean);
  const totalPdv = players.reduce((s, p) => s + (p.pdv || 0), 0);
  const targetPdv = game.targetPdv || players.length * 10;

  const updateMe = async (updates) => {
    if (database) await database.ref(`games/${gameId}/players/${user.uid}`).update(updates);
  };

  const updateGame = async (updates) => {
    if (database) await database.ref(`games/${gameId}`).update(updates);
  };

  const addPdv = async (amount, source) => {
    const newPdv = (me.pdv || 0) + amount;
    const newHistory = [...(me.pdvHistory || []), { id: Date.now(), amount, source }];
    await updateMe({ pdv: newPdv, pdvHistory: newHistory });
  };

  const nextTurn = async () => {
    if (!isMyTurn) return;
    const next = (curIdx + 1) % order.length;
    await updateMe({ usedAttackDice: false, rerollAvailable: true });
    await updateGame({ currentTurn: next });
    notify("Tour passÃ© !", "success");
  };

  // Passage dÃ©part
  const handlePassStart = () => {
    const bonus = rulesEngine.getPassBonus(me);
    const tc = countTerritoriesByBiome(me.territories);
    setStartGains({ or: bonus.or || 0, cuivre: tc.FORET, argent: tc.DESERT, obsidienne: tc.MONTAGNE });
    setShowStart(true);
  };

  const confirmStart = async () => {
    const bonus = rulesEngine.getPassBonus(me);
    const tc = countTerritoriesByBiome(me.territories);
    await updateMe({
      or: me.or + (bonus.or || 0),
      cuivre: me.cuivre + tc.FORET,
      argent: me.argent + tc.DESERT,
      obsidienne: me.obsidienne + tc.MONTAGNE,
      blessAvailable: me.characterKey === 'VICAIRE',
      curseAvailable: me.characterKey === 'HERETIQUE'
    });
    await addPdv(1, 'START');
    setShowStart(false);
  };

  // Mort
  useEffect(() => {
    if (me?.pvCurrent === 0 && !showDeath) setShowDeath(true);
  }, [me?.pvCurrent]);

  const handleDeath = async () => {
    await updateMe({ pvCurrent: me.character.pvMax, effects: [] });
    setShowDeath(false);
  };

  // Overlay mort
  if (showDeath) {
    return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" },
      React.createElement("div", { className: "bg-gradient-to-br from-red-800 to-gray-900 rounded-2xl p-8 max-w-md w-full text-white text-center" },
        React.createElement("div", { className: "text-6xl mb-4" }, "ðŸ’€"),
        React.createElement("h2", { className: "text-3xl font-bold mb-4" }, "MORT !"),
        React.createElement("p", { className: "mb-6" }, "Vous Ãªtes tombÃ© au combat !"),
        React.createElement("button", { onClick: handleDeath, className: "px-8 py-3 bg-red-600 rounded-xl font-bold" }, "Ressusciter")
      )
    );
  }

  // Overlay dÃ©part
  if (showStart) {
    return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" },
      React.createElement("div", { className: "bg-gradient-to-br from-teal-600 to-blue-700 rounded-2xl p-8 max-w-md w-full text-white text-center" },
        React.createElement("div", { className: "text-6xl mb-4" }, "ðŸ"),
        React.createElement("h2", { className: "text-3xl font-bold mb-4" }, "PASSAGE DÃ‰PART !"),
        React.createElement("div", { className: "bg-white bg-opacity-20 rounded-xl p-4 mb-6 space-y-2" },
          React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "ðŸ† PDV"), React.createElement("span", { className: "font-bold" }, "+1")),
          startGains.or > 0 && React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "ðŸ’° Or"), React.createElement("span", { className: "font-bold" }, `+${startGains.or}`)),
          startGains.cuivre > 0 && React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "ðŸŒ³ Cuivre"), React.createElement("span", { className: "font-bold" }, `+${startGains.cuivre}`)),
          startGains.argent > 0 && React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "ðŸœï¸ Argent"), React.createElement("span", { className: "font-bold" }, `+${startGains.argent}`)),
          startGains.obsidienne > 0 && React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "â›°ï¸ Obsidienne"), React.createElement("span", { className: "font-bold" }, `+${startGains.obsidienne}`))
        ),
        React.createElement("button", { onClick: confirmStart, className: "px-8 py-3 bg-white text-teal-700 rounded-xl font-bold" }, "Continuer")
      )
    );
  }

  const tabs = [
    { id: "tirages", label: "Tirages" },
    { id: "de", label: "DÃ©" },
    { id: "attaque", label: "Attaque" },
    { id: "objectif", label: "Objectif" },
    { id: "echange", label: "Ã‰change" },
    { id: "personnage", label: "Perso" },
    { id: "pdv", label: "PDV" }
  ];

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-br from-purple-100 to-blue-100 flex flex-col pb-24" },
    // Header
    React.createElement("div", { className: `p-4 text-white ${isMyTurn ? 'bg-gradient-to-r from-green-600 to-teal-600' : 'bg-gradient-to-r from-orange-500 to-red-500'}` },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "text-sm font-bold mb-1" }, isMyTurn ? "ðŸŽ¯ C'EST VOTRE TOUR !" : `â³ Tour de ${curPlayer?.name || '?'}`),
        React.createElement("div", { className: "flex justify-between items-center" },
          React.createElement("div", null,
            React.createElement("div", { className: "text-xl font-bold" }, me?.name),
            React.createElement("div", { className: "text-sm opacity-90" }, me?.character?.name)
          ),
          React.createElement("div", { className: "text-right" },
            React.createElement("div", { className: "text-2xl font-bold" }, `${me?.pvCurrent || 0}/${me?.character?.pvMax || 0}`),
            React.createElement("div", { className: "text-xs" }, "PV")
          )
        ),
        React.createElement("div", { className: "flex gap-2 mt-2 text-xs flex-wrap" },
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸ’° ${me?.or || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸŒ³ ${me?.cuivre || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `ðŸœï¸ ${me?.argent || 0}`),
          React.createElement("span", { className: "bg-white bg-opacity-20 px-2 py-1 rounded" }, `â›°ï¸ ${me?.obsidienne || 0}`),
          React.createElement("span", { className: "bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold" }, `ðŸ† ${me?.pdv || 0}`)
        )
      )
    ),
    // Progression
    React.createElement("div", { className: "bg-white shadow px-4 py-2" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "flex justify-between text-xs text-gray-600 mb-1" },
          React.createElement("span", null, "Progression"),
          React.createElement("span", null, `${totalPdv} / ${targetPdv} PDV`)
        ),
        React.createElement("div", { className: "h-2 bg-gray-200 rounded-full overflow-hidden" },
          React.createElement("div", { className: "h-full bg-gradient-to-r from-purple-600 to-blue-600 rounded-full transition-all", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        )
      )
    ),
    // Tabs
    React.createElement("div", { className: "bg-white shadow-md overflow-x-auto" },
      React.createElement("div", { className: "flex max-w-4xl mx-auto" },
        tabs.map(t => React.createElement("button", { key: t.id, onClick: () => setActiveTab(t.id), className: `flex-shrink-0 px-4 py-3 font-semibold text-sm border-b-4 ${activeTab === t.id ? 'bg-purple-600 text-white border-purple-800' : 'bg-gray-100 text-gray-600 border-transparent hover:bg-gray-200'}` }, t.label))
      )
    ),
    // Contenu
    React.createElement("div", { className: "flex-1 overflow-y-auto p-4" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("div", { className: "bg-white rounded-2xl shadow-lg p-6" },
          activeTab === 'tirages' && React.createElement(TiragesTab, { me, isMyTurn, updateMe, notify, game, updateGame, addPdv }),
          activeTab === 'de' && React.createElement(DeTab, { me, isMyTurn, updateMe, notify }),
          activeTab === 'attaque' && React.createElement(AttaqueTab, { me, isMyTurn, updateMe, notify, game, addPdv, players }),
          activeTab === 'objectif' && React.createElement(ObjectifTab, { me, isMyTurn, updateMe, notify, game, updateGame, addPdv }),
          activeTab === 'echange' && React.createElement(EchangeTab, { me, isMyTurn, updateMe, notify, game, gameId, players }),
          activeTab === 'personnage' && React.createElement(PersonnageTab, { me, updateMe, handlePassStart, isMyTurn }),
          activeTab === 'pdv' && React.createElement(PdvTab, { me, players })
        )
      )
    ),
    // Bouton fin de tour
    isMyTurn && React.createElement("div", { className: "fixed bottom-0 left-0 right-0 p-4 bg-white shadow-lg border-t" },
      React.createElement("div", { className: "max-w-4xl mx-auto" },
        React.createElement("button", { className: "w-full py-4 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-bold text-lg", onClick: nextTurn }, "âœ… Fin de mon tour")
      )
    )
  );
}


// ============================================================================
// ONGLET ATTAQUE
// ============================================================================
function AttaqueTab({ player, isMyTurn, updateMe, notify, addPdv, players, game, gameId }) {
  const [mode, setMode] = useState(null);
  const [selectedBiome, setSelectedBiome] = useState(null);
  const [selectedDiff, setSelectedDiff] = useState(null);
  const [selectedBoss, setSelectedBoss] = useState(null);
  const [result, setResult] = useState(null);

  const attackTerritory = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (player.usedAttackDice) return notify("DÃ© d'attaque dÃ©jÃ  utilisÃ©", "error");
    if (!selectedBiome || !selectedDiff) return notify("SÃ©lectionnez biome et difficultÃ©", "error");
    
    const statKeys = Object.keys(STAT_NAMES);
    const statKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const dice = Math.floor(Math.random() * 10) + 1;
    const base = player.stats?.[statKey] || 0;
    const effects = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const bonus = rulesEngine.getAttackBonus(player, { type: 'TERRITORY', isNeutral: true });
    const total = dice + base + effects + bonus.bonus;
    const success = total >= selectedDiff;
    
    const pdv = selectedDiff === 6 ? 3 : selectedDiff === 8 ? 4 : 5;
    const resource = BIOMES[selectedBiome].resource;
    
    if (success) {
      const newTerritories = [...(player.territories || []), { biome: selectedBiome, difficulty: selectedDiff }];
      await updateMe({ territories: newTerritories, [resource]: (player[resource] || 0) + 1, usedAttackDice: true });
      await addPdv(pdv, 'TERRITORY');
    } else {
      const damage = Math.max(1, selectedDiff - total);
      await updateMe({ pvCurrent: Math.max(0, player.pvCurrent - damage), usedAttackDice: true });
    }
    
    setResult({ stat: STAT_NAMES[statKey], dice, base, effects, bonus: bonus.bonus, total, difficulty: selectedDiff, success, pdv, biome: selectedBiome, damage: success ? 0 : Math.max(1, selectedDiff - total) });
    setMode('result');
  };

  const attackBoss = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (player.usedAttackDice) return notify("DÃ© dÃ©jÃ  utilisÃ©", "error");
    if (!selectedBoss) return notify("SÃ©lectionnez un boss", "error");
    if ((player.defeatedBosses || []).includes(selectedBoss)) return notify("Boss dÃ©jÃ  vaincu", "error");
    
    const boss = BOSSES[selectedBoss];
    const statKeys = Object.keys(STAT_NAMES);
    const statKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const dice = Math.floor(Math.random() * 10) + 1;
    const base = player.stats?.[statKey] || 0;
    const effects = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const total = dice + base + effects;
    const success = total >= boss.difficulty;
    
    if (success) {
      const newDefeated = [...(player.defeatedBosses || []), selectedBoss];
      await updateMe({ defeatedBosses: newDefeated, usedAttackDice: true });
      await addPdv(boss.pdv, 'BOSS');
    } else {
      const damage = Math.max(1, boss.difficulty - total);
      await updateMe({ pvCurrent: Math.max(0, player.pvCurrent - damage), usedAttackDice: true });
    }
    
    setResult({ stat: STAT_NAMES[statKey], dice, base, effects, total, difficulty: boss.difficulty, success, pdv: boss.pdv, boss: boss.name, damage: success ? 0 : Math.max(1, boss.difficulty - total) });
    setMode('bossResult');
  };

  if (mode === 'result' || mode === 'bossResult') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-2xl font-bold text-center" }, "âš”ï¸ RÃ©sultat"),
      React.createElement("div", { className: `rounded-xl p-6 text-white text-center ${result.success ? 'bg-gradient-to-r from-green-500 to-teal-500' : 'bg-gradient-to-r from-red-500 to-orange-500'}` },
        React.createElement("div", { className: "text-4xl font-bold mb-2" }, result.success ? "âœ… VICTOIRE !" : "âŒ Ã‰CHEC"),
        React.createElement("div", { className: "text-xl mb-4" }, `${result.total} vs ${result.difficulty}`),
        result.success && React.createElement("div", { className: "text-lg" }, `+${result.pdv} PDV`),
        !result.success && React.createElement("div", { className: "text-lg" }, `-${result.damage} PV`)
      ),
      React.createElement("div", { className: "bg-gray-100 rounded-lg p-4 text-sm" },
        React.createElement("div", null, `Stat: ${result.stat}`),
        React.createElement("div", null, `DÃ©: ${result.dice} + Base: ${result.base} + Ã‰tats: ${result.effects}${result.bonus ? ` + Bonus: ${result.bonus}` : ''} = ${result.total}`)
      ),
      React.createElement("button", { onClick: () => { setMode(null); setResult(null); setSelectedBiome(null); setSelectedDiff(null); setSelectedBoss(null); }, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold" }, "Fermer")
    );
  }

  if (mode === 'biome') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("button", { onClick: () => setMode(null), className: "text-purple-600" }, "â† Retour"),
      React.createElement("h3", { className: "text-xl font-bold text-center" }, "ðŸ° ConquÃªte de Territoire"),
      player.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-2 text-center text-sm text-yellow-800" }, "âš ï¸ DÃ© dÃ©jÃ  utilisÃ©"),
      React.createElement("div", { className: "mb-3" },
        React.createElement("label", { className: "text-sm text-gray-600 mb-2 block" }, "Biome"),
        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
          Object.entries(BIOMES).map(([k, b]) => React.createElement("button", { key: k, onClick: () => setSelectedBiome(k), className: `p-3 rounded-lg text-center ${selectedBiome === k ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200'}` },
            React.createElement("div", { className: "text-2xl" }, b.emoji),
            React.createElement("div", { className: "text-xs mt-1" }, b.name.split(' ')[0])
          ))
        )
      ),
      React.createElement("div", { className: "mb-3" },
        React.createElement("label", { className: "text-sm text-gray-600 mb-2 block" }, "DifficultÃ©"),
        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
          [6, 8, 10].map(d => React.createElement("button", { key: d, onClick: () => setSelectedDiff(d), className: `p-3 rounded-lg text-center ${selectedDiff === d ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200'}` },
            React.createElement("div", { className: "font-bold" }, d),
            React.createElement("div", { className: "text-xs" }, `${d === 6 ? 3 : d === 8 ? 4 : 5} PDV`)
          ))
        )
      ),
      React.createElement("button", { onClick: attackTerritory, disabled: !isMyTurn || player.usedAttackDice || !selectedBiome || !selectedDiff, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "âš”ï¸ Attaquer")
    );
  }

  if (mode === 'boss') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("button", { onClick: () => setMode(null), className: "text-purple-600" }, "â† Retour"),
      React.createElement("h3", { className: "text-xl font-bold text-center" }, "ðŸ‰ Combat de Boss"),
      React.createElement("div", { className: "space-y-3" },
        Object.entries(BOSSES).map(([k, b]) => {
          const defeated = (player.defeatedBosses || []).includes(k);
          return React.createElement("button", { key: k, onClick: () => !defeated && setSelectedBoss(k), disabled: defeated, className: `w-full p-4 rounded-xl text-left flex items-center gap-3 ${defeated ? 'bg-green-100 opacity-60' : selectedBoss === k ? 'bg-purple-100 border-2 border-purple-500' : 'bg-white border-2 border-gray-200'}` },
            React.createElement("span", { className: "text-3xl" }, b.emoji),
            React.createElement("div", { className: "flex-1" },
              React.createElement("div", { className: "font-bold" }, b.name),
              React.createElement("div", { className: "text-sm text-gray-600" }, `Diff. ${b.difficulty} | ${b.pdv} PDV`)
            ),
            defeated && React.createElement("span", { className: "text-green-600 font-bold" }, "âœ“")
          );
        })
      ),
      React.createElement("button", { onClick: attackBoss, disabled: !isMyTurn || player.usedAttackDice || !selectedBoss, className: "w-full py-3 bg-red-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "ðŸ‰ Affronter le Boss")
    );
  }

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ Attaque"),
    player.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-3 text-center text-yellow-800" }, "âš ï¸ DÃ© d'attaque dÃ©jÃ  utilisÃ©"),
    React.createElement("div", { className: "grid grid-cols-1 gap-4" },
      React.createElement("button", { onClick: () => setMode('biome'), className: "p-6 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl" },
        React.createElement("div", { className: "text-3xl mb-2" }, "ðŸ”ï¸"),
        React.createElement("div", { className: "text-xl font-bold" }, "ConquÃªte de Biome"),
        React.createElement("div", { className: "text-sm opacity-80" }, `Territoires: ${(player.territories || []).length}`)
      ),
      React.createElement("button", { onClick: () => setMode('boss'), className: "p-6 bg-gradient-to-r from-red-600 to-purple-600 text-white rounded-xl" },
        React.createElement("div", { className: "text-3xl mb-2" }, "ðŸ‰"),
        React.createElement("div", { className: "text-xl font-bold" }, "Combat de Boss"),
        React.createElement("div", { className: "text-sm opacity-80" }, `Boss vaincus: ${(player.defeatedBosses || []).length}/3`)
      )
    ),
    // Territoires possÃ©dÃ©s
    (player.territories || []).length > 0 && React.createElement("div", { className: "bg-green-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `ðŸ° Mes territoires`),
      React.createElement("div", { className: "flex flex-wrap gap-2" },
        (player.territories || []).map((t, i) => React.createElement("span", { key: i, className: "bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm" }, `${BIOMES[t.biome].emoji} Diff.${t.difficulty}`))
      )
    )
  );
}

// ============================================================================
// ONGLET OBJECTIF
// ============================================================================
function ObjectifTab({ player, isMyTurn, updateMe, notify, addPdv, game, gameId, updateGame }) {
  const completeObjective = async (obj) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if ((game.completedObjectives || []).includes(obj.id)) return notify("DÃ©jÃ  complÃ©tÃ©", "error");
    if ((player[obj.resource] || 0) < obj.amount) return notify("Ressources insuffisantes", "error");
    
    await updateMe({ [obj.resource]: (player[obj.resource] || 0) - obj.amount });
    await updateGame({ completedObjectives: [...(game.completedObjectives || []), obj.id] });
    await addPdv(obj.pdv, 'BONUS');
    notify(`+${obj.pdv} PDV !`, "success");
  };

  const exchangeQuest = async (quest) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const info = parseQuest(quest.text);
    if (!info.isExchange) return;
    if ((player[info.resourceKey] || 0) < info.resourceAmount) return notify("Ressources insuffisantes", "error");
    
    const newQuests = (player.quests || []).filter(q => q.id !== quest.id);
    await updateMe({ quests: newQuests, [info.resourceKey]: (player[info.resourceKey] || 0) - info.resourceAmount });
    await addPdv(info.pdv, 'QUEST_EXCHANGE');
    
    // Bonus Vicaire
    if (player.characterKey === 'VICAIRE') {
      await addPdv(1, 'BONUS');
    }
    notify(`+${info.pdv} PDV !`, "success");
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ¯ Objectifs & QuÃªtes"),
    // Objectifs globaux
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Objectifs globaux"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        OBJECTIVES.map(obj => {
          const completed = (game.completedObjectives || []).includes(obj.id);
          const canComplete = (player[obj.resource] || 0) >= obj.amount && !completed;
          return React.createElement("div", { key: obj.id, className: `p-4 rounded-xl ${completed ? 'bg-green-100' : canComplete ? 'bg-blue-50' : 'bg-gray-50'}` },
            React.createElement("div", { className: "text-2xl text-center mb-2" }, obj.emoji),
            React.createElement("div", { className: "text-center font-bold" }, obj.label),
            React.createElement("div", { className: "text-center text-sm text-gray-600" }, `${player[obj.resource] || 0}/${obj.amount}`),
            React.createElement("div", { className: "text-center text-purple-600 font-bold" }, `+${obj.pdv} PDV`),
            completed ? React.createElement("div", { className: "text-center text-green-600 font-bold mt-2" }, "âœ“ ComplÃ©tÃ©")
              : React.createElement("button", { onClick: () => completeObjective(obj), disabled: !canComplete || !isMyTurn, className: `w-full mt-2 py-2 rounded-lg font-semibold text-sm ${canComplete ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}` }, canComplete ? "Valider" : "Insuffisant")
          );
        })
      )
    ),
    // QuÃªtes actives
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, `Mes quÃªtes (${(player.quests || []).length}/2)`),
      (player.quests || []).length === 0 
        ? React.createElement("p", { className: "text-gray-500 text-center py-4" }, "Aucune quÃªte")
        : React.createElement("div", { className: "space-y-3" },
            (player.quests || []).map(q => {
              const info = parseQuest(q.text);
              const canExchange = info.isExchange && (player[info.resourceKey] || 0) >= info.resourceAmount;
              return React.createElement("div", { key: q.id, className: "bg-gray-50 rounded-xl p-4" },
                React.createElement("p", { className: "text-sm text-gray-700 mb-3" }, q.text),
                info.isExchange && React.createElement("div", { className: "flex justify-between items-center" },
                  React.createElement("span", { className: "text-sm text-gray-600" }, `${player[info.resourceKey] || 0}/${info.resourceAmount} ${info.resourceKey}`),
                  React.createElement("button", { onClick: () => exchangeQuest(q), disabled: !canExchange || !isMyTurn, className: `py-2 px-4 rounded-lg font-semibold ${canExchange ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}` }, canExchange ? `âœ… Ã‰changer (+${info.pdv} PDV)` : "Insuffisant")
                )
              );
            })
          )
    ),
    // Ressources
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "ðŸ“Š Mes ressources"),
      React.createElement("div", { className: "grid grid-cols-4 gap-2 text-center" },
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "ðŸ’°"), React.createElement("div", { className: "font-bold" }, player.or || 0)),
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "ðŸŒ³"), React.createElement("div", { className: "font-bold" }, player.cuivre || 0)),
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "ðŸœï¸"), React.createElement("div", { className: "font-bold" }, player.argent || 0)),
        React.createElement("div", null, React.createElement("div", { className: "text-2xl" }, "â›°ï¸"), React.createElement("div", { className: "font-bold" }, player.obsidienne || 0))
      )
    )
  );
}

// ============================================================================
// ONGLET TIRAGES
// ============================================================================
function TiragesTab({ me, isMyTurn, updateMe, notify, game, updateGame, addPdv }) {
  const [anomCard, setAnomCard] = useState(null);
  const [questCard, setQuestCard] = useState(null);
  const [applied, setApplied] = useState(null);

  const drawAnomaly = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const available = ANOMALIES.filter((_, i) => !(game.drawnAnomalies || []).includes(i));
    if (available.length === 0) return notify("Deck vide !", "error");
    
    const idx = Math.floor(Math.random() * available.length);
    const card = available[idx];
    const origIdx = ANOMALIES.indexOf(card);
    
    await updateGame({ drawnAnomalies: [...(game.drawnAnomalies || []), origIdx] });
    setAnomCard(card);
    
    const effect = parseAnomaly(card);
    let msg = "";
    
    if (effect.type === 'heal') {
      await updateMe({ pvCurrent: Math.min(me.character.pvMax, me.pvCurrent + effect.amount) });
      msg = `+${effect.amount} PV`;
    } else if (effect.type === 'damage') {
      await updateMe({ pvCurrent: Math.max(0, me.pvCurrent - effect.amount) });
      msg = `-${effect.amount} PV`;
    } else if (effect.type === 'bless') {
      const newEffects = [...(me.effects || []), { id: Date.now(), type: 'BLESS', stat: effect.stat, delta: 2, name: `BÃ©nÃ©diction ${STAT_NAMES[effect.stat]}` }];
      await updateMe({ effects: newEffects });
      msg = `BÃ©nÃ©diction ${STAT_NAMES[effect.stat]} (+2)`;
    } else if (effect.type === 'curse') {
      const newEffects = [...(me.effects || []), { id: Date.now(), type: 'CURSE', stat: effect.stat, delta: -2, name: `MalÃ©diction ${STAT_NAMES[effect.stat]}` }];
      await updateMe({ effects: newEffects });
      msg = `MalÃ©diction ${STAT_NAMES[effect.stat]} (-2)`;
    } else if (effect.type === 'gain') {
      await updateMe({ [effect.resource]: (me[effect.resource] || 0) + effect.amount });
      msg = `+${effect.amount} ${effect.resource}`;
    } else if (effect.type === 'lose') {
      await updateMe({ [effect.resource]: Math.max(0, (me[effect.resource] || 0) - effect.amount) });
      msg = `-${effect.amount} ${effect.resource}`;
    } else if (effect.type === 'recharge') {
      await updateMe({ blessAvailable: me.characterKey === 'VICAIRE', curseAvailable: me.characterKey === 'HERETIQUE' });
      msg = "Pouvoir rechargÃ© !";
    }
    setApplied(msg);
  };

  const drawQuest = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if ((me.quests || []).length >= 2) return notify("Max 2 quÃªtes !", "error");
    
    const available = QUETES.filter((_, i) => !(game.drawnQuetes || []).includes(i));
    if (available.length === 0) return notify("Deck vide !", "error");
    
    const idx = Math.floor(Math.random() * available.length);
    const card = available[idx];
    const origIdx = QUETES.indexOf(card);
    
    await updateGame({ drawnQuetes: [...(game.drawnQuetes || []), origIdx] });
    setQuestCard(card);
    
    const newQuests = [...(me.quests || []), { id: Date.now(), text: card }];
    await updateMe({ quests: newQuests });
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ´ Tirages"),
    // Anomalie
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `Anomalie (${ANOMALIES.length - (game.drawnAnomalies || []).length} restantes)`),
      React.createElement("div", { className: "min-h-32 bg-gradient-to-r from-purple-600 to-purple-800 rounded-xl p-6 flex items-center justify-center text-white mb-3" },
        anomCard ? React.createElement("div", { className: "text-center" },
          React.createElement("p", { className: "font-medium" }, anomCard),
          applied && React.createElement("p", { className: "text-yellow-300 font-bold mt-2" }, `âœ¨ ${applied}`)
        ) : React.createElement("p", { className: "text-purple-200 italic" }, "Tirez une carte...")
      ),
      React.createElement("button", { onClick: drawAnomaly, disabled: !isMyTurn, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 disabled:opacity-50" }, "ðŸ”® Tirer Anomalie")
    ),
    // QuÃªte
    React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `QuÃªte (${(me.quests || []).length}/2 | ${QUETES.length - (game.drawnQuetes || []).length} restantes)`),
      React.createElement("div", { className: "min-h-32 bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-6 flex items-center justify-center text-white mb-3" },
        questCard ? React.createElement("p", { className: "font-medium text-center" }, questCard) : React.createElement("p", { className: "text-green-200 italic" }, "Tirez une quÃªte...")
      ),
      React.createElement("button", { onClick: drawQuest, disabled: !isMyTurn || (me.quests || []).length >= 2, className: "w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50" }, (me.quests || []).length >= 2 ? "Maximum atteint" : "ðŸ“œ Tirer QuÃªte")
    ),
    // QuÃªtes actives
    (me.quests || []).length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "Mes quÃªtes"),
      React.createElement("div", { className: "space-y-2" },
        (me.quests || []).map(q => React.createElement("div", { key: q.id, className: "bg-gray-50 rounded-lg p-3 text-sm" }, q.text))
      )
    )
  );
}

// ============================================================================
// ONGLET DÃ‰
// ============================================================================
function DeTab({ me, isMyTurn, updateMe, notify }) {
  const [moveResult, setMoveResult] = useState(null);
  const [attackResult, setAttackResult] = useState(null);
  const [rolling, setRolling] = useState(false);
  const [showReroll, setShowReroll] = useState(false);

  const rollMove = () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    setRolling(true);
    setTimeout(() => {
      setMoveResult(Math.floor(Math.random() * 10) + 1);
      setRolling(false);
    }, 500);
  };

  const rollAttack = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("DÃ©jÃ  utilisÃ© ce tour", "error");
    setRolling(true);
    
    setTimeout(async () => {
      const statIdx = Math.floor(Math.random() * STATISTIQUES.length);
      const stat = STATISTIQUES[statIdx];
      const statKey = STAT_MAPPING[stat] || stat.toLowerCase();
      const dice = Math.floor(Math.random() * 10) + 1;
      const base = me.stats?.[statKey] || 0;
      const effects = (me.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
      const total = dice + base + effects;
      const result = { stat, statKey, dice, base, effects, total, crit: dice === 10 };
      setAttackResult(result);
      
      if (me.characterKey === 'VICAIRE' && me.rerollAvailable) {
        setShowReroll(true);
      } else {
        await updateMe({ usedAttackDice: true });
      }
      setRolling(false);
    }, 500);
  };

  const handleReroll = async (accept) => {
    if (accept) {
      const resource = getRandomAvailableResource(me);
      if (!resource) {
        notify("Pas de ressource !", "error");
        await updateMe({ usedAttackDice: true });
        setShowReroll(false);
        return;
      }
      // Nouvelle stat
      const stats = STATISTIQUES.filter(s => (STAT_MAPPING[s] || s.toLowerCase()) !== attackResult.statKey);
      const newStat = stats[Math.floor(Math.random() * stats.length)];
      const newKey = STAT_MAPPING[newStat] || newStat.toLowerCase();
      const base = me.stats?.[newKey] || 0;
      const effects = (me.effects || []).filter(e => e.stat === newKey).reduce((s, e) => s + e.delta, 0);
      const total = attackResult.dice + base + effects;
      setAttackResult({ ...attackResult, stat: newStat, statKey: newKey, base, effects, total, rerolled: true });
      await updateMe({ usedAttackDice: true, rerollAvailable: false, [resource]: Math.max(0, (me[resource] || 0) - 1) });
      notify(`Relance ! -1 ${resource}`, "success");
    } else {
      await updateMe({ usedAttackDice: true });
    }
    setShowReroll(false);
  };

  return React.createElement("div", { className: "space-y-6" },
    // Popup reroll
    showReroll && React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" },
      React.createElement("div", { className: "bg-white rounded-2xl p-6 max-w-sm w-full" },
        React.createElement("h3", { className: "text-xl font-bold text-center mb-4" }, "ðŸ”„ Relance Vicaire"),
        React.createElement("p", { className: "text-center text-gray-600 mb-4" }, "Changer la stat ? (coÃ»t: 1 ressource)"),
        React.createElement("div", { className: "bg-purple-100 rounded-xl p-4 mb-4 text-center" },
          React.createElement("div", { className: "text-lg font-bold text-purple-600" }, attackResult?.stat),
          React.createElement("div", { className: "text-3xl font-bold" }, attackResult?.total)
        ),
        React.createElement("div", { className: "flex gap-3" },
          React.createElement("button", { onClick: () => handleReroll(true), className: "flex-1 py-3 bg-green-600 text-white rounded-xl font-bold" }, "âœ… Oui"),
          React.createElement("button", { onClick: () => handleReroll(false), className: "flex-1 py-3 bg-gray-400 text-white rounded-xl font-bold" }, "âŒ Non")
        )
      )
    ),
    
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ² DÃ©s"),
    // DÃ©placement
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "DÃ©placement"),
      React.createElement("div", { className: `min-h-32 bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 flex flex-col items-center justify-center text-white mb-3 ${rolling ? 'animate-pulse' : ''}` },
        moveResult !== null ? React.createElement(React.Fragment, null,
          React.createElement("div", { className: "text-6xl font-bold" }, moveResult),
          moveResult === 10 && React.createElement("div", { className: "text-yellow-300 font-bold mt-2" }, "âœ¨ Critique !")
        ) : React.createElement("p", { className: "text-blue-200" }, "Lancez le dÃ©")
      ),
      React.createElement("button", { onClick: rollMove, disabled: !isMyTurn || rolling, className: "w-full py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "ðŸŽ² Lancer (1-10)")
    ),
    // Attaque
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Attaque"),
      me.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-2 mb-3 text-center text-sm text-yellow-800" }, "âš ï¸ DÃ©jÃ  utilisÃ©"),
      React.createElement("div", { className: `min-h-40 bg-gradient-to-r from-red-600 to-red-800 rounded-xl p-6 flex flex-col items-center justify-center text-white mb-3 ${rolling ? 'animate-pulse' : ''}` },
        attackResult ? React.createElement("div", { className: "text-center w-full" },
          React.createElement("div", { className: "text-yellow-300 font-bold text-xl mb-2" }, attackResult.stat, attackResult.rerolled && " ðŸ”„"),
          React.createElement("div", { className: "text-5xl font-bold mb-3" }, attackResult.total),
          attackResult.crit && React.createElement("div", { className: "text-yellow-300 font-bold" }, "âœ¨ Critique !"),
          React.createElement("div", { className: "bg-white bg-opacity-20 rounded-lg p-3 mt-2 text-sm" },
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "DÃ©:"), React.createElement("span", { className: "font-bold" }, attackResult.dice)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Base:"), React.createElement("span", { className: "font-bold" }, attackResult.base >= 0 ? `+${attackResult.base}` : attackResult.base)),
            React.createElement("div", { className: "flex justify-between" }, React.createElement("span", null, "Ã‰tats:"), React.createElement("span", { className: `font-bold ${attackResult.effects >= 0 ? 'text-green-300' : 'text-red-300'}` }, attackResult.effects >= 0 ? `+${attackResult.effects}` : attackResult.effects))
          )
        ) : React.createElement("p", { className: "text-red-200" }, "Lancez le dÃ©")
      ),
      React.createElement("button", { onClick: rollAttack, disabled: !isMyTurn || rolling || me.usedAttackDice, className: "w-full py-3 bg-red-600 text-white rounded-xl font-semibold disabled:opacity-50" }, "âš”ï¸ Lancer Attaque")
    )
  );
}


// ============================================================================
// ONGLET Ã‰CHANGE
// ============================================================================
function EchangeTab({ player, isMyTurn, updateMe, notify, players, game, gameId }) {
  const [selectedResource, setSelectedResource] = useState(null);
  const [amount, setAmount] = useState(1);

  const RESOURCES = [
    { key: 'cuivre', emoji: 'ðŸŒ³', name: 'Cuivre', rate: 2 },
    { key: 'argent', emoji: 'ðŸœï¸', name: 'Argent', rate: 3 },
    { key: 'obsidienne', emoji: 'â›°ï¸', name: 'Obsidienne', rate: 4 }
  ];

  const convertToOr = async () => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (!selectedResource) return notify("SÃ©lectionnez une ressource", "error");
    if ((player[selectedResource] || 0) < amount) return notify("Pas assez de ressources", "error");
    
    const res = RESOURCES.find(r => r.key === selectedResource);
    const orGain = amount * res.rate;
    
    await updateMe({
      [selectedResource]: (player[selectedResource] || 0) - amount,
      or: (player.or || 0) + orGain
    });
    notify(`+${orGain} Or !`, "success");
    setAmount(1);
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸ’± Ã‰changes"),
    // Conversion ressources â†’ Or
    React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Convertir en Or"),
      React.createElement("div", { className: "grid grid-cols-3 gap-2 mb-4" },
        RESOURCES.map(r => React.createElement("button", { key: r.key, onClick: () => setSelectedResource(r.key), className: `p-3 rounded-lg text-center ${selectedResource === r.key ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200'}` },
          React.createElement("div", { className: "text-2xl" }, r.emoji),
          React.createElement("div", { className: "text-xs mt-1" }, `${r.rate} Or`),
          React.createElement("div", { className: "text-xs text-gray-500" }, `(${player[r.key] || 0})`)
        ))
      ),
      selectedResource && React.createElement("div", { className: "space-y-3" },
        React.createElement("div", { className: "flex items-center justify-center gap-4" },
          React.createElement("button", { onClick: () => setAmount(Math.max(1, amount - 1)), className: "w-10 h-10 bg-gray-200 rounded-full font-bold" }, "-"),
          React.createElement("span", { className: "text-3xl font-bold" }, amount),
          React.createElement("button", { onClick: () => setAmount(Math.min(player[selectedResource] || 0, amount + 1)), className: "w-10 h-10 bg-gray-200 rounded-full font-bold" }, "+")
        ),
        React.createElement("div", { className: "text-center text-gray-600" },
          `${amount} ${RESOURCES.find(r => r.key === selectedResource)?.name} â†’ ${amount * RESOURCES.find(r => r.key === selectedResource)?.rate} Or`
        ),
        React.createElement("button", { onClick: convertToOr, disabled: !isMyTurn || (player[selectedResource] || 0) < amount, className: "w-full py-3 bg-yellow-500 text-white rounded-xl font-semibold disabled:opacity-50" }, "ðŸ’° Convertir")
      )
    ),
    // Ressources actuelles
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Mes ressources"),
      React.createElement("div", { className: "grid grid-cols-4 gap-3 text-center" },
        React.createElement("div", { className: "bg-white rounded-lg p-3" },
          React.createElement("div", { className: "text-2xl" }, "ðŸ’°"),
          React.createElement("div", { className: "font-bold text-xl" }, player.or || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, "Or")
        ),
        React.createElement("div", { className: "bg-white rounded-lg p-3" },
          React.createElement("div", { className: "text-2xl" }, "ðŸŒ³"),
          React.createElement("div", { className: "font-bold text-xl" }, player.cuivre || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, "Cuivre")
        ),
        React.createElement("div", { className: "bg-white rounded-lg p-3" },
          React.createElement("div", { className: "text-2xl" }, "ðŸœï¸"),
          React.createElement("div", { className: "font-bold text-xl" }, player.argent || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, "Argent")
        ),
        React.createElement("div", { className: "bg-white rounded-lg p-3" },
          React.createElement("div", { className: "text-2xl" }, "â›°ï¸"),
          React.createElement("div", { className: "font-bold text-xl" }, player.obsidienne || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, "Obsidienne")
        )
      )
    ),
    // Taux de change
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "ðŸ“Š Taux de change"),
      React.createElement("div", { className: "space-y-1 text-sm text-gray-600" },
        React.createElement("div", null, "ðŸŒ³ 1 Cuivre = 2 Or"),
        React.createElement("div", null, "ðŸœï¸ 1 Argent = 3 Or"),
        React.createElement("div", null, "â›°ï¸ 1 Obsidienne = 4 Or")
      )
    )
  );
}

// ============================================================================
// ONGLET PERSONNAGE
// ============================================================================
function PersonnageTab({ player, updateMe, handlePassStart, isMyTurn }) {
  const [newEffect, setNewEffect] = useState({ type: 'BLESS', stat: 'endurance' });

  const adjustPv = async (delta) => {
    await updateMe({ pvCurrent: Math.max(0, Math.min(player.character.pvMax, player.pvCurrent + delta)) });
  };

  const adjustResource = async (key, delta) => {
    await updateMe({ [key]: Math.max(0, (player[key] || 0) + delta) });
  };

  const addEffect = async () => {
    const delta = newEffect.type === 'BLESS' ? 2 : -2;
    const name = `${newEffect.type === 'BLESS' ? 'BÃ©nÃ©diction' : 'MalÃ©diction'} ${STAT_NAMES[newEffect.stat]}`;
    const newEffects = [...(player.effects || []), { id: Date.now(), type: newEffect.type, stat: newEffect.stat, delta, name }];
    await updateMe({ effects: newEffects });
  };

  const removeEffect = async (id) => {
    await updateMe({ effects: (player.effects || []).filter(e => e.id !== id) });
  };

  return React.createElement("div", { className: "space-y-6" },
    // Info personnage
    React.createElement("div", { className: "text-center" },
      React.createElement("div", { className: "text-5xl mb-2" }, player.character?.emoji),
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, player.character?.name),
      React.createElement("p", { className: "text-gray-600" }, player.character?.role)
    ),
    // Passage dÃ©part
    isMyTurn && React.createElement("button", { onClick: handlePassStart, className: "w-full py-3 bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-xl font-bold" }, "ðŸ Passage par DÃ©part (+1 PDV)"),
    // PV
    React.createElement("div", { className: "bg-red-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "â¤ï¸ Points de Vie"),
      React.createElement("div", { className: "text-center text-3xl font-bold text-red-600 mb-3" }, `${player.pvCurrent} / ${player.character?.pvMax}`),
      React.createElement("div", { className: "flex gap-2 justify-center" },
        React.createElement("button", { onClick: () => adjustPv(-1), className: "px-4 py-2 bg-red-200 rounded-lg font-bold" }, "-1"),
        React.createElement("button", { onClick: () => updateMe({ pvCurrent: player.character.pvMax }), className: "px-4 py-2 bg-green-200 rounded-lg font-bold" }, "Max"),
        React.createElement("button", { onClick: () => adjustPv(1), className: "px-4 py-2 bg-green-200 rounded-lg font-bold" }, "+1")
      )
    ),
    // Stats
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ“Š Statistiques"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        Object.entries(STAT_NAMES).map(([k, n]) => {
          const base = player.stats?.[k] || 0;
          const bonus = (player.effects || []).filter(e => e.stat === k).reduce((s, e) => s + e.delta, 0);
          return React.createElement("div", { key: k, className: "bg-white rounded-lg p-3 text-center" },
            React.createElement("div", { className: "text-xs text-gray-500" }, n),
            React.createElement("div", { className: "text-xl font-bold" }, 
              base >= 0 ? `+${base}` : base, 
              bonus !== 0 && React.createElement("span", { className: `text-sm ml-1 ${bonus > 0 ? 'text-green-600' : 'text-red-600'}` }, bonus > 0 ? `+${bonus}` : bonus)
            )
          );
        })
      )
    ),
    // Ressources
    React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’Ž Ressources"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        [{ k: 'or', n: 'Or', e: 'ðŸ’°' }, { k: 'cuivre', n: 'Cuivre', e: 'ðŸŒ³' }, { k: 'argent', n: 'Argent', e: 'ðŸœï¸' }, { k: 'obsidienne', n: 'Obsidienne', e: 'â›°ï¸' }].map(r => React.createElement("div", { key: r.k, className: "bg-white rounded-lg p-3 text-center" },
          React.createElement("div", { className: "text-xl" }, r.e),
          React.createElement("div", { className: "text-xl font-bold" }, player[r.k] || 0),
          React.createElement("div", { className: "flex gap-1 justify-center mt-1" },
            React.createElement("button", { onClick: () => adjustResource(r.k, -1), className: "px-2 py-1 bg-gray-200 rounded text-sm" }, "-"),
            React.createElement("button", { onClick: () => adjustResource(r.k, 1), className: "px-2 py-1 bg-gray-200 rounded text-sm" }, "+")
          )
        ))
      )
    ),
    // Ã‰tats
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’« Ã‰tats actifs"),
      (player.effects || []).length === 0 
        ? React.createElement("p", { className: "text-gray-500 italic text-center" }, "Aucun Ã©tat")
        : React.createElement("div", { className: "space-y-2 mb-4" },
            (player.effects || []).map(e => React.createElement("div", { key: e.id, className: `flex justify-between items-center p-3 rounded-lg ${e.type === 'BLESS' ? 'bg-green-100' : 'bg-red-100'}` },
              React.createElement("span", { className: e.type === 'BLESS' ? 'text-green-700 font-bold' : 'text-red-700 font-bold' }, `${e.type === 'BLESS' ? 'âœ¨' : 'ðŸ’€'} ${e.name}`),
              React.createElement("button", { onClick: () => removeEffect(e.id), className: "px-3 py-1 bg-red-500 text-white rounded text-sm" }, "âœ•")
            ))
          ),
      React.createElement("div", { className: "border-t border-purple-200 pt-4" },
        React.createElement("div", { className: "grid grid-cols-2 gap-2 mb-2" },
          React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'BLESS' }), className: `py-2 rounded-lg font-semibold ${newEffect.type === 'BLESS' ? 'bg-green-600 text-white' : 'bg-gray-200'}` }, "âœ¨ BÃ©nÃ©diction"),
          React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'CURSE' }), className: `py-2 rounded-lg font-semibold ${newEffect.type === 'CURSE' ? 'bg-red-600 text-white' : 'bg-gray-200'}` }, "ðŸ’€ MalÃ©diction")
        ),
        React.createElement("select", { value: newEffect.stat, onChange: e => setNewEffect({ ...newEffect, stat: e.target.value }), className: "w-full p-2 border rounded-lg mb-2" },
          Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("option", { key: k, value: k }, n))
        ),
        React.createElement("button", { onClick: addEffect, className: "w-full py-2 bg-purple-600 text-white rounded-lg font-semibold" }, "Ajouter")
      )
    ),
    // CompÃ©tences
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "âš”ï¸ CompÃ©tences"),
      React.createElement("div", { className: "space-y-2" },
        (player.skills || []).map((s, i) => React.createElement("div", { key: s.id, className: "bg-white rounded-lg p-3 flex items-start gap-2" },
          React.createElement("span", { className: "text-xl" }, i === 0 ? 'ðŸ”®' : i === 1 ? 'âš”ï¸' : 'ðŸ›¡ï¸'),
          React.createElement("p", { className: "text-sm text-gray-700" }, s.description)
        ))
      )
    )
  );
}

// ============================================================================
// ONGLET PDV
// ============================================================================
function PdvTab({ player, players }) {
  const history = player.pdvHistory || [];
  const ranking = [...players].sort((a, b) => (b.pdv || 0) - (a.pdv || 0));
  const totalPdv = players.reduce((s, p) => s + (p.pdv || 0), 0);
  const targetPdv = players.length * 10;

  const totals = useMemo(() => {
    const sums = {};
    history.forEach(e => { sums[e.source] = (sums[e.source] || 0) + e.amount; });
    return sums;
  }, [history]);

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("div", { className: "text-center" },
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, "ðŸ† Points de Victoire"),
      React.createElement("div", { className: "text-5xl font-bold text-yellow-500 my-4" }, player.pdv || 0),
      React.createElement("div", { className: "bg-purple-100 rounded-lg p-3" },
        React.createElement("div", { className: "text-sm text-purple-700 font-bold" }, `Total: ${totalPdv} / ${targetPdv} PDV`),
        React.createElement("div", { className: "w-full bg-purple-200 rounded-full h-3 mt-2" },
          React.createElement("div", { className: "bg-purple-600 h-3 rounded-full", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        ),
        React.createElement("div", { className: "text-xs text-purple-600 mt-2" }, `ðŸ Fin Ã  ${targetPdv} PDV (${players.length} Ã— 10)`)
      )
    ),
    // RÃ©partition
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-800 mb-3" }, "ðŸ“Š RÃ©partition"),
      React.createElement("div", { className: "grid grid-cols-3 gap-3" },
        Object.entries(PDV_SOURCES).map(([k, info]) => React.createElement("div", { key: k, className: "bg-white rounded-lg p-3 text-center shadow" },
          React.createElement("div", { className: "text-2xl" }, info.emoji),
          React.createElement("div", { className: `text-xl font-bold ${info.color}` }, totals[k] || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, info.label)
        ))
      )
    ),
    // Classement
    React.createElement("div", { className: "bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-4 text-white" },
      React.createElement("h4", { className: "font-bold mb-3" }, "ðŸ… Classement"),
      React.createElement("div", { className: "space-y-2" },
        ranking.map((p, i) => React.createElement("div", { key: p.oderId || i, className: `flex items-center gap-3 p-2 rounded-lg ${p.oderId === player.oderId ? 'bg-white bg-opacity-20' : ''}` },
          React.createElement("span", { className: `text-lg font-bold ${i === 0 ? 'text-yellow-300' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-300' : ''}` }, i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : `#${i + 1}`),
          React.createElement("span", { className: "text-xl" }, p.character?.emoji),
          React.createElement("span", { className: "flex-1" }, p.name),
          React.createElement("span", { className: "font-bold text-xl" }, p.pdv || 0)
        ))
      )
    ),
    // Historique
    history.length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `ðŸ“œ Historique (${history.length})`),
      React.createElement("div", { className: "space-y-2 max-h-48 overflow-y-auto" },
        [...history].reverse().slice(0, 10).map(e => {
          const info = PDV_SOURCES[e.source] || PDV_SOURCES.BONUS;
          return React.createElement("div", { key: e.id, className: "flex items-center gap-3 bg-gray-50 rounded-lg p-2" },
            React.createElement("span", { className: "text-xl" }, info.emoji),
            React.createElement("span", { className: `font-bold ${info.color}` }, `+${e.amount}`),
            React.createElement("span", { className: "text-gray-600 text-sm" }, info.label)
          );
        })
      )
    )
  );
}

// ============================================================================
// RENDER
// ============================================================================
createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>

// ============================================================================
// ONGLET ATTAQUE
// ============================================================================
function AttaqueTab({ me, isMyTurn, updateMe, notify, game, addPdv, players }) {
  const [mode, setMode] = useState(null);
  const [selectedBiome, setSelectedBiome] = useState(null);
  const [selectedDiff, setSelectedDiff] = useState(null);
  const [result, setResult] = useState(null);
  const [sacrifice, setSacrifice] = useState(0);
  const [showSacrifice, setShowSacrifice] = useState(false);

  const canSac = rulesEngine.canSacrificePv(me);

  const attackTerritory = async (sac = 0) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("DÃ© dÃ©jÃ  utilisÃ©", "error");
    if (!selectedBiome || !selectedDiff) return notify("SÃ©lectionnez biome et difficultÃ©", "error");
    
    const statKeys = Object.keys(STAT_NAMES);
    const statKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const dice = Math.floor(Math.random() * 10) + 1;
    const base = me.stats?.[statKey] || 0;
    const effects = (me.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const bonus = rulesEngine.getAttackBonus(me, { type: 'TERRITORY', isNeutral: true });
    const total = dice + base + effects + bonus.bonus + sac;
    const success = total >= selectedDiff;
    
    const pdv = selectedDiff === 6 ? 3 : selectedDiff === 8 ? 4 : 5;
    const resource = BIOMES[selectedBiome].resource;
    
    let newPv = me.pvCurrent - sac;
    
    if (success) {
      const newTerritories = [...(me.territories || []), { biome: selectedBiome, difficulty: selectedDiff }];
      const heal = rulesEngine.getHealOnSuccess(me);
      if (heal > 0) newPv = Math.min(me.character.pvMax, newPv + heal);
      await updateMe({ territories: newTerritories, [resource]: (me[resource] || 0) + 1, usedAttackDice: true, pvCurrent: Math.max(0, newPv) });
      await addPdv(pdv, 'TERRITORY');
    } else {
      const damage = Math.max(1, selectedDiff - total);
      await updateMe({ pvCurrent: Math.max(0, newPv - damage), usedAttackDice: true });
    }
    
    setResult({ stat: STAT_NAMES[statKey], dice, base, effects, bonus: bonus.bonus, sacrifice: sac, total, difficulty: selectedDiff, success, pdv, biome: selectedBiome });
    setMode('result');
    setShowSacrifice(false);
    setSacrifice(0);
  };

  const attackBoss = async (bossKey, sac = 0) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("DÃ© dÃ©jÃ  utilisÃ©", "error");
    if ((me.defeatedBosses || []).includes(bossKey)) return notify("Boss dÃ©jÃ  vaincu", "error");
    
    const boss = BOSSES[bossKey];
    const statKeys = Object.keys(STAT_NAMES);
    const statKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const dice = Math.floor(Math.random() * 10) + 1;
    const base = me.stats?.[statKey] || 0;
    const effects = (me.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const total = dice + base + effects + sac;
    const success = total >= boss.difficulty;
    
    let newPv = me.pvCurrent - sac;
    
    if (success) {
      const newBosses = [...(me.defeatedBosses || []), bossKey];
      const heal = rulesEngine.getHealOnSuccess(me);
      if (heal > 0) newPv = Math.min(me.character.pvMax, newPv + heal);
      await updateMe({ defeatedBosses: newBosses, usedAttackDice: true, pvCurrent: Math.max(0, newPv) });
      await addPdv(boss.pdv, 'BOSS');
    } else {
      const damage = Math.max(1, boss.difficulty - total);
      await updateMe({ pvCurrent: Math.max(0, newPv - damage), usedAttackDice: true });
    }
    
    setResult({ stat: STAT_NAMES[statKey], dice, base, effects, sacrifice: sac, total, difficulty: boss.difficulty, success, pdv: boss.pdv, boss: boss.name, isBoss: true });
    setMode('result');
    setShowSacrifice(false);
    setSacrifice(0);
  };

  // Ã‰cran sacrifice
  if (showSacrifice) {
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("button", { onClick: () => setShowSacrifice(false), className: "text-purple-600 font-semibold" }, "â† Retour"),
      React.createElement("h3", { className: "text-xl font-bold text-center text-red-600" }, "ðŸ©¸ Furie Sacrificielle"),
      React.createElement("p", { className: "text-center text-gray-600" }, "Sacrifiez des PV pour bonus au jet"),
      React.createElement("div", { className: "text-center" },
        React.createElement("div", { className: "text-gray-600 mb-4" }, `PV: ${me.pvCurrent}`),
        React.createElement("div", { className: "flex items-center justify-center gap-4 my-4" },
          React.createElement("button", { onClick: () => setSacrifice(Math.max(0, sacrifice - 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold text-xl" }, "-"),
          React.createElement("span", { className: "text-5xl font-bold text-red-600" }, sacrifice),
          React.createElement("button", { onClick: () => setSacrifice(Math.min(me.pvCurrent - 1, sacrifice + 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold text-xl" }, "+")
        ),
        React.createElement("p", { className: "text-gray-600" }, `Bonus: +${sacrifice}`)
      ),
      React.createElement("div", { className: "grid grid-cols-2 gap-4" },
        React.createElement("button", { onClick: () => { setShowSacrifice(false); setSacrifice(0); }, className: "py-3 bg-gray-400 text-white rounded-lg font-semibold" }, "Annuler"),
        React.createElement("button", { onClick: () => showSacrifice.type === 'territory' ? attackTerritory(sacrifice) : attackBoss(showSacrifice.bossKey, sacrifice), className: "py-3 bg-red-600 text-white rounded-lg font-bold" }, "Attaquer")
      )
    );
  }

  // RÃ©sultat
  if (mode === 'result' && result) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: `rounded-xl p-6 text-white text-center ${result.success ? 'bg-gradient-to-r from-green-500 to-teal-500' : 'bg-gradient-to-r from-red-500 to-orange-500'}` },
        React.createElement("div", { className: "text-4xl font-bold mb-2" }, result.success ? "âœ… VICTOIRE !" : "âŒ Ã‰CHEC"),
        React.createElement("div", { className: "text-xl mb-2" }, result.isBoss ? result.boss : `${BIOMES[result.biome]?.emoji} Diff.${result.difficulty}`),
        React.createElement("div", { className: "text-lg mb-4" }, `${result.total} vs ${result.difficulty}`),
        React.createElement("div", { className: "bg-white bg-opacity-20 rounded-lg p-3 text-sm" },
          React.createElement("div", null, `Stat: ${result.stat}`),
          React.createElement("div", null, `DÃ©: ${result.dice} | Base: ${result.base} | Ã‰tats: ${result.effects}`),
          result.bonus > 0 && React.createElement("div", null, `Bonus: +${result.bonus}`),
          result.sacrifice > 0 && React.createElement("div", null, `Sacrifice: +${result.sacrifice}`)
        ),
        result.success && React.createElement("div", { className: "text-lg mt-3" }, `+${result.pdv} PDV !`)
      ),
      React.createElement("button", { onClick: () => { setMode(null); setResult(null); setSelectedBiome(null); setSelectedDiff(null); }, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold" }, "Fermer")
    );
  }

  // Menu principal
  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "âš”ï¸ Attaque"),
    me.usedAttackDice && React.createElement("div", { className: "bg-yellow-100 border border-yellow-400 rounded-lg p-3 text-center text-yellow-800" }, "âš ï¸ DÃ© d'attaque dÃ©jÃ  utilisÃ©"),
    
    // Biome
    !mode && React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ° ConquÃ©rir territoire"),
      React.createElement("div", { className: "mb-3" },
        React.createElement("label", { className: "text-sm text-gray-600 mb-2 block" }, "Biome"),
        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
          Object.entries(BIOMES).map(([k, b]) => React.createElement("button", { key: k, onClick: () => setSelectedBiome(k), className: `p-3 rounded-lg text-center ${selectedBiome === k ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200'}` },
            React.createElement("div", { className: "text-2xl" }, b.emoji),
            React.createElement("div", { className: "text-xs mt-1" }, b.name.split(' ')[0])
          ))
        )
      ),
      React.createElement("div", { className: "mb-3" },
        React.createElement("label", { className: "text-sm text-gray-600 mb-2 block" }, "DifficultÃ©"),
        React.createElement("div", { className: "grid grid-cols-3 gap-2" },
          [6, 8, 10].map(d => React.createElement("button", { key: d, onClick: () => setSelectedDiff(d), className: `p-3 rounded-lg text-center ${selectedDiff === d ? 'bg-purple-600 text-white' : 'bg-white border-2 border-gray-200'}` },
            React.createElement("div", { className: "font-bold" }, d),
            React.createElement("div", { className: "text-xs" }, `${d === 6 ? 3 : d === 8 ? 4 : 5} PDV`)
          ))
        )
      ),
      React.createElement("button", { 
        onClick: () => canSac ? setShowSacrifice({ type: 'territory' }) : attackTerritory(0), 
        disabled: !isMyTurn || me.usedAttackDice || !selectedBiome || !selectedDiff, 
        className: "w-full py-3 bg-purple-600 text-white rounded-xl font-semibold disabled:opacity-50" 
      }, "âš”ï¸ Attaquer")
    ),
    
    // Boss
    !mode && React.createElement("div", { className: "bg-red-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ‰ Boss"),
      React.createElement("div", { className: "space-y-2" },
        Object.entries(BOSSES).map(([k, b]) => {
          const defeated = (me.defeatedBosses || []).includes(k);
          return React.createElement("div", { key: k, className: `p-3 rounded-lg flex items-center justify-between ${defeated ? 'bg-green-100' : 'bg-white'}` },
            React.createElement("div", { className: "flex items-center gap-3" },
              React.createElement("span", { className: "text-2xl" }, b.emoji),
              React.createElement("div", null,
                React.createElement("div", { className: "font-semibold" }, b.name),
                React.createElement("div", { className: "text-sm text-gray-600" }, `Diff.${b.difficulty} â†’ ${b.pdv} PDV`)
              )
            ),
            defeated ? React.createElement("span", { className: "text-green-600 font-bold" }, "âœ“") :
            React.createElement("button", { 
              onClick: () => canSac ? setShowSacrifice({ type: 'boss', bossKey: k }) : attackBoss(k, 0),
              disabled: !isMyTurn || me.usedAttackDice,
              className: "px-4 py-2 bg-red-600 text-white rounded-lg font-semibold disabled:opacity-50"
            }, "âš”ï¸")
          );
        })
      )
    ),
    
    // Territoires
    (me.territories || []).length > 0 && React.createElement("div", { className: "bg-green-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `ðŸ° Mes territoires (${(me.territories || []).length})`),
      React.createElement("div", { className: "flex flex-wrap gap-2" },
        (me.territories || []).map((t, i) => React.createElement("span", { key: i, className: "bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm" }, `${BIOMES[t.biome].emoji} Diff.${t.difficulty}`))
      )
    )
  );
}

// ============================================================================
// ONGLET OBJECTIF
// ============================================================================
function ObjectifTab({ me, isMyTurn, updateMe, notify, game, updateGame, addPdv }) {
  const [attemptResult, setAttemptResult] = useState(null);
  const [showSacrifice, setShowSacrifice] = useState(null);
  const [sacrifice, setSacrifice] = useState(0);

  const canSac = rulesEngine.canSacrificePv(me);

  const completeObjective = async (obj) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if ((game.completedObjectives || []).includes(obj.id)) return notify("DÃ©jÃ  complÃ©tÃ©", "error");
    if ((me[obj.resource] || 0) < obj.amount) return notify("Ressources insuffisantes", "error");
    
    await updateMe({ [obj.resource]: me[obj.resource] - obj.amount });
    await updateGame({ completedObjectives: [...(game.completedObjectives || []), obj.id] });
    await addPdv(obj.pdv, 'BONUS');
    notify(`+${obj.pdv} PDV !`, "success");
  };

  const attemptQuest = async (quest, sac = 0) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    if (me.usedAttackDice) return notify("DÃ© dÃ©jÃ  utilisÃ©", "error");
    
    const info = parseQuest(quest.text);
    if (!info.isCombat) return;
    
    const statKey = info.stat;
    const dice = Math.floor(Math.random() * 10) + 1;
    const base = me.stats?.[statKey] || 0;
    const effects = (me.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const bonus = rulesEngine.getAttackBonus(me, { type: 'QUEST', isRanged: me.characterKey === 'CHASSEUR' });
    const total = dice + base + effects + bonus.bonus + sac;
    const success = total >= info.difficulty;
    
    let newPv = me.pvCurrent - sac;
    
    if (success) {
      const questBonus = rulesEngine.getQuestBonus(me);
      const heal = rulesEngine.getHealOnSuccess(me);
      if (heal > 0) newPv = Math.min(me.character.pvMax, newPv + heal);
      
      const newQuests = (me.quests || []).filter(q => q.id !== quest.id);
      await updateMe({ quests: newQuests, usedAttackDice: true, pvCurrent: Math.max(0, newPv) });
      await addPdv(info.pdv + questBonus, 'QUEST_COMBAT');
    } else {
      const damage = Math.max(1, info.difficulty - total);
      await updateMe({ usedAttackDice: true, pvCurrent: Math.max(0, newPv - damage) });
    }
    
    setAttemptResult({ stat: STAT_NAMES[statKey], dice, base, effects, bonus: bonus.bonus, sacrifice: sac, total, difficulty: info.difficulty, success, pdv: info.pdv });
    setShowSacrifice(null);
    setSacrifice(0);
  };

  const exchangeQuest = async (quest) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const info = parseQuest(quest.text);
    if (!info.isExchange) return;
    if ((me[info.resourceKey] || 0) < info.resourceAmount) return notify("Ressources insuffisantes", "error");
    
    const questBonus = rulesEngine.getQuestBonus(me);
    const newQuests = (me.quests || []).filter(q => q.id !== quest.id);
    await updateMe({ quests: newQuests, [info.resourceKey]: me[info.resourceKey] - info.resourceAmount });
    await addPdv(info.pdv + questBonus, 'QUEST_EXCHANGE');
    notify(`+${info.pdv + questBonus} PDV !`, "success");
  };

  // Sacrifice
  if (showSacrifice) {
    return React.createElement("div", { className: "space-y-6" },
      React.createElement("button", { onClick: () => setShowSacrifice(null), className: "text-purple-600 font-semibold" }, "â† Retour"),
      React.createElement("h3", { className: "text-xl font-bold text-center text-red-600" }, "ðŸ©¸ Sacrifice"),
      React.createElement("div", { className: "text-center" },
        React.createElement("div", { className: "flex items-center justify-center gap-4 my-4" },
          React.createElement("button", { onClick: () => setSacrifice(Math.max(0, sacrifice - 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold" }, "-"),
          React.createElement("span", { className: "text-5xl font-bold text-red-600" }, sacrifice),
          React.createElement("button", { onClick: () => setSacrifice(Math.min(me.pvCurrent - 1, sacrifice + 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold" }, "+")
        )
      ),
      React.createElement("button", { onClick: () => attemptQuest(showSacrifice, sacrifice), className: "w-full py-3 bg-red-600 text-white rounded-xl font-bold" }, "Tenter la quÃªte")
    );
  }

  // RÃ©sultat
  if (attemptResult) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: `rounded-xl p-6 text-white text-center ${attemptResult.success ? 'bg-gradient-to-r from-green-500 to-teal-500' : 'bg-gradient-to-r from-red-500 to-orange-500'}` },
        React.createElement("div", { className: "text-4xl font-bold mb-2" }, attemptResult.success ? "âœ… RÃ‰USSITE !" : "âŒ Ã‰CHEC"),
        React.createElement("div", { className: "text-xl mb-4" }, `${attemptResult.total} vs ${attemptResult.difficulty}`),
        attemptResult.success && React.createElement("div", { className: "text-lg" }, `+${attemptResult.pdv} PDV !`)
      ),
      React.createElement("button", { onClick: () => setAttemptResult(null), className: "w-full py-3 bg-gray-600 text-white rounded-xl font-semibold" }, "Fermer")
    );
  }

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸŽ¯ Objectifs"),
    
    // Objectifs globaux
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "Objectifs de ressources"),
      React.createElement("div", { className: "space-y-2" },
        OBJECTIVES.map(obj => {
          const completed = (game.completedObjectives || []).includes(obj.id);
          const canComplete = (me[obj.resource] || 0) >= obj.amount && !completed;
          return React.createElement("div", { key: obj.id, className: `p-3 rounded-lg flex items-center justify-between ${completed ? 'bg-green-100' : canComplete ? 'bg-blue-50' : 'bg-white'}` },
            React.createElement("div", { className: "flex items-center gap-2" },
              React.createElement("span", { className: "text-xl" }, obj.emoji),
              React.createElement("span", { className: "font-semibold" }, obj.label),
              React.createElement("span", { className: "text-sm text-gray-500" }, `(vous: ${me[obj.resource] || 0})`)
            ),
            completed ? React.createElement("span", { className: "text-green-600 font-bold" }, "âœ“") :
            React.createElement("button", { onClick: () => completeObjective(obj), disabled: !isMyTurn || !canComplete, className: `px-3 py-1 rounded font-semibold ${canComplete ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}` }, `+${obj.pdv}`)
          );
        })
      )
    ),
    
    // QuÃªtes
    React.createElement("div", { className: "bg-green-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, `Mes quÃªtes (${(me.quests || []).length}/2)`),
      (me.quests || []).length === 0 
        ? React.createElement("p", { className: "text-gray-500 italic text-center py-4" }, "Aucune quÃªte")
        : React.createElement("div", { className: "space-y-3" },
            (me.quests || []).map(q => {
              const info = parseQuest(q.text);
              const canExchange = info.isExchange && (me[info.resourceKey] || 0) >= info.resourceAmount;
              return React.createElement("div", { key: q.id, className: "bg-white rounded-lg p-4" },
                React.createElement("p", { className: "text-sm text-gray-700 mb-3" }, q.text),
                info.isExchange ? React.createElement("button", { onClick: () => exchangeQuest(q), disabled: !isMyTurn || !canExchange, className: `w-full py-2 rounded-lg font-semibold ${canExchange ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}` }, canExchange ? `âœ… Ã‰changer (+${info.pdv} PDV)` : "Ressources insuffisantes") :
                info.isCombat && React.createElement("button", { onClick: () => canSac ? setShowSacrifice(q) : attemptQuest(q, 0), disabled: !isMyTurn || me.usedAttackDice, className: "w-full py-2 bg-orange-600 text-white rounded-lg font-semibold disabled:opacity-50" }, `âš”ï¸ Tenter (Diff.${info.difficulty})`)
              );
            })
          )
    )
  );
}


// ============================================================================
// ONGLET Ã‰CHANGE
// ============================================================================
function EchangeTab({ me, isMyTurn, updateMe, notify, game, gameId, players }) {
  const [selectedPlayer, setSelectedPlayer] = useState(null);
  const [giveRes, setGiveRes] = useState(null);
  const [giveAmt, setGiveAmt] = useState(1);
  const [receiveRes, setReceiveRes] = useState(null);
  const [receiveAmt, setReceiveAmt] = useState(1);

  const RESOURCES = [
    { key: 'or', emoji: 'ðŸ’°', name: 'Or', value: 1 },
    { key: 'cuivre', emoji: 'ðŸ¥‰', name: 'Cuivre', value: 2 },
    { key: 'argent', emoji: 'ðŸ¥ˆ', name: 'Argent', value: 3 },
    { key: 'obsidienne', emoji: 'â¬›', name: 'Obsidienne', value: 4 }
  ];

  const opponents = players.filter(p => p.oderId !== me.oderId);
  const target = selectedPlayer ? players.find(p => p.oderId === selectedPlayer) : null;
  
  const giveValue = giveRes ? giveAmt * RESOURCES.find(r => r.key === giveRes).value : 0;
  const receiveValue = receiveRes ? receiveAmt * RESOURCES.find(r => r.key === receiveRes).value : 0;
  const isBalanced = giveValue > 0 && giveValue === receiveValue;
  const canExchange = isBalanced && (me[giveRes] || 0) >= giveAmt && target && (target[receiveRes] || 0) >= receiveAmt;

  const executeExchange = async () => {
    if (!canExchange || !isMyTurn) return;
    
    await updateMe({
      [giveRes]: me[giveRes] - giveAmt,
      [receiveRes]: (me[receiveRes] || 0) + receiveAmt
    });
    
    if (database) {
      await database.ref(`games/${gameId}/players/${selectedPlayer}`).update({
        [giveRes]: (target[giveRes] || 0) + giveAmt,
        [receiveRes]: target[receiveRes] - receiveAmt
      });
    }
    
    notify("Ã‰change effectuÃ© !", "success");
    setSelectedPlayer(null);
    setGiveRes(null);
    setReceiveRes(null);
    setGiveAmt(1);
    setReceiveAmt(1);
  };

  // Conversion ressources
  const convertResource = async (from, to) => {
    if (!isMyTurn) return notify("Pas votre tour", "error");
    const rate = EXCHANGE_RATES[from];
    if (!rate || (me[from] || 0) < 1) return notify("Pas assez", "error");
    
    await updateMe({
      [from]: me[from] - 1,
      or: (me.or || 0) + rate.toOr
    });
    notify(`+${rate.toOr} Or`, "success");
  };

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("h3", { className: "text-2xl font-bold text-center text-gray-800" }, "ðŸ”„ Ã‰change"),
    
    // Conversion
    React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’± Conversion en Or"),
      React.createElement("div", { className: "grid grid-cols-3 gap-2" },
        ['cuivre', 'argent', 'obsidienne'].map(res => {
          const rate = EXCHANGE_RATES[res];
          const r = RESOURCES.find(x => x.key === res);
          const has = (me[res] || 0) >= 1;
          return React.createElement("button", { 
            key: res, 
            onClick: () => convertResource(res, 'or'),
            disabled: !isMyTurn || !has,
            className: `p-3 rounded-lg text-center ${has ? 'bg-white hover:bg-yellow-100' : 'bg-gray-100 opacity-50'}`
          },
            React.createElement("div", { className: "text-2xl" }, r.emoji),
            React.createElement("div", { className: "text-xs mt-1" }, `1 â†’ ${rate.toOr} ðŸ’°`),
            React.createElement("div", { className: "text-xs text-gray-500" }, `(${me[res] || 0})`)
          );
        })
      )
    ),
    
    // Ã‰change joueur
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ¤ Ã‰change avec joueur"),
      // SÃ©lection joueur
      React.createElement("div", { className: "mb-4" },
        React.createElement("label", { className: "text-sm text-gray-600 block mb-2" }, "Joueur"),
        React.createElement("div", { className: "grid grid-cols-2 gap-2" },
          opponents.map(p => React.createElement("button", {
            key: p.oderId,
            onClick: () => setSelectedPlayer(p.oderId),
            className: `p-2 rounded-lg text-center ${selectedPlayer === p.oderId ? 'bg-purple-600 text-white' : 'bg-white'}`
          },
            React.createElement("span", { className: "text-xl mr-2" }, p.character?.emoji),
            React.createElement("span", null, p.name)
          ))
        )
      ),
      // Ce que vous donnez
      target && React.createElement(React.Fragment, null,
        React.createElement("div", { className: "mb-4" },
          React.createElement("label", { className: "text-sm text-gray-600 block mb-2" }, "Vous donnez"),
          React.createElement("div", { className: "grid grid-cols-4 gap-2 mb-2" },
            RESOURCES.map(r => React.createElement("button", {
              key: r.key,
              onClick: () => setGiveRes(r.key),
              className: `p-2 rounded-lg text-center ${giveRes === r.key ? 'bg-red-500 text-white' : 'bg-white'}`
            },
              React.createElement("div", { className: "text-xl" }, r.emoji),
              React.createElement("div", { className: "text-xs" }, me[r.key] || 0)
            ))
          ),
          giveRes && React.createElement("div", { className: "flex items-center justify-center gap-2" },
            React.createElement("button", { onClick: () => setGiveAmt(Math.max(1, giveAmt - 1)), className: "w-8 h-8 bg-gray-200 rounded" }, "-"),
            React.createElement("span", { className: "text-xl font-bold w-12 text-center" }, giveAmt),
            React.createElement("button", { onClick: () => setGiveAmt(Math.min(me[giveRes] || 0, giveAmt + 1)), className: "w-8 h-8 bg-gray-200 rounded" }, "+"),
            React.createElement("span", { className: "text-sm text-gray-500 ml-2" }, `= ${giveValue} pts`)
          )
        ),
        // Ce que vous recevez
        React.createElement("div", { className: "mb-4" },
          React.createElement("label", { className: "text-sm text-gray-600 block mb-2" }, "Vous recevez"),
          React.createElement("div", { className: "grid grid-cols-4 gap-2 mb-2" },
            RESOURCES.map(r => React.createElement("button", {
              key: r.key,
              onClick: () => setReceiveRes(r.key),
              className: `p-2 rounded-lg text-center ${receiveRes === r.key ? 'bg-green-500 text-white' : 'bg-white'}`
            },
              React.createElement("div", { className: "text-xl" }, r.emoji),
              React.createElement("div", { className: "text-xs" }, target[r.key] || 0)
            ))
          ),
          receiveRes && React.createElement("div", { className: "flex items-center justify-center gap-2" },
            React.createElement("button", { onClick: () => setReceiveAmt(Math.max(1, receiveAmt - 1)), className: "w-8 h-8 bg-gray-200 rounded" }, "-"),
            React.createElement("span", { className: "text-xl font-bold w-12 text-center" }, receiveAmt),
            React.createElement("button", { onClick: () => setReceiveAmt(Math.min(target[receiveRes] || 0, receiveAmt + 1)), className: "w-8 h-8 bg-gray-200 rounded" }, "+"),
            React.createElement("span", { className: "text-sm text-gray-500 ml-2" }, `= ${receiveValue} pts`)
          )
        ),
        // Validation
        React.createElement("div", { className: `p-3 rounded-lg text-center mb-3 ${isBalanced ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}` },
          isBalanced ? "âœ… Ã‰change Ã©quilibrÃ©" : `âš ï¸ DÃ©sÃ©quilibre: ${giveValue} vs ${receiveValue}`
        ),
        React.createElement("button", { 
          onClick: executeExchange, 
          disabled: !isMyTurn || !canExchange,
          className: `w-full py-3 rounded-xl font-bold ${canExchange ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}`
        }, "Confirmer l'Ã©change")
      )
    )
  );
}

// ============================================================================
// ONGLET PERSONNAGE
// ============================================================================
function PersonnageTab({ me, updateMe, handlePassStart, isMyTurn }) {
  const [newEffect, setNewEffect] = useState({ type: 'BLESS', stat: 'endurance' });

  const adjustPv = async (delta) => {
    await updateMe({ pvCurrent: Math.max(0, Math.min(me.character.pvMax, me.pvCurrent + delta)) });
  };

  const adjustResource = async (key, delta) => {
    await updateMe({ [key]: Math.max(0, (me[key] || 0) + delta) });
  };

  const addEffect = async () => {
    const delta = newEffect.type === 'BLESS' ? 2 : -2;
    const name = `${newEffect.type === 'BLESS' ? 'BÃ©nÃ©diction' : 'MalÃ©diction'} ${STAT_NAMES[newEffect.stat]}`;
    const newEffects = [...(me.effects || []), { id: Date.now(), type: newEffect.type, stat: newEffect.stat, delta, name }];
    await updateMe({ effects: newEffects });
  };

  const removeEffect = async (id) => {
    await updateMe({ effects: (me.effects || []).filter(e => e.id !== id) });
  };

  return React.createElement("div", { className: "space-y-6" },
    // Info personnage
    React.createElement("div", { className: "text-center" },
      React.createElement("div", { className: "text-5xl mb-2" }, me.character?.emoji),
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, me.character?.name),
      React.createElement("p", { className: "text-gray-600" }, me.character?.role)
    ),
    
    // Bouton passage dÃ©part
    isMyTurn && React.createElement("button", { onClick: handlePassStart, className: "w-full py-3 bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-xl font-bold" }, "ðŸ Passage par DÃ©part (+1 PDV)")
    ,
    // PV
    React.createElement("div", { className: "bg-red-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "â¤ï¸ Points de Vie"),
      React.createElement("div", { className: "text-center text-3xl font-bold text-red-600 mb-3" }, `${me.pvCurrent} / ${me.character?.pvMax}`),
      React.createElement("div", { className: "flex gap-2 justify-center" },
        React.createElement("button", { onClick: () => adjustPv(-1), className: "px-4 py-2 bg-red-200 rounded-lg font-bold" }, "-1"),
        React.createElement("button", { onClick: () => updateMe({ pvCurrent: me.character.pvMax }), className: "px-4 py-2 bg-green-200 rounded-lg font-bold" }, "Max"),
        React.createElement("button", { onClick: () => adjustPv(1), className: "px-4 py-2 bg-green-200 rounded-lg font-bold" }, "+1")
      )
    ),
    
    // Stats
    React.createElement("div", { className: "bg-blue-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ“Š Statistiques"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        Object.entries(STAT_NAMES).map(([k, n]) => {
          const base = me.stats?.[k] || 0;
          const bonus = (me.effects || []).filter(e => e.stat === k).reduce((s, e) => s + e.delta, 0);
          return React.createElement("div", { key: k, className: "bg-white rounded-lg p-3 text-center" },
            React.createElement("div", { className: "text-xs text-gray-500" }, n),
            React.createElement("div", { className: "text-xl font-bold" }, 
              base >= 0 ? `+${base}` : base, 
              bonus !== 0 && React.createElement("span", { className: `text-sm ml-1 ${bonus > 0 ? 'text-green-600' : 'text-red-600'}` }, bonus > 0 ? `+${bonus}` : bonus)
            )
          );
        })
      )
    ),
    
    // Ressources
    React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’Ž Ressources"),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        [{ k: 'or', e: 'ðŸ’°' }, { k: 'cuivre', e: 'ðŸŒ³' }, { k: 'argent', e: 'ðŸœï¸' }, { k: 'obsidienne', e: 'â›°ï¸' }].map(r => 
          React.createElement("div", { key: r.k, className: "bg-white rounded-lg p-3 text-center" },
            React.createElement("div", { className: "text-xl" }, r.e),
            React.createElement("div", { className: "text-xl font-bold" }, me[r.k] || 0),
            React.createElement("div", { className: "flex gap-1 justify-center mt-1" },
              React.createElement("button", { onClick: () => adjustResource(r.k, -1), className: "px-2 py-1 bg-gray-200 rounded text-sm" }, "-"),
              React.createElement("button", { onClick: () => adjustResource(r.k, 1), className: "px-2 py-1 bg-gray-200 rounded text-sm" }, "+")
            )
          )
        )
      )
    ),
    
    // Ã‰tats
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ’« Ã‰tats"),
      (me.effects || []).length === 0 
        ? React.createElement("p", { className: "text-gray-500 italic text-center py-2" }, "Aucun Ã©tat")
        : React.createElement("div", { className: "space-y-2 mb-4" },
            (me.effects || []).map(e => React.createElement("div", { 
              key: e.id, 
              className: `flex justify-between items-center p-2 rounded-lg ${e.type === 'BLESS' ? 'bg-green-100' : 'bg-red-100'}`
            },
              React.createElement("span", { className: e.type === 'BLESS' ? 'text-green-700' : 'text-red-700' }, `${e.type === 'BLESS' ? 'âœ¨' : 'ðŸ’€'} ${e.name} (${e.delta >= 0 ? '+' : ''}${e.delta})`),
              React.createElement("button", { onClick: () => removeEffect(e.id), className: "px-2 py-1 bg-red-500 text-white rounded text-xs" }, "âœ•")
            ))
          ),
      React.createElement("div", { className: "border-t border-purple-200 pt-3" },
        React.createElement("div", { className: "grid grid-cols-2 gap-2 mb-2" },
          React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'BLESS' }), className: `py-2 rounded-lg font-semibold ${newEffect.type === 'BLESS' ? 'bg-green-600 text-white' : 'bg-gray-200'}` }, "âœ¨ BÃ©nÃ©d."),
          React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'CURSE' }), className: `py-2 rounded-lg font-semibold ${newEffect.type === 'CURSE' ? 'bg-red-600 text-white' : 'bg-gray-200'}` }, "ðŸ’€ MalÃ©d.")
        ),
        React.createElement("select", { value: newEffect.stat, onChange: e => setNewEffect({ ...newEffect, stat: e.target.value }), className: "w-full p-2 border rounded-lg mb-2" },
          Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("option", { key: k, value: k }, n))
        ),
        React.createElement("button", { onClick: addEffect, className: "w-full py-2 bg-purple-600 text-white rounded-lg font-semibold" }, "Ajouter")
      )
    ),
    
    // CompÃ©tences
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "âš”ï¸ CompÃ©tences"),
      React.createElement("div", { className: "space-y-2" },
        (me.skills || []).map((s, i) => React.createElement("div", { key: s.id, className: "bg-white rounded-lg p-3 flex items-start gap-2" },
          React.createElement("span", { className: "text-xl" }, i === 0 ? 'ðŸ”®' : i === 1 ? 'âš”ï¸' : 'ðŸ›¡ï¸'),
          React.createElement("p", { className: "text-sm text-gray-700" }, s.description)
        ))
      )
    )
  );
}

// ============================================================================
// ONGLET PDV
// ============================================================================
function PdvTab({ me, players }) {
  const history = me.pdvHistory || [];
  const ranking = [...players].sort((a, b) => (b.pdv || 0) - (a.pdv || 0));
  const totalPdv = players.reduce((s, p) => s + (p.pdv || 0), 0);
  const targetPdv = players.length * 10;

  const totals = useMemo(() => {
    const sums = {};
    history.forEach(e => { sums[e.source] = (sums[e.source] || 0) + e.amount; });
    return sums;
  }, [history]);

  return React.createElement("div", { className: "space-y-6" },
    // Score
    React.createElement("div", { className: "text-center" },
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, "ðŸ† Points de Victoire"),
      React.createElement("div", { className: "text-5xl font-bold text-yellow-500 my-4" }, me.pdv || 0),
      React.createElement("div", { className: "bg-purple-100 rounded-lg p-3" },
        React.createElement("div", { className: "text-sm text-purple-700 font-bold" }, `Total: ${totalPdv} / ${targetPdv}`),
        React.createElement("div", { className: "w-full bg-purple-200 rounded-full h-3 mt-2" },
          React.createElement("div", { className: "bg-purple-600 h-3 rounded-full transition-all", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        ),
        React.createElement("div", { className: "text-xs text-purple-600 mt-2" }, `ðŸ Fin Ã  ${targetPdv} PDV`)
      )
    ),
    
    // RÃ©partition
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-700 mb-3" }, "ðŸ“Š RÃ©partition"),
      React.createElement("div", { className: "grid grid-cols-3 gap-2" },
        Object.entries(PDV_SOURCES).map(([k, info]) => React.createElement("div", { key: k, className: "bg-white rounded-lg p-2 text-center" },
          React.createElement("div", { className: "text-xl" }, info.emoji),
          React.createElement("div", { className: `text-xl font-bold ${info.color}` }, totals[k] || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, info.label)
        ))
      )
    ),
    
    // Classement
    React.createElement("div", { className: "bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-4 text-white" },
      React.createElement("h4", { className: "font-bold mb-3" }, "ðŸ… Classement"),
      React.createElement("div", { className: "space-y-2" },
        ranking.map((p, i) => React.createElement("div", { key: p.oderId || i, className: `flex items-center gap-3 p-2 rounded-lg ${p.oderId === me.oderId ? 'bg-white bg-opacity-20' : ''}` },
          React.createElement("span", { className: `text-lg font-bold ${i === 0 ? 'text-yellow-300' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-orange-300' : ''}` }, i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : `#${i + 1}`),
          React.createElement("span", { className: "text-xl" }, p.character?.emoji),
          React.createElement("span", { className: "flex-1" }, p.name),
          React.createElement("span", { className: "font-bold text-xl" }, p.pdv || 0)
        ))
      )
    ),
    
    // Historique
    history.length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, `ðŸ“œ Historique (${history.length})`),
      React.createElement("div", { className: "space-y-2 max-h-48 overflow-y-auto" },
        [...history].reverse().map(e => {
          const info = PDV_SOURCES[e.source] || PDV_SOURCES.BONUS;
          return React.createElement("div", { key: e.id, className: "flex items-center gap-3 bg-gray-50 rounded-lg p-2" },
            React.createElement("span", { className: "text-xl" }, info.emoji),
            React.createElement("span", { className: `font-bold ${info.color}` }, `+${e.amount}`),
            React.createElement("span", { className: "text-gray-600 text-sm" }, info.label)
          );
        })
      )
    )
  );
}

// ============================================================================
// RENDER
// ============================================================================
createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
