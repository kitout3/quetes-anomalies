<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu√™tes d'Anomalies - Firebase Multijoueur v3.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script>
const { useState, useEffect, useMemo } = React;
const { createRoot } = ReactDOM;

// ============= FIREBASE CONFIG =============
const firebaseConfig = {
  apiKey: "${FIREBASE_API_KEY}",
  authDomain: "${FIREBASE_AUTH_DOMAIN}",
  databaseURL: "${FIREBASE_DATABASE_URL}",
  projectId: "${FIREBASE_PROJECT_ID}",
  storageBucket: "${FIREBASE_STORAGE_BUCKET}",
  messagingSenderId: "${FIREBASE_MESSAGING_SENDER_ID}",
  appId: "${FIREBASE_APP_ID}"
};

firebase.initializeApp(firebaseConfig);
console.log("Firebase initialis√© avec succ√®s");
const auth = firebase.auth();
const db = firebase.database();

// ============= CONSTANTS =============
const STAT_NAMES = { endurance: "Endurance", force: "Force", vitesse: "Vitesse", perception: "Perception", sagesse: "Sagesse", intelligence: "Intelligence" };
const STAT_MAPPING = { "Endurance": "endurance", "Force": "force", "Agilit√©": "vitesse", "Perception": "perception", "Sagesse": "sagesse", "Intelligence": "intelligence" };
const STATISTIQUES = ["Endurance", "Force", "Vitesse", "Perception", "Sagesse", "Intelligence"];
const PDV_SOURCES = { KILL: { label: "√âlimination", emoji: "üíÄ", color: "text-red-600" }, QUEST_COMBAT: { label: "Qu√™te combat", emoji: "‚öîÔ∏è", color: "text-orange-600" }, QUEST_EXCHANGE: { label: "Qu√™te √©change", emoji: "üîÑ", color: "text-blue-600" }, TERRITORY: { label: "Territoire", emoji: "üè∞", color: "text-green-600" }, BOSS: { label: "Boss", emoji: "üêâ", color: "text-yellow-600" }, BONUS: { label: "Bonus", emoji: "‚ú®", color: "text-pink-600" }, START: { label: "D√©part", emoji: "üèÅ", color: "text-teal-600" } };
const BIOMES = { FORET: { name: "For√™t aux arbres Cuivr√©s", resource: "cuivre", color: "from-amber-600 to-amber-800", emoji: "üå≥" }, DESERT: { name: "D√©sert aux sables Argent√©s", resource: "argent", color: "from-gray-400 to-gray-600", emoji: "üèúÔ∏è" }, MONTAGNE: { name: "Montagne aux roches Obsidiennes", resource: "obsidienne", color: "from-slate-700 to-slate-900", emoji: "‚õ∞Ô∏è" } };
const BOSSES = { FORET: { name: "Gardien de la For√™t", difficulty: 6, pdv: 3, emoji: "üå≤" }, DESERT: { name: "Titan du D√©sert", difficulty: 8, pdv: 4, emoji: "üèúÔ∏è" }, MONTAGNE: { name: "Seigneur de la Montagne", difficulty: 10, pdv: 5, emoji: "‚õ∞Ô∏è" } };
const OBJECTIVES = [{ id: 'OBJ_OR', resource: 'or', amount: 12, pdv: 3, label: '12 Or', emoji: 'üí∞' }, { id: 'OBJ_CUIVRE', resource: 'cuivre', amount: 9, pdv: 3, label: '9 Cuivre', emoji: 'ü•â' }, { id: 'OBJ_ARGENT', resource: 'argent', amount: 6, pdv: 3, label: '6 Argent', emoji: 'ü•à' }, { id: 'OBJ_OBSIDIENNE', resource: 'obsidienne', amount: 3, pdv: 3, label: '3 Obsidienne', emoji: '‚¨õ' }];
const MAJOR_EVENTS = ["üé≠ La Fresque s'illumine ! Tous les joueurs gagnent +2 Or.", "üé≠ Un tremblement secoue le plateau ! Chaque joueur perd 1 ressource.", "üé≠ B√©n√©diction divine ! Le joueur actif gagne une B√©n√©diction.", "üé≠ Mal√©diction ancestrale ! Le joueur en t√™te re√ßoit une Mal√©diction.", "üé≠ Pluie de ressources !", "üé≠ March√© noir ! Les √©changes co√ªtent 50% moins cher.", "üé≠ Rage des monstres ! +2 difficult√© ce tour.", "üé≠ Faveur des dieux ! +3 au prochain jet.", "üé≠ Eclipse totale ! Mal√©dictions lev√©es.", "üé≠ R√©surrection !"];
const RESOURCE_MAPPING = { "Pi√®ce d'Or": { key: "or" }, "Ecorce Cuivr√©e": { key: "cuivre" }, "Sable Argent√©": { key: "argent" }, "Roche Obsidienne": { key: "obsidienne" } };
const BASE_GOLD = 10;

const CHARACTERS = {
  CHASSEUR: { name: "Le Chasseur", pvMax: 6, role: "Harceleur ‚Äì Qu√™tes ‚Äì Combat √† distance", concept: "Sp√©cialiste du contr√¥le spatial.", skills: ["Attaque √† distance", "Aucun d√©g√¢t de riposte √† distance", "+1 permanent √† distance"] },
  MARCHAND: { name: "Le Marchand", pvMax: 6, role: "√âconomie ‚Äì Monopoles", concept: "Transforme l'or en levier strat√©gique.", skills: ["+4 Or au d√©part et √† chaque D√©part", "Ach√®te territoires neutres", "Ach√®te territoires adverses pour 10 Or"] },
  HOMME_BETE: { name: "L'Homme-b√™te", pvMax: 10, role: "Berserker ‚Äì Combat prolong√©", concept: "Convertit sa vitalit√© en puissance.", skills: ["Sacrifie des PV pour +jet", "Se soigne de 2 PV sur attaque r√©ussie", "Inflige 1 d√©g√¢t de riposte"] },
  CHEVALIER: { name: "Le Chevalier", pvMax: 10, role: "Conqu√™te ‚Äì Contr√¥le de carte", concept: "Chaque victoire = expansion.", skills: ["Capture le territoire adverse", "+1 vs territoires neutres", "+1 PDV/biome en fin de partie"] },
  VICAIRE: { name: "Le Vicaire", pvMax: 8, role: "Support ‚Äì Optimisation", concept: "Manipule la chance.", skills: ["Relance la stat (co√ªt: 1 ressource)", "B√©n√©diction", "+1 PDV par qu√™te"] },
  HERETIQUE: { name: "L'H√©r√©tique", pvMax: 8, role: "Sabotage ‚Äì Assassinat", concept: "Affaiblit avant d'achever.", skills: ["Choisit la stat en attaque joueur", "Mal√©diction (co√ªt: 3 PV)", "+1 PDV sur kill maudit"] }
};

const ANOMALIES = ["Soignez 2 [Point de vie].", "Soignez 4 [Point de vie].", "Soignez 6 [Point de vie].", "Perdez 2 [Point de vie].", "Perdez 4 [Point de vie].", "Perdez 6 [Point de vie].", "Obtenez [B√©n√©diction].", "Obtenez [B√©n√©diction].", "Obtenez [Mal√©diction].", "Obtenez [Mal√©diction].", "Gagnez 8 [Pi√®ce d'Or].", "Gagnez 4 [Pi√®ce d'Or].", "Gagnez 3 [Ecorce Cuivr√©e].", "Gagnez 2 [Sable Argent√©].", "Gagnez 1 [Roche Obsidienne].", "Perdez 4 [Pi√®ce d'Or].", "Perdez 2 [Ecorce Cuivr√©e].", "Perdez 1 [Sable Argent√©]."];
const QUETES = ["Dans le territoire [For√™t], difficult√© 6 pour 3 [Point de victoire].", "Dans le territoire [For√™t], difficult√© 8 pour 4 [Point de victoire].", "Dans le territoire [D√©sert], difficult√© 6 pour 3 [Point de victoire].", "Dans le territoire [D√©sert], difficult√© 8 pour 4 [Point de victoire].", "Dans le territoire [Montagne], difficult√© 6 pour 3 [Point de victoire].", "Dans le territoire [Montagne], difficult√© 10 pour 5 [Point de victoire].", "Echanger 8 [Pi√®ce d'Or] contre 2 [Point de victoire].", "Echanger 4 [Pi√®ce d'Or] contre 1 [Point de victoire].", "Echanger 6 [Ecorce Cuivr√©e] contre 2 [Point de victoire].", "Echanger 3 [Ecorce Cuivr√©e] contre 1 [Point de victoire].", "Echanger 4 [Sable Argent√©] contre 2 [Point de victoire].", "Echanger 2 [Sable Argent√©] contre 1 [Point de victoire].", "Echanger 2 [Roche Obsidienne] contre 2 [Point de victoire].", "Echanger 1 [Roche Obsidienne] contre 1 [Point de victoire]."];

// ============= RULES ENGINE =============
const rulesEngine = {
  getAttackBonus: (player, ctx) => { let bonus = 0; if (player.characterKey === 'CHASSEUR' && ctx.isRanged) bonus += 1; if (player.characterKey === 'CHEVALIER' && ctx.isNeutral) bonus += 1; return { bonus }; },
  getHealOnSuccess: (player) => player.characterKey === 'HOMME_BETE' ? 2 : 0,
  getKillBonus: (player, defender) => player.characterKey === 'HERETIQUE' && (defender.effects||[]).some(e => e.type === 'CURSE') ? 1 : 0,
  getQuestBonus: (player) => player.characterKey === 'VICAIRE' ? 1 : 0,
  getStartGold: (charKey) => charKey === 'MARCHAND' ? BASE_GOLD + 4 : BASE_GOLD,
  getPassBonus: (player) => player.characterKey === 'MARCHAND' ? { or: 4 } : {},
  canChooseStat: (player) => player.characterKey === 'HERETIQUE',
  canSacrificePv: (player) => player.characterKey === 'HOMME_BETE',
  canAttackRanged: (player) => player.characterKey === 'CHASSEUR',
  canBuyTerritory: (player) => player.characterKey === 'MARCHAND',
  canReroll: (player) => player.characterKey === 'VICAIRE',
  canBless: (player) => player.characterKey === 'VICAIRE',
  canCurse: (player) => player.characterKey === 'HERETIQUE'
};

// ============= HELPERS =============
function parseAnomaly(text) {
  let m;
  if (m = text.match(/Soignez (\d+)/)) return { type: 'heal', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Point de vie\]/)) return { type: 'damage', amount: +m[1] };
  if (text.includes('[B√©n√©diction]')) { const stats = Object.keys(STAT_NAMES); return { type: 'bless', stat: stats[Math.floor(Math.random() * stats.length)] }; }
  if (text.includes('[Mal√©diction]')) { const stats = Object.keys(STAT_NAMES); return { type: 'curse', stat: stats[Math.floor(Math.random() * stats.length)] }; }
  if (m = text.match(/Gagnez (\d+) \[Pi√®ce/)) return { type: 'gain', resource: 'or', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Ecorce/)) return { type: 'gain', resource: 'cuivre', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Sable/)) return { type: 'gain', resource: 'argent', amount: +m[1] };
  if (m = text.match(/Gagnez (\d+) \[Roche/)) return { type: 'gain', resource: 'obsidienne', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Pi√®ce/)) return { type: 'lose', resource: 'or', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Ecorce/)) return { type: 'lose', resource: 'cuivre', amount: +m[1] };
  if (m = text.match(/Perdez (\d+) \[Sable/)) return { type: 'lose', resource: 'argent', amount: +m[1] };
  return { type: 'other' };
}

function parseQuest(text) {
  const pdvMatch = text.match(/(\d+) \[Point de victoire\]/);
  const pdv = pdvMatch ? +pdvMatch[1] : 0;
  const exchMatch = text.match(/Echanger (\d+) \[(.+?)\] contre/);
  if (exchMatch) { const resInfo = RESOURCE_MAPPING[exchMatch[2]]; return { pdv, isExchange: true, isCombat: false, resourceKey: resInfo?.key, resourceAmount: +exchMatch[1] }; }
  const combatMatch = text.match(/difficult√© (\d+) pour/);
  if (combatMatch) { const stats = Object.keys(STAT_NAMES); return { pdv, isExchange: false, isCombat: true, difficulty: +combatMatch[1], stat: stats[Math.floor(Math.random() * stats.length)] }; }
  return { pdv, isExchange: false, isCombat: false };
}

function countTerritoriesByBiome(territories) { const c = { FORET: 0, DESERT: 0, MONTAGNE: 0 }; (territories || []).forEach(t => { if (c[t.biome] !== undefined) c[t.biome]++; }); return c; }
function genCode() { const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let c = ''; for (let i = 0; i < 6; i++) c += chars[Math.floor(Math.random() * chars.length)]; return c; }
function ensureArray(data, len = 0) { if (Array.isArray(data)) return data; if (data && typeof data === 'object') return Object.values(data); return len > 0 ? Array(len).fill(null) : []; }
function getRandomResource(player) { const a = []; if (player.or > 0) a.push('or'); if (player.cuivre > 0) a.push('cuivre'); if (player.argent > 0) a.push('argent'); if (player.obsidienne > 0) a.push('obsidienne'); return a.length > 0 ? a[Math.floor(Math.random() * a.length)] : null; }

// ============= MAIN APP =============
function App() {
  const [userId, setUserId] = useState(null);
  const [screen, setScreen] = useState('home');
  const [gameCode, setGameCode] = useState(null);
  const [gameState, setGameState] = useState(null);
  const [playerIndex, setPlayerIndex] = useState(-1);
  const [gamesList, setGamesList] = useState([]);

  useEffect(() => { 
    console.log("Tentative de connexion Firebase...");
    auth.signInAnonymously()
      .then(cred => {
        console.log("Connexion r√©ussie:", cred.user.uid);
        setUserId(cred.user.uid);
      })
      .catch(err => {
        console.error("Erreur de connexion Firebase:", err);
        alert("Erreur de connexion: " + err.message + "\n\nV√©rifiez que Firebase est correctement configur√©.");
      });
  }, []);

  useEffect(() => {
    if (!gameCode) return;
    const ref = db.ref(`games/${gameCode}`);
    const unsub = ref.on('value', snap => {
      const data = snap.val();
      if (data) {
        data.players = ensureArray(data.players, data.playerCount);
        data.selectedCharacters = ensureArray(data.selectedCharacters);
        data.drawnAnomalies = ensureArray(data.drawnAnomalies);
        data.drawnQuetes = ensureArray(data.drawnQuetes);
        data.completedObjectives = ensureArray(data.completedObjectives);
        data.activeEvents = ensureArray(data.activeEvents);
        setGameState(data);
        if (data.players && userId) { const idx = data.players.findIndex(p => p && p.odId === userId); if (idx >= 0) setPlayerIndex(idx); }
      }
    });
    return () => ref.off('value', unsub);
  }, [gameCode, userId]);

  useEffect(() => { if (userId) loadGamesList(); }, [userId]);

  const loadGamesList = async () => {
    const snap = await db.ref('games').orderByChild('createdAt').limitToLast(50).once('value');
    const games = [];
    snap.forEach(child => { const g = child.val(); if (g && g.players) { const players = ensureArray(g.players); if (players.some(p => p && p.odId === userId)) games.push({ code: child.key, ...g }); } });
    setGamesList(games.reverse());
  };

  const createGame = async (playerCount) => {
    const code = genCode();
    await db.ref(`games/${code}`).set({ code, playerCount, step: 'lobby', currentTurn: 0, players: Array(playerCount).fill(null), selectedCharacters: [], drawnAnomalies: [], drawnQuetes: [], completedObjectives: [], activeEvents: [], eventBonus: 0, lastEventThreshold: 0, createdAt: Date.now() });
    setGameCode(code); setPlayerIndex(-1); setScreen('lobby');
  };

  const joinGame = async (code) => {
    const snap = await db.ref(`games/${code}`).once('value');
    if (!snap.exists()) { alert("Partie non trouv√©e !"); return; }
    setGameCode(code); setScreen('lobby');
  };

  const joinAsPlayer = async (slot, name, charKey) => {
    const character = CHARACTERS[charKey];
    const newPlayer = { id: `player_${slot}`, odId: userId, playerName: name, characterKey: charKey, character, pvCurrent: character.pvMax, or: rulesEngine.getStartGold(charKey), cuivre: 0, argent: 0, obsidienne: 0, pdv: 0, pdvHistory: [], tourPlateau: 0, baseStats: null, effects: [], quests: [], territories: [], defeatedBosses: [], skills: character.skills.map((s, i) => ({ id: `skill_${i}`, description: s })), usedAttackDice: false, rerollAvailable: true, blessAvailable: charKey === 'VICAIRE', curseAvailable: charKey === 'HERETIQUE', ready: false };
    await db.ref(`games/${gameCode}`).update({ [`players/${slot}`]: newPlayer, selectedCharacters: [...(gameState.selectedCharacters || []), charKey] });
    setPlayerIndex(slot);
  };

  const allocateStats = async (stats) => { await db.ref(`games/${gameCode}/players/${playerIndex}`).update({ baseStats: stats, ready: true }); };

  const startGame = async () => {
    const players = ensureArray(gameState.players, gameState.playerCount);
    if (!players.every(p => p && p.ready && p.baseStats)) { alert("Tous les joueurs doivent √™tre pr√™ts !"); return; }
    await db.ref(`games/${gameCode}`).update({ step: 'play' });
  };

  const updateGame = async (updates) => { await db.ref(`games/${gameCode}`).update(updates); };
  const updatePlayer = async (idx, updates) => { await db.ref(`games/${gameCode}/players/${idx}`).update(updates); };

  const addPdvWithHistory = async (idx, amount, source, details = {}) => {
    const player = gameState.players[idx]; if (!player) return;
    const newHistory = [...(player.pdvHistory || []), { id: `pdv_${Date.now()}`, amount, source, details, timestamp: Date.now() }];
    await updatePlayer(idx, { pdv: player.pdv + amount, pdvHistory: newHistory });
    const totalPdv = gameState.players.reduce((s, p) => s + (p?.pdv || 0), 0) + amount;
    const newThreshold = Math.floor(totalPdv / 10);
    if (newThreshold > (gameState.lastEventThreshold || 0)) {
      const eventText = MAJOR_EVENTS[Math.floor(Math.random() * MAJOR_EVENTS.length)];
      await updateGame({ lastEventThreshold: newThreshold, pendingEvent: { text: eventText, threshold: newThreshold * 10 } });
    }
  };

  const nextTurn = async () => {
    const players = ensureArray(gameState.players, gameState.playerCount);
    const currentIdx = gameState.currentTurn;
    if (players[currentIdx]) await updatePlayer(currentIdx, { usedAttackDice: false, rerollAvailable: true });
    await updateGame({ currentTurn: (currentIdx + 1) % gameState.playerCount, eventBonus: 0 });
  };

  const clearPendingEvent = async () => { await updateGame({ pendingEvent: null }); };

  const deleteGame = async () => { if (confirm("Supprimer cette partie ?")) { await db.ref(`games/${gameCode}`).remove(); setGameCode(null); setGameState(null); setPlayerIndex(-1); setScreen('home'); loadGamesList(); } };

  if (!userId) return React.createElement("div", { className: "min-h-screen bg-purple-900 flex items-center justify-center flex-col gap-4" }, 
    React.createElement("div", { className: "text-white text-xl animate-pulse" }, "Connexion..."),
    React.createElement("div", { className: "text-purple-300 text-sm" }, "Si √ßa reste bloqu√©, ouvrez la console (F12) pour voir les erreurs"));
  if (screen === 'home') return React.createElement(HomeScreen, { onNewGame: () => setScreen('setup'), onJoinGame: () => setScreen('join'), gamesList, onLoadGame: joinGame, onRefresh: loadGamesList });
  if (screen === 'setup') return React.createElement(SetupScreen, { onComplete: createGame, onBack: () => setScreen('home') });
  if (screen === 'join') return React.createElement(JoinScreen, { onJoin: joinGame, onBack: () => setScreen('home') });
  if (!gameState) return React.createElement("div", { className: "min-h-screen bg-purple-900 flex items-center justify-center" }, React.createElement("div", { className: "text-white text-xl animate-pulse" }, "Chargement..."));
  if (gameState.step === 'lobby') return React.createElement(LobbyScreen, { gameState, gameCode, userId, playerIndex, onJoinAsPlayer: joinAsPlayer, onAllocateStats: allocateStats, onStartGame: startGame, onBack: () => { setGameCode(null); setGameState(null); setScreen('home'); } });
  if (gameState.step === 'play') {
    const players = ensureArray(gameState.players, gameState.playerCount);
    return React.createElement(TurnGameScreen, { gameState, gameCode, currentPlayer: players[playerIndex], playerIndex, isMyTurn: gameState.currentTurn === playerIndex, userId, updatePlayer, updateGame, addPdvWithHistory, nextTurn, clearPendingEvent, onDelete: deleteGame, onBack: () => { setGameCode(null); setGameState(null); setScreen('home'); loadGamesList(); } });
  }
  return null;
}

// ============= SCREENS =============
function HomeScreen({ onNewGame, onJoinGame, gamesList, onLoadGame, onRefresh }) {
  return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-purple-900 to-indigo-900 p-4" },
    React.createElement("div", { className: "max-w-md mx-auto" },
      React.createElement("div", { className: "text-center mb-8 pt-8" },
        React.createElement("h1", { className: "text-4xl font-bold text-white mb-2" }, "üé¥ Qu√™tes d'Anomalies"),
        React.createElement("p", { className: "text-purple-300" }, "Firebase Multijoueur v3.0")
      ),
      React.createElement("div", { className: "space-y-4" },
        React.createElement("button", { onClick: onNewGame, className: "w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold text-lg shadow-lg" }, "üéÆ Nouvelle Partie"),
        React.createElement("button", { onClick: onJoinGame, className: "w-full py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold text-lg shadow-lg" }, "üîó Rejoindre")
      ),
      gamesList.length > 0 && React.createElement("div", { className: "mt-8" },
        React.createElement("div", { className: "flex justify-between items-center mb-3" },
          React.createElement("h2", { className: "text-xl font-bold text-white" }, "üìã Mes Parties"),
          React.createElement("button", { onClick: onRefresh, className: "text-purple-300 text-sm" }, "üîÑ Actualiser")
        ),
        React.createElement("div", { className: "space-y-2" },
          gamesList.slice(0, 5).map(g => React.createElement("button", { key: g.code, onClick: () => onLoadGame(g.code), className: "w-full p-3 bg-white bg-opacity-10 rounded-lg text-left" },
            React.createElement("div", { className: "flex justify-between items-center" },
              React.createElement("span", { className: "text-white font-mono" }, g.code),
              React.createElement("span", { className: `text-sm ${g.step === 'play' ? 'text-green-400' : 'text-yellow-400'}` }, g.step === 'play' ? '‚ñ∂Ô∏è En cours' : '‚è≥ Lobby')
            ),
            React.createElement("div", { className: "text-purple-300 text-sm mt-1" }, `${ensureArray(g.players).filter(p => p).length}/${g.playerCount} joueurs`)
          ))
        )
      )
    )
  );
}

function SetupScreen({ onComplete, onBack }) {
  return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-purple-900 to-indigo-900 p-4" },
    React.createElement("div", { className: "max-w-md mx-auto pt-8" },
      React.createElement("button", { onClick: onBack, className: "text-white mb-4" }, "‚Üê Retour"),
      React.createElement("h2", { className: "text-2xl font-bold text-white text-center mb-6" }, "Nombre de joueurs"),
      React.createElement("div", { className: "grid grid-cols-2 gap-4" },
        [2, 3, 4, 5, 6].map(n => React.createElement("button", { key: n, onClick: () => onComplete(n), className: "py-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold text-2xl" }, `${n} üë•`))
      )
    )
  );
}

function JoinScreen({ onJoin, onBack }) {
  const [code, setCode] = useState('');
  return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-purple-900 to-indigo-900 p-4" },
    React.createElement("div", { className: "max-w-md mx-auto pt-8" },
      React.createElement("button", { onClick: onBack, className: "text-white mb-4" }, "‚Üê Retour"),
      React.createElement("h2", { className: "text-2xl font-bold text-white text-center mb-6" }, "Code de la partie"),
      React.createElement("input", { value: code, onChange: e => setCode(e.target.value.toUpperCase()), placeholder: "CODE", maxLength: 6, className: "w-full p-4 text-center text-2xl font-mono rounded-xl mb-4" }),
      React.createElement("button", { onClick: () => code.length === 6 && onJoin(code), disabled: code.length !== 6, className: `w-full py-4 rounded-xl font-bold text-lg ${code.length === 6 ? 'bg-green-600 text-white' : 'bg-gray-400 text-gray-600'}` }, "Rejoindre")
    )
  );
}

function LobbyScreen({ gameState, gameCode, userId, playerIndex, onJoinAsPlayer, onAllocateStats, onStartGame, onBack }) {
  const [name, setName] = useState('');
  const [selectedChar, setSelectedChar] = useState(null);
  const [statScreen, setStatScreen] = useState(false);
  const players = ensureArray(gameState.players, gameState.playerCount);
  const takenChars = ensureArray(gameState.selectedCharacters);
  const myPlayer = playerIndex >= 0 ? players[playerIndex] : null;
  const allReady = players.every(p => p && p.ready && p.baseStats);
  const isHost = players.findIndex(p => p) === playerIndex;

  if (myPlayer && !myPlayer.baseStats && statScreen) {
    return React.createElement(StatAllocationScreen, { player: myPlayer, onComplete: onAllocateStats, onBack: () => setStatScreen(false) });
  }

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-purple-900 to-indigo-900 p-4" },
    React.createElement("div", { className: "max-w-md mx-auto pt-4" },
      React.createElement("button", { onClick: onBack, className: "text-white mb-4" }, "‚Üê Quitter"),
      React.createElement("div", { className: "bg-white bg-opacity-10 rounded-xl p-4 mb-4 text-center" },
        React.createElement("p", { className: "text-purple-300 text-sm" }, "Code de la partie"),
        React.createElement("p", { className: "text-3xl font-mono font-bold text-white" }, gameCode)
      ),
      React.createElement("div", { className: "space-y-2 mb-6" },
        players.map((p, i) => React.createElement("div", { key: i, className: `p-3 rounded-lg ${p ? (p.ready ? 'bg-green-600' : 'bg-blue-600') : 'bg-gray-600'} text-white` },
          p ? React.createElement("div", { className: "flex justify-between items-center" },
            React.createElement("span", null, `${p.playerName} - ${p.character?.name}`),
            React.createElement("span", null, p.ready ? '‚úÖ' : '‚è≥')
          ) : React.createElement("span", { className: "text-gray-300" }, `Slot ${i + 1} - Libre`)
        ))
      ),
      playerIndex < 0 && React.createElement("div", { className: "bg-white rounded-xl p-4 space-y-4" },
        React.createElement("input", { value: name, onChange: e => setName(e.target.value), placeholder: "Votre nom", className: "w-full p-3 border rounded-lg" }),
        React.createElement("div", { className: "grid grid-cols-2 gap-2" },
          Object.entries(CHARACTERS).map(([k, c]) => React.createElement("button", { key: k, onClick: () => setSelectedChar(k), disabled: takenChars.includes(k), className: `p-2 rounded-lg text-sm font-semibold ${selectedChar === k ? 'bg-purple-600 text-white' : takenChars.includes(k) ? 'bg-gray-300 text-gray-500' : 'bg-gray-100'}` }, c.name))
        ),
        React.createElement("button", { onClick: () => { const slot = players.findIndex(p => !p); if (slot >= 0 && name && selectedChar) onJoinAsPlayer(slot, name, selectedChar); }, disabled: !name || !selectedChar, className: `w-full py-3 rounded-lg font-bold ${name && selectedChar ? 'bg-green-600 text-white' : 'bg-gray-300'}` }, "Rejoindre")
      ),
      myPlayer && !myPlayer.baseStats && React.createElement("button", { onClick: () => setStatScreen(true), className: "w-full py-4 bg-yellow-500 text-white rounded-xl font-bold" }, "‚öôÔ∏è R√©partir les stats"),
      myPlayer && myPlayer.baseStats && !myPlayer.ready && React.createElement("p", { className: "text-center text-green-400" }, "‚úÖ Pr√™t !"),
      isHost && allReady && React.createElement("button", { onClick: onStartGame, className: "w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold mt-4" }, "üöÄ Lancer la partie")
    )
  );
}

function StatAllocationScreen({ player, onComplete, onBack }) {
  const [stats, setStats] = useState({ endurance: 0, force: 0, vitesse: 0, perception: 0, sagesse: 0, intelligence: 0 });
  const total = Object.values(stats).reduce((a, b) => a + b, 0);
  const maxPoints = 15;

  const adjust = (stat, delta) => {
    const newVal = stats[stat] + delta;
    if (newVal >= 0 && newVal <= 6 && total + delta <= maxPoints) setStats({ ...stats, [stat]: newVal });
  };

  return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-purple-900 to-indigo-900 p-4" },
    React.createElement("div", { className: "max-w-md mx-auto pt-4" },
      React.createElement("button", { onClick: onBack, className: "text-white mb-4" }, "‚Üê Retour"),
      React.createElement("h2", { className: "text-xl font-bold text-white text-center mb-2" }, "R√©partir vos statistiques"),
      React.createElement("div", { className: "text-center mb-4" },
        React.createElement("span", { className: `text-2xl font-bold ${total === maxPoints ? 'text-green-400' : 'text-yellow-400'}` }, `${total}/${maxPoints}`)
      ),
      React.createElement("div", { className: "space-y-3" },
        Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("div", { key: k, className: "bg-white bg-opacity-10 rounded-lg p-3 flex items-center justify-between" },
          React.createElement("span", { className: "text-white font-semibold" }, n),
          React.createElement("div", { className: "flex items-center gap-3" },
            React.createElement("button", { onClick: () => adjust(k, -1), className: "w-10 h-10 bg-red-600 text-white rounded-full font-bold" }, "-"),
            React.createElement("span", { className: "text-white text-xl font-bold w-8 text-center" }, stats[k]),
            React.createElement("button", { onClick: () => adjust(k, 1), className: "w-10 h-10 bg-green-600 text-white rounded-full font-bold" }, "+")
          )
        ))
      ),
      React.createElement("button", { onClick: () => total === maxPoints && onComplete(stats), disabled: total !== maxPoints, className: `w-full py-4 rounded-xl font-bold mt-6 ${total === maxPoints ? 'bg-green-600 text-white' : 'bg-gray-400'}` }, "Confirmer")
    )
  );
}

// ============= TURN GAME SCREEN =============
function TurnGameScreen({ gameState, gameCode, currentPlayer, playerIndex, isMyTurn, userId, updatePlayer, updateGame, addPdvWithHistory, nextTurn, clearPendingEvent, onDelete, onBack }) {
  const [activeTab, setActiveTab] = useState('tirages');
  const players = ensureArray(gameState.players, gameState.playerCount);
  const currentTurnPlayer = players[gameState.currentTurn];

  // Death overlay
  if (currentPlayer && currentPlayer.pvCurrent <= 0) {
    const respawn = async () => {
      await updatePlayer(playerIndex, { pvCurrent: Math.ceil(currentPlayer.character.pvMax / 2), or: Math.max(0, currentPlayer.or - 5), tourPlateau: currentPlayer.tourPlateau + 1 });
    };
    return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-gray-900 to-black flex items-center justify-center p-4" },
      React.createElement("div", { className: "bg-red-900 bg-opacity-50 rounded-2xl p-8 text-center max-w-sm" },
        React.createElement("div", { className: "text-6xl mb-4" }, "üíÄ"),
        React.createElement("h2", { className: "text-3xl font-bold text-white mb-4" }, "Vous √™tes mort !"),
        React.createElement("p", { className: "text-gray-300 mb-6" }, "R√©surrection: 50% PV, -5 Or"),
        React.createElement("button", { onClick: respawn, className: "w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-bold" }, "üîÑ Ressusciter")
      )
    );
  }

  // Start of turn overlay
  const [showStartOverlay, setShowStartOverlay] = useState(false);
  useEffect(() => { if (isMyTurn && currentPlayer && !currentPlayer.usedAttackDice) setShowStartOverlay(true); }, [gameState.currentTurn]);

  const handlePassDepart = async () => {
    const bonus = rulesEngine.getPassBonus(currentPlayer);
    const updates = { tourPlateau: currentPlayer.tourPlateau + 1, or: currentPlayer.or + 2 + (bonus.or || 0) };
    await updatePlayer(playerIndex, updates);
    setShowStartOverlay(false);
  };

  if (showStartOverlay && isMyTurn) {
    return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-purple-900 to-indigo-900 flex items-center justify-center p-4" },
      React.createElement("div", { className: "bg-white rounded-2xl p-6 max-w-sm w-full text-center" },
        React.createElement("div", { className: "text-5xl mb-4" }, "üéØ"),
        React.createElement("h2", { className: "text-2xl font-bold text-gray-800 mb-2" }, "C'est votre tour !"),
        React.createElement("p", { className: "text-gray-600 mb-4" }, `Tour de plateau: ${currentPlayer.tourPlateau}`),
        React.createElement("div", { className: "space-y-3" },
          React.createElement("button", { onClick: handlePassDepart, className: "w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-xl font-bold" }, `üèÅ Passer D√©part (+2 Or${currentPlayer.characterKey === 'MARCHAND' ? ' +4 Marchand' : ''})`),
          React.createElement("button", { onClick: () => setShowStartOverlay(false), className: "w-full py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold" }, "Continuer")
        )
      )
    );
  }

  // Event overlay
  if (gameState.pendingEvent) {
    return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-yellow-600 to-orange-700 flex items-center justify-center p-4" },
      React.createElement("div", { className: "bg-white rounded-2xl p-6 max-w-sm w-full text-center" },
        React.createElement("div", { className: "text-5xl mb-4" }, "üé≠"),
        React.createElement("h2", { className: "text-xl font-bold text-gray-800 mb-4" }, `Seuil ${gameState.pendingEvent.threshold} PDV atteint !`),
        React.createElement("p", { className: "text-gray-700 mb-6" }, gameState.pendingEvent.text),
        React.createElement("button", { onClick: clearPendingEvent, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-bold" }, "Continuer")
      )
    );
  }

  // End game check
  const totalPdv = players.reduce((s, p) => s + (p?.pdv || 0), 0);
  const targetPdv = gameState.playerCount * 10;
  if (totalPdv >= targetPdv) {
    const ranking = [...players].filter(p => p).sort((a, b) => (b?.pdv || 0) - (a?.pdv || 0));
    const winner = ranking[0];
    return React.createElement("div", { className: "min-h-screen bg-gradient-to-b from-yellow-500 to-orange-600 flex items-center justify-center p-4" },
      React.createElement("div", { className: "bg-white rounded-2xl p-6 max-w-sm w-full text-center" },
        React.createElement("div", { className: "text-6xl mb-4" }, "üèÜ"),
        React.createElement("h2", { className: "text-3xl font-bold text-gray-800 mb-2" }, "Partie Termin√©e !"),
        React.createElement("p", { className: "text-xl text-purple-600 font-bold mb-4" }, `${winner?.playerName} gagne !`),
        React.createElement("div", { className: "space-y-2 mb-6" },
          ranking.map((p, i) => React.createElement("div", { key: p?.id, className: "flex justify-between p-2 bg-gray-100 rounded-lg" },
            React.createElement("span", null, `#${i + 1} ${p?.playerName}`),
            React.createElement("span", { className: "font-bold" }, `${p?.pdv} PDV`)
          ))
        ),
        React.createElement("button", { onClick: onBack, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-bold" }, "Retour")
      )
    );
  }

  const tabs = [
    { id: 'tirages', label: 'üé¥', name: 'Tirages' },
    { id: 'de', label: 'üé≤', name: 'D√©' },
    { id: 'attaque', label: '‚öîÔ∏è', name: 'Attaque' },
    { id: 'objectif', label: 'üéØ', name: 'Objectif' },
    { id: 'echange', label: 'üîÑ', name: '√âchange' },
    { id: 'pari', label: 'üé∞', name: 'Pari' },
    { id: 'event', label: 'üé≠', name: 'Event' },
    { id: 'perso', label: 'üë§', name: 'Perso' },
    { id: 'pdv', label: 'üèÜ', name: 'PDV' }
  ];

  return React.createElement("div", { className: "min-h-screen bg-gray-100 pb-20" },
    // Header
    React.createElement("div", { className: "bg-gradient-to-r from-purple-700 to-indigo-700 text-white p-3" },
      React.createElement("div", { className: "flex justify-between items-center max-w-md mx-auto" },
        React.createElement("div", null,
          React.createElement("div", { className: "font-bold" }, currentPlayer?.playerName),
          React.createElement("div", { className: "text-sm opacity-80" }, currentPlayer?.character?.name)
        ),
        React.createElement("div", { className: "text-right" },
          React.createElement("div", { className: "flex gap-2 text-sm" },
            React.createElement("span", null, `‚ù§Ô∏è${currentPlayer?.pvCurrent}/${currentPlayer?.character?.pvMax}`),
            React.createElement("span", null, `üèÜ${currentPlayer?.pdv}`)
          ),
          React.createElement("div", { className: "flex gap-1 text-xs" },
            React.createElement("span", null, `üí∞${currentPlayer?.or}`),
            React.createElement("span", null, `ü•â${currentPlayer?.cuivre}`),
            React.createElement("span", null, `ü•à${currentPlayer?.argent}`),
            React.createElement("span", null, `‚¨õ${currentPlayer?.obsidienne}`)
          )
        )
      )
    ),
    // Turn indicator
    React.createElement("div", { className: `text-center py-2 ${isMyTurn ? 'bg-green-500 text-white' : 'bg-yellow-100 text-yellow-800'}` },
      isMyTurn ? "üéØ C'est votre tour !" : `‚è≥ Tour de ${currentTurnPlayer?.playerName}`
    ),
    // Tab content
    React.createElement("div", { className: "p-4 max-w-md mx-auto" },
      activeTab === 'tirages' && React.createElement(TiragesTab, { gameState, player: currentPlayer, playerIndex, isMyTurn, updatePlayer, updateGame }),
      activeTab === 'de' && React.createElement(DeTab, { player: currentPlayer, playerIndex, isMyTurn, updatePlayer, gameState }),
      activeTab === 'attaque' && React.createElement(AttaqueTab, { gameState, player: currentPlayer, playerIndex, isMyTurn, updatePlayer, updateGame, addPdvWithHistory, players }),
      activeTab === 'objectif' && React.createElement(ObjectifTab, { gameState, player: currentPlayer, playerIndex, isMyTurn, updatePlayer, updateGame, addPdvWithHistory }),
      activeTab === 'echange' && React.createElement(EchangeTab, { player: currentPlayer, playerIndex, isMyTurn, updatePlayer }),
      activeTab === 'pari' && React.createElement(PariTab, { gameState, player: currentPlayer, playerIndex, isMyTurn, updatePlayer, updateGame, players }),
      activeTab === 'event' && React.createElement(EventTab, { gameState, updateGame, isMyTurn }),
      activeTab === 'perso' && React.createElement(PersonnageTab, { player: currentPlayer, playerIndex, isMyTurn, updatePlayer }),
      activeTab === 'pdv' && React.createElement(PdvHistoryTab, { player: currentPlayer, gameState, players })
    ),
    // End turn button
    isMyTurn && React.createElement("div", { className: "fixed bottom-16 left-0 right-0 p-2 bg-white border-t" },
      React.createElement("button", { onClick: nextTurn, className: "w-full max-w-md mx-auto block py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold" }, "‚úÖ Fin du Tour")
    ),
    // Tab bar
    React.createElement("div", { className: "fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2" },
      tabs.map(t => React.createElement("button", { key: t.id, onClick: () => setActiveTab(t.id), className: `flex flex-col items-center px-2 ${activeTab === t.id ? 'text-purple-600' : 'text-gray-400'}` },
        React.createElement("span", { className: "text-lg" }, t.label),
        React.createElement("span", { className: "text-xs" }, t.name)
      ))
    )
  );
}

// ============= TIRAGES TAB =============
function TiragesTab({ gameState, player, playerIndex, isMyTurn, updatePlayer, updateGame }) {
  const [subTab, setSubTab] = useState('anomalie');
  const [drawnCard, setDrawnCard] = useState(null);
  const [processing, setProcessing] = useState(false);

  const drawAnomaly = async () => {
    if (!isMyTurn || processing) return;
    setProcessing(true);
    const available = ANOMALIES.filter((_, i) => !(gameState.drawnAnomalies || []).includes(i));
    if (available.length === 0) { await updateGame({ drawnAnomalies: [] }); setProcessing(false); return; }
    const idx = ANOMALIES.indexOf(available[Math.floor(Math.random() * available.length)]);
    const card = ANOMALIES[idx];
    await updateGame({ drawnAnomalies: [...(gameState.drawnAnomalies || []), idx] });
    setDrawnCard({ type: 'anomalie', text: card, parsed: parseAnomaly(card) });
    setProcessing(false);
  };

  const drawQuest = async () => {
    if (!isMyTurn || processing) return;
    setProcessing(true);
    const available = QUETES.filter((_, i) => !(gameState.drawnQuetes || []).includes(i));
    if (available.length === 0) { await updateGame({ drawnQuetes: [] }); setProcessing(false); return; }
    const idx = QUETES.indexOf(available[Math.floor(Math.random() * available.length)]);
    const card = QUETES[idx];
    await updateGame({ drawnQuetes: [...(gameState.drawnQuetes || []), idx] });
    setDrawnCard({ type: 'quete', text: card, parsed: parseQuest(card) });
    setProcessing(false);
  };

  const applyAnomaly = async () => {
    if (!drawnCard || drawnCard.type !== 'anomalie') return;
    const p = drawnCard.parsed;
    const updates = {};
    if (p.type === 'heal') updates.pvCurrent = Math.min(player.character.pvMax, player.pvCurrent + p.amount);
    if (p.type === 'damage') updates.pvCurrent = Math.max(0, player.pvCurrent - p.amount);
    if (p.type === 'gain') updates[p.resource] = (player[p.resource] || 0) + p.amount;
    if (p.type === 'lose') updates[p.resource] = Math.max(0, (player[p.resource] || 0) - p.amount);
    if (p.type === 'bless') updates.effects = [...(player.effects || []), { id: `eff_${Date.now()}`, type: 'BLESS', name: 'B√©n√©diction', stat: p.stat, delta: 2 }];
    if (p.type === 'curse') updates.effects = [...(player.effects || []), { id: `eff_${Date.now()}`, type: 'CURSE', name: 'Mal√©diction', stat: p.stat, delta: -2 }];
    if (Object.keys(updates).length > 0) await updatePlayer(playerIndex, updates);
    setDrawnCard(null);
  };

  const keepQuest = async () => {
    if (!drawnCard || drawnCard.type !== 'quete') return;
    await updatePlayer(playerIndex, { quests: [...(player.quests || []), { id: `quest_${Date.now()}`, text: drawnCard.text, ...drawnCard.parsed }] });
    setDrawnCard(null);
  };

  if (drawnCard) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: `p-6 rounded-xl text-center ${drawnCard.type === 'anomalie' ? 'bg-gradient-to-r from-purple-600 to-pink-600' : 'bg-gradient-to-r from-amber-500 to-orange-500'} text-white` },
        React.createElement("div", { className: "text-4xl mb-3" }, drawnCard.type === 'anomalie' ? 'üåÄ' : 'üìú'),
        React.createElement("h3", { className: "text-xl font-bold mb-2" }, drawnCard.type === 'anomalie' ? 'Anomalie' : 'Qu√™te'),
        React.createElement("p", { className: "text-lg" }, drawnCard.text)
      ),
      drawnCard.type === 'anomalie' && React.createElement("button", { onClick: applyAnomaly, className: "w-full py-3 bg-purple-600 text-white rounded-xl font-bold" }, "Appliquer l'effet"),
      drawnCard.type === 'quete' && React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        React.createElement("button", { onClick: keepQuest, className: "py-3 bg-green-600 text-white rounded-xl font-bold" }, "Garder"),
        React.createElement("button", { onClick: () => setDrawnCard(null), className: "py-3 bg-gray-400 text-white rounded-xl font-bold" }, "D√©fausser")
      )
    );
  }

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("div", { className: "flex gap-2 mb-4" },
      React.createElement("button", { onClick: () => setSubTab('anomalie'), className: `flex-1 py-2 rounded-lg font-semibold ${subTab === 'anomalie' ? 'bg-purple-600 text-white' : 'bg-gray-200'}` }, "üåÄ Anomalies"),
      React.createElement("button", { onClick: () => setSubTab('quete'), className: `flex-1 py-2 rounded-lg font-semibold ${subTab === 'quete' ? 'bg-amber-500 text-white' : 'bg-gray-200'}` }, "üìú Qu√™tes")
    ),
    subTab === 'anomalie' && React.createElement("div", { className: "text-center" },
      React.createElement("div", { className: "bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl p-8 mb-4" },
        React.createElement("div", { className: "text-6xl mb-4" }, "üåÄ"),
        React.createElement("p", { className: "text-white text-lg" }, `${ANOMALIES.length - (gameState.drawnAnomalies || []).length} cartes restantes`)
      ),
      React.createElement("button", { onClick: drawAnomaly, disabled: !isMyTurn || processing, className: `w-full py-4 rounded-xl font-bold text-lg ${isMyTurn ? 'bg-purple-600 text-white' : 'bg-gray-300 text-gray-500'}` }, processing ? "..." : "Tirer une Anomalie")
    ),
    subTab === 'quete' && React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: "bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl p-8 text-center" },
        React.createElement("div", { className: "text-6xl mb-4" }, "üìú"),
        React.createElement("p", { className: "text-white text-lg" }, `${QUETES.length - (gameState.drawnQuetes || []).length} cartes restantes`)
      ),
      React.createElement("button", { onClick: drawQuest, disabled: !isMyTurn || processing, className: `w-full py-4 rounded-xl font-bold text-lg ${isMyTurn ? 'bg-amber-500 text-white' : 'bg-gray-300 text-gray-500'}` }, processing ? "..." : "Tirer une Qu√™te"),
      (player.quests || []).length > 0 && React.createElement("div", null,
        React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "Vos qu√™tes:"),
        React.createElement("div", { className: "space-y-2" },
          (player.quests || []).map(q => React.createElement("div", { key: q.id, className: "p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm" }, q.text))
        )
      )
    )
  );
}

// ============= DE TAB =============
function DeTab({ player, playerIndex, isMyTurn, updatePlayer, gameState }) {
  const [stat, setStat] = useState(null);
  const [rolling, setRolling] = useState(false);
  const [result, setResult] = useState(null);

  const roll = async (statKey) => {
    if (!isMyTurn) return;
    setStat(statKey);
    setRolling(true);
    await new Promise(r => setTimeout(r, 1000));
    const base = player.baseStats?.[statKey] || 0;
    const effectBonus = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const eventBonus = gameState.eventBonus || 0;
    const dice = Math.floor(Math.random() * 6) + 1;
    const total = base + effectBonus + eventBonus + dice;
    setResult({ stat: STAT_NAMES[statKey], base, effectBonus, eventBonus, dice, total });
    setRolling(false);
  };

  const reset = () => { setStat(null); setResult(null); };

  if (rolling) {
    return React.createElement("div", { className: "min-h-[300px] bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center" },
      React.createElement("div", { className: "text-white text-center" },
        React.createElement("div", { className: "text-6xl animate-spin mb-4" }, "üé≤"),
        React.createElement("p", { className: "text-xl" }, "Lancement...")
      )
    );
  }

  if (result) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: "bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white text-center" },
        React.createElement("h3", { className: "text-xl mb-2" }, result.stat),
        React.createElement("div", { className: "text-6xl font-bold mb-4" }, result.total),
        React.createElement("div", { className: "text-sm opacity-80" }, `Base: ${result.base} | D√©: ${result.dice}${result.effectBonus ? ` | Effets: ${result.effectBonus > 0 ? '+' : ''}${result.effectBonus}` : ''}${result.eventBonus ? ` | Event: +${result.eventBonus}` : ''}`)
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-3 bg-gray-600 text-white rounded-xl font-bold" }, "Nouveau jet")
    );
  }

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center text-gray-800" }, "üé≤ Lancer le D√©"),
    React.createElement("div", { className: "grid grid-cols-2 gap-3" },
      Object.entries(STAT_NAMES).map(([k, n]) => {
        const base = player.baseStats?.[k] || 0;
        const bonus = (player.effects || []).filter(e => e.stat === k).reduce((s, e) => s + e.delta, 0);
        return React.createElement("button", { key: k, onClick: () => roll(k), disabled: !isMyTurn, className: `p-4 rounded-xl text-center ${isMyTurn ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white' : 'bg-gray-300 text-gray-500'}` },
          React.createElement("div", { className: "font-bold" }, n),
          React.createElement("div", { className: "text-2xl" }, `${base}${bonus ? (bonus > 0 ? `+${bonus}` : bonus) : ''}`),
          React.createElement("div", { className: "text-xs opacity-80" }, "+ üé≤")
        );
      })
    )
  );
}

// ============= ATTAQUE TAB =============
function AttaqueTab({ gameState, player, playerIndex, isMyTurn, updatePlayer, updateGame, addPdvWithHistory, players }) {
  const [subTab, setSubTab] = useState('biome');
  return React.createElement("div", { className: "space-y-4" },
    React.createElement("div", { className: "flex gap-2 mb-4" },
      React.createElement("button", { onClick: () => setSubTab('biome'), className: `flex-1 py-2 rounded-lg font-semibold text-sm ${subTab === 'biome' ? 'bg-green-600 text-white' : 'bg-gray-200'}` }, "üè∞ Biome"),
      React.createElement("button", { onClick: () => setSubTab('boss'), className: `flex-1 py-2 rounded-lg font-semibold text-sm ${subTab === 'boss' ? 'bg-red-600 text-white' : 'bg-gray-200'}` }, "üêâ Boss"),
      React.createElement("button", { onClick: () => setSubTab('combat'), className: `flex-1 py-2 rounded-lg font-semibold text-sm ${subTab === 'combat' ? 'bg-orange-600 text-white' : 'bg-gray-200'}` }, "‚öîÔ∏è Combat")
    ),
    subTab === 'biome' && React.createElement(BiomeAttack, { gameState, player, playerIndex, isMyTurn, updatePlayer, addPdvWithHistory, players }),
    subTab === 'boss' && React.createElement(BossAttack, { gameState, player, playerIndex, isMyTurn, updatePlayer, addPdvWithHistory }),
    subTab === 'combat' && React.createElement(CombatAttack, { gameState, player, playerIndex, isMyTurn, updatePlayer, addPdvWithHistory, players })
  );
}

function BiomeAttack({ gameState, player, playerIndex, isMyTurn, updatePlayer, addPdvWithHistory, players }) {
  const [mode, setMode] = useState('select');
  const [target, setTarget] = useState(null);
  const [stat, setStat] = useState(null);
  const [rolling, setRolling] = useState(false);
  const [result, setResult] = useState(null);

  const biomeList = Object.entries(BIOMES).map(([k, b]) => ({ key: k, ...b, difficulty: 6 + (k === 'DESERT' ? 2 : k === 'MONTAGNE' ? 4 : 0) }));

  const selectBiome = (b) => { setTarget(b); setMode('stat'); };
  const chooseStat = (k, n) => { setStat({ key: k, name: n }); execute(target, k, n); };

  const execute = async (biome, statKey, statName) => {
    setMode('rolling'); setRolling(true);
    await new Promise(r => setTimeout(r, 1500));
    const base = player.baseStats?.[statKey] || 0;
    const effectBonus = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const eventBonus = gameState.eventBonus || 0;
    const charBonus = rulesEngine.getAttackBonus(player, { isNeutral: true }).bonus;
    const dice = Math.floor(Math.random() * 6) + 1;
    const total = base + effectBonus + eventBonus + charBonus + dice;
    const win = total >= biome.difficulty;
    let res = { stat: statName, base, effectBonus, eventBonus, charBonus, dice, total, difficulty: biome.difficulty, win, biome };
    if (win) {
      const newTerr = { id: `terr_${Date.now()}`, biome: biome.key, name: biome.name };
      await updatePlayer(playerIndex, { usedAttackDice: true, territories: [...(player.territories || []), newTerr], [biome.resource]: (player[biome.resource] || 0) + 1 });
      await addPdvWithHistory(playerIndex, 1, 'TERRITORY', { biome: biome.name });
      res.pdv = 1;
    } else {
      await updatePlayer(playerIndex, { usedAttackDice: true });
    }
    setResult(res); setRolling(false); setMode('result');
  };

  const reset = () => { setMode('select'); setTarget(null); setStat(null); setResult(null); };

  if (mode === 'stat') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, `üè∞ Attaque ${target.name}`),
      React.createElement("p", { className: "text-center text-gray-600" }, `Difficult√©: ${target.difficulty}`),
      React.createElement("div", { className: "grid grid-cols-2 gap-2" },
        Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("button", { key: k, onClick: () => chooseStat(k, n), className: "py-3 bg-green-600 text-white rounded-lg font-semibold" }, n))
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-2 bg-gray-600 text-white rounded-lg" }, "Annuler")
    );
  }

  if (rolling) {
    return React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl flex items-center justify-center" },
      React.createElement("p", { className: "text-white text-xl animate-pulse" }, "üè∞ Conqu√™te...")
    );
  }

  if (mode === 'result' && result) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: `p-6 rounded-xl text-white text-center ${result.win ? 'bg-green-600' : 'bg-red-600'}` },
        React.createElement("div", { className: "text-2xl font-bold" }, result.win ? "‚úÖ VICTOIRE" : "‚ùå √âCHEC"),
        React.createElement("div", { className: "text-lg mt-2" }, `${result.total} vs ${result.difficulty}`),
        result.win && React.createElement("div", { className: "mt-2" }, `+1 ${result.biome.resource} +${result.pdv} PDV`)
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-3 bg-gray-600 text-white rounded-xl" }, "Fermer")
    );
  }

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center" }, "üè∞ Conqu√™te de Biome"),
    player.usedAttackDice && React.createElement("div", { className: "p-3 bg-yellow-50 border-2 border-yellow-300 rounded-lg text-center" }, React.createElement("p", { className: "text-yellow-800" }, "‚ö†Ô∏è Jet utilis√© ce tour")),
    React.createElement("div", { className: "space-y-3" },
      biomeList.map(b => React.createElement("button", { key: b.key, onClick: () => selectBiome(b), disabled: player.usedAttackDice || !isMyTurn, className: `w-full p-4 rounded-xl text-left ${!player.usedAttackDice && isMyTurn ? `bg-gradient-to-r ${b.color} text-white` : 'bg-gray-300 text-gray-500'}` },
        React.createElement("div", { className: "flex justify-between items-center" },
          React.createElement("span", { className: "text-lg font-bold" }, `${b.emoji} ${b.name}`),
          React.createElement("span", null, `Diff: ${b.difficulty}`)
        )
      ))
    )
  );
}

function BossAttack({ gameState, player, playerIndex, isMyTurn, updatePlayer, addPdvWithHistory }) {
  const [mode, setMode] = useState('select');
  const [target, setTarget] = useState(null);
  const [stat, setStat] = useState(null);
  const [rolling, setRolling] = useState(false);
  const [result, setResult] = useState(null);

  const territoryCounts = countTerritoriesByBiome(player.territories);
  const defeatedBosses = player.defeatedBosses || [];
  const bossList = Object.entries(BOSSES).filter(([k]) => !defeatedBosses.includes(k) && territoryCounts[k] >= 2).map(([k, b]) => ({ key: k, ...b }));

  const selectBoss = (b) => { setTarget(b); setMode('stat'); };
  const chooseStat = (k, n) => { setStat({ key: k, name: n }); execute(target, k, n); };

  const execute = async (boss, statKey, statName) => {
    setMode('rolling'); setRolling(true);
    await new Promise(r => setTimeout(r, 1500));
    const base = player.baseStats?.[statKey] || 0;
    const effectBonus = (player.effects || []).filter(e => e.stat === statKey).reduce((s, e) => s + e.delta, 0);
    const dice = Math.floor(Math.random() * 6) + 1;
    const total = base + effectBonus + dice;
    const win = total >= boss.difficulty;
    let res = { stat: statName, base, effectBonus, dice, total, difficulty: boss.difficulty, win, boss };
    if (win) {
      await updatePlayer(playerIndex, { usedAttackDice: true, defeatedBosses: [...defeatedBosses, boss.key] });
      await addPdvWithHistory(playerIndex, boss.pdv, 'BOSS', { boss: boss.name });
      res.pdv = boss.pdv;
    } else {
      await updatePlayer(playerIndex, { usedAttackDice: true, pvCurrent: Math.max(0, player.pvCurrent - 2) });
      res.damage = 2;
    }
    setResult(res); setRolling(false); setMode('result');
  };

  const reset = () => { setMode('select'); setTarget(null); setStat(null); setResult(null); };

  if (mode === 'stat') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, `üêâ ${target.name}`),
      React.createElement("p", { className: "text-center text-gray-600" }, `Difficult√©: ${target.difficulty}`),
      React.createElement("div", { className: "grid grid-cols-2 gap-2" },
        Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("button", { key: k, onClick: () => chooseStat(k, n), className: "py-3 bg-red-600 text-white rounded-lg font-semibold" }, n))
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-2 bg-gray-600 text-white rounded-lg" }, "Annuler")
    );
  }

  if (rolling) {
    return React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-red-600 to-red-800 rounded-xl flex items-center justify-center" },
      React.createElement("p", { className: "text-white text-xl animate-pulse" }, "üêâ Combat de Boss...")
    );
  }

  if (mode === 'result' && result) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: `p-6 rounded-xl text-white text-center ${result.win ? 'bg-green-600' : 'bg-red-600'}` },
        React.createElement("div", { className: "text-2xl font-bold" }, result.win ? "‚úÖ BOSS VAINCU" : "‚ùå D√âFAITE"),
        React.createElement("div", { className: "text-lg mt-2" }, `${result.total} vs ${result.difficulty}`),
        result.win && React.createElement("div", { className: "mt-2" }, `+${result.pdv} PDV`),
        result.damage && React.createElement("div", { className: "mt-2" }, `üíî -${result.damage} PV`)
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-3 bg-gray-600 text-white rounded-xl" }, "Fermer")
    );
  }

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center" }, "üêâ Combat de Boss"),
    player.usedAttackDice && React.createElement("div", { className: "p-3 bg-yellow-50 border-2 border-yellow-300 rounded-lg text-center" }, React.createElement("p", { className: "text-yellow-800" }, "‚ö†Ô∏è Jet utilis√©")),
    bossList.length === 0 ? React.createElement("div", { className: "p-6 bg-gray-100 rounded-xl text-center" },
      React.createElement("p", { className: "text-gray-600" }, "Aucun boss disponible"),
      React.createElement("p", { className: "text-sm text-gray-500 mt-2" }, "Besoin de 2 territoires du biome")
    ) : React.createElement("div", { className: "space-y-3" },
      bossList.map(b => React.createElement("button", { key: b.key, onClick: () => selectBoss(b), disabled: player.usedAttackDice || !isMyTurn, className: `w-full p-4 rounded-xl text-left ${!player.usedAttackDice && isMyTurn ? 'bg-gradient-to-r from-red-600 to-red-800 text-white' : 'bg-gray-300'}` },
        React.createElement("div", { className: "flex justify-between items-center" },
          React.createElement("span", { className: "text-lg font-bold" }, `${b.emoji} ${b.name}`),
          React.createElement("span", null, `Diff: ${b.difficulty} | +${b.pdv} PDV`)
        )
      ))
    )
  );
}

function CombatAttack({ gameState, player, playerIndex, isMyTurn, updatePlayer, addPdvWithHistory, players }) {
  const [mode, setMode] = useState('select');
  const [target, setTarget] = useState(null);
  const [stat, setStat] = useState(null);
  const [sacrifice, setSacrifice] = useState(0);
  const [rolling, setRolling] = useState(false);
  const [result, setResult] = useState(null);

  const opponents = ensureArray(players).filter((p, i) => p && i !== playerIndex && p.pvCurrent > 0);
  const canChooseStat = rulesEngine.canChooseStat(player);
  const canSacrifice = rulesEngine.canSacrificePv(player);

  const start = () => {
    if (opponents.length === 1) { setTarget(opponents[0]); setMode(canChooseStat ? 'stat' : (canSacrifice ? 'sacrifice' : 'confirm')); }
    else setMode('target');
  };

  const selectTarget = (t) => { setTarget(t); setMode(canChooseStat ? 'stat' : (canSacrifice ? 'sacrifice' : 'confirm')); };
  const chooseStat = (k, n) => { setStat({ key: k, name: n }); setMode(canSacrifice ? 'sacrifice' : 'confirm'); };

  const execute = async (defender, statKey, statName, sacrificePv) => {
    setMode('rolling'); setRolling(true);
    await new Promise(r => setTimeout(r, 1500));

    const stats = Object.keys(STAT_NAMES);
    const usedStat = statKey || stats[Math.floor(Math.random() * stats.length)];
    const usedStatName = statName || STAT_NAMES[usedStat];

    const attBase = player.baseStats?.[usedStat] || 0;
    const attEffect = (player.effects || []).filter(e => e.stat === usedStat).reduce((s, e) => s + e.delta, 0);
    const attDice = Math.floor(Math.random() * 6) + 1;
    const attTotal = attBase + attEffect + sacrificePv + attDice;

    const defBase = defender.baseStats?.[usedStat] || 0;
    const defEffect = (defender.effects || []).filter(e => e.stat === usedStat).reduce((s, e) => s + e.delta, 0);
    const defDice = Math.floor(Math.random() * 6) + 1;
    const defTotal = defBase + defEffect + defDice;

    const draw = attTotal === defTotal;
    const win = attTotal > defTotal;

    let res = { stat: usedStatName, att: { base: attBase, effect: attEffect, sacrifice: sacrificePv, dice: attDice, total: attTotal }, def: { base: defBase, effect: defEffect, dice: defDice, total: defTotal }, draw, win, target: defender };

    const defIdx = players.findIndex(p => p && p.id === defender.id);

    if (sacrificePv > 0) await updatePlayer(playerIndex, { pvCurrent: player.pvCurrent - sacrificePv });

    if (win) {
      const damage = Math.max(1, attTotal - defTotal);
      const newDefPv = Math.max(0, defender.pvCurrent - damage);
      const died = newDefPv <= 0;
      const heal = rulesEngine.getHealOnSuccess(player);
      res.damage = damage; res.died = died;

      if (defIdx >= 0) await db.ref(`games/${gameState.code}/players/${defIdx}`).update({ pvCurrent: newDefPv });
      if (heal > 0) await updatePlayer(playerIndex, { pvCurrent: Math.min(player.character.pvMax, player.pvCurrent + heal) });

      if (died) {
        const killPdv = 2 + rulesEngine.getKillBonus(player, defender);
        await addPdvWithHistory(playerIndex, killPdv, 'KILL', { victim: defender.playerName });
        res.pdv = killPdv;
      }
    } else if (!draw) {
      const counterDmg = player.characterKey === 'CHASSEUR' ? 0 : 1;
      if (counterDmg > 0) {
        await updatePlayer(playerIndex, { pvCurrent: Math.max(0, player.pvCurrent - counterDmg) });
        res.counter = counterDmg;
      }
    }

    await updatePlayer(playerIndex, { usedAttackDice: true });
    setResult(res); setRolling(false); setMode('result');
  };

  const reset = () => { setMode('select'); setTarget(null); setStat(null); setSacrifice(0); setResult(null); };

  if (mode === 'target') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, "Choisir cible"),
      React.createElement("div", { className: "space-y-2" },
        opponents.map(o => React.createElement("button", { key: o.id, onClick: () => selectTarget(o), className: "w-full p-4 bg-red-600 text-white rounded-lg" },
          React.createElement("div", { className: "flex justify-between" },
            React.createElement("span", { className: "font-bold" }, o.playerName),
            React.createElement("span", null, `‚ù§Ô∏è ${o.pvCurrent}`)
          )
        ))
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-2 bg-gray-600 text-white rounded-lg" }, "Annuler")
    );
  }

  if (mode === 'stat') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, "üîÆ Choisir statistique"),
      React.createElement("div", { className: "grid grid-cols-2 gap-2" },
        Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("button", { key: k, onClick: () => chooseStat(k, n), className: "py-3 bg-purple-600 text-white rounded-lg font-semibold" }, n))
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-2 bg-gray-600 text-white rounded-lg" }, "Annuler")
    );
  }

  if (mode === 'sacrifice') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, "ü©∏ Sacrifice"),
      React.createElement("div", { className: "flex items-center justify-center gap-4" },
        React.createElement("button", { onClick: () => setSacrifice(Math.max(0, sacrifice - 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold" }, "-"),
        React.createElement("span", { className: "text-5xl font-bold text-red-600" }, sacrifice),
        React.createElement("button", { onClick: () => setSacrifice(Math.min(player.pvCurrent - 1, sacrifice + 1)), className: "w-12 h-12 bg-red-600 text-white rounded-full font-bold" }, "+")
      ),
      React.createElement("div", { className: "grid grid-cols-2 gap-2" },
        React.createElement("button", { onClick: reset, className: "py-3 bg-gray-600 text-white rounded-lg" }, "Annuler"),
        React.createElement("button", { onClick: () => execute(target, stat?.key, stat?.name, sacrifice), className: "py-3 bg-red-600 text-white rounded-lg font-bold" }, "Confirmer")
      )
    );
  }

  if (mode === 'confirm') {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("h3", { className: "text-xl font-bold text-center" }, `‚öîÔ∏è Attaquer ${target.playerName}?`),
      React.createElement("div", { className: "grid grid-cols-2 gap-2" },
        React.createElement("button", { onClick: reset, className: "py-3 bg-gray-600 text-white rounded-lg" }, "Annuler"),
        React.createElement("button", { onClick: () => execute(target, stat?.key, stat?.name, sacrifice), className: "py-3 bg-red-600 text-white rounded-lg font-bold" }, "Attaquer")
      )
    );
  }

  if (rolling) {
    return React.createElement("div", { className: "min-h-[200px] bg-gradient-to-r from-red-600 to-red-800 rounded-xl flex items-center justify-center" },
      React.createElement("p", { className: "text-white text-xl animate-pulse" }, "‚öîÔ∏è Combat...")
    );
  }

  if (mode === 'result' && result) {
    return React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: `p-6 rounded-xl text-white text-center ${result.draw ? 'bg-gray-600' : result.win ? 'bg-green-600' : 'bg-orange-600'}` },
        React.createElement("div", { className: "text-2xl font-bold" }, result.draw ? "ü§ù √âGALIT√â" : result.win ? "‚úÖ VICTOIRE" : "üõ°Ô∏è √âCHEC"),
        React.createElement("div", { className: "text-lg mt-2" }, `${result.att.total} vs ${result.def.total}`),
        result.win && result.damage && React.createElement("div", { className: "mt-2" }, `üí• ${result.damage} d√©g√¢ts`),
        result.died && React.createElement("div", { className: "text-yellow-300 mt-2" }, `üíÄ Kill ! +${result.pdv} PDV`),
        result.counter && React.createElement("div", { className: "mt-2" }, `üí¢ -${result.counter} PV riposte`)
      ),
      React.createElement("button", { onClick: reset, className: "w-full py-3 bg-gray-600 text-white rounded-xl" }, "Fermer")
    );
  }

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center" }, "‚öîÔ∏è Combat Joueur"),
    player.usedAttackDice && React.createElement("div", { className: "p-3 bg-yellow-50 border-2 border-yellow-300 rounded-lg text-center" }, React.createElement("p", { className: "text-yellow-800" }, "‚ö†Ô∏è Jet utilis√©")),
    React.createElement("button", { onClick: start, disabled: player.usedAttackDice || opponents.length === 0 || !isMyTurn, className: `w-full py-4 rounded-xl font-bold text-lg ${!player.usedAttackDice && isMyTurn ? 'bg-gradient-to-r from-red-600 to-orange-600 text-white' : 'bg-gray-300 text-gray-500'}` }, "‚öîÔ∏è Attaquer")
  );
}

// ============= OBJECTIF TAB =============
function ObjectifTab({ gameState, player, playerIndex, isMyTurn, updatePlayer, updateGame, addPdvWithHistory }) {
  const completedIds = ensureArray(gameState.completedObjectives);
  const available = OBJECTIVES.filter(o => !completedIds.includes(o.id));

  const complete = async (obj) => {
    if (!isMyTurn) return;
    if ((player[obj.resource] || 0) < obj.amount) { alert("Ressources insuffisantes !"); return; }
    await updatePlayer(playerIndex, { [obj.resource]: player[obj.resource] - obj.amount });
    await updateGame({ completedObjectives: [...completedIds, obj.id] });
    await addPdvWithHistory(playerIndex, obj.pdv, 'BONUS', { objective: obj.label });
  };

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center text-gray-800" }, "üéØ Objectifs"),
    React.createElement("div", { className: "space-y-3" },
      available.map(o => {
        const hasEnough = (player[o.resource] || 0) >= o.amount;
        return React.createElement("div", { key: o.id, className: `p-4 rounded-xl border-2 ${hasEnough ? 'border-green-400 bg-green-50' : 'border-gray-200 bg-gray-50'}` },
          React.createElement("div", { className: "flex justify-between items-center" },
            React.createElement("div", null,
              React.createElement("span", { className: "text-2xl mr-2" }, o.emoji),
              React.createElement("span", { className: "font-bold" }, o.label),
              React.createElement("span", { className: "text-purple-600 ml-2" }, `+${o.pdv} PDV`)
            ),
            React.createElement("button", { onClick: () => complete(o), disabled: !hasEnough || !isMyTurn, className: `px-4 py-2 rounded-lg font-semibold ${hasEnough && isMyTurn ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'}` }, "Valider")
          ),
          React.createElement("div", { className: "text-sm text-gray-600 mt-1" }, `Vous avez: ${player[o.resource] || 0}`)
        );
      })
    ),
    completedIds.length > 0 && React.createElement("div", { className: "mt-6" },
      React.createElement("h4", { className: "font-bold text-gray-600 mb-2" }, "‚úÖ Compl√©t√©s"),
      React.createElement("div", { className: "flex flex-wrap gap-2" },
        completedIds.map(id => {
          const obj = OBJECTIVES.find(o => o.id === id);
          return obj && React.createElement("span", { key: id, className: "px-3 py-1 bg-gray-200 rounded-full text-sm" }, `${obj.emoji} ${obj.label}`);
        })
      )
    )
  );
}

// ============= ECHANGE TAB =============
function EchangeTab({ player, playerIndex, isMyTurn, updatePlayer }) {
  const rates = { or_cuivre: { from: 'or', to: 'cuivre', cost: 3, get: 1 }, or_argent: { from: 'or', to: 'argent', cost: 6, get: 1 }, or_obsidienne: { from: 'or', to: 'obsidienne', cost: 12, get: 1 }, cuivre_or: { from: 'cuivre', to: 'or', cost: 1, get: 2 }, argent_or: { from: 'argent', to: 'or', cost: 1, get: 4 }, obsidienne_or: { from: 'obsidienne', to: 'or', cost: 1, get: 8 } };
  const labels = { or: 'üí∞ Or', cuivre: 'ü•â Cuivre', argent: 'ü•à Argent', obsidienne: '‚¨õ Obsidienne' };

  const exchange = async (key) => {
    const r = rates[key];
    if ((player[r.from] || 0) < r.cost) return;
    await updatePlayer(playerIndex, { [r.from]: player[r.from] - r.cost, [r.to]: (player[r.to] || 0) + r.get });
  };

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center text-gray-800" }, "üîÑ √âchange"),
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4 mb-4" },
      React.createElement("div", { className: "grid grid-cols-4 gap-2 text-center" },
        Object.entries(labels).map(([k, l]) => React.createElement("div", { key: k },
          React.createElement("div", { className: "text-2xl" }, l.split(' ')[0]),
          React.createElement("div", { className: "font-bold text-lg" }, player[k] || 0)
        ))
      )
    ),
    React.createElement("div", { className: "space-y-2" },
      Object.entries(rates).map(([k, r]) => {
        const canDo = (player[r.from] || 0) >= r.cost;
        return React.createElement("button", { key: k, onClick: () => exchange(k), disabled: !canDo || !isMyTurn, className: `w-full p-3 rounded-lg flex justify-between items-center ${canDo && isMyTurn ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}` },
          React.createElement("span", null, `${r.cost} ${labels[r.from]}`),
          React.createElement("span", null, "‚Üí"),
          React.createElement("span", null, `${r.get} ${labels[r.to]}`)
        );
      })
    )
  );
}

// ============= PARI TAB =============
function PariTab({ gameState, player, playerIndex, isMyTurn, updatePlayer, updateGame, players }) {
  const [betAmount, setBetAmount] = useState(1);
  const [targetPlayer, setTargetPlayer] = useState(null);
  const [prediction, setPrediction] = useState('win');

  const allPlayers = ensureArray(players);
  const others = allPlayers.filter((p, i) => p && i !== playerIndex);
  const currentBets = ensureArray(gameState.activeBets);
  const myBet = currentBets.find(b => b && b.odId === player.odId);

  const placeBet = async () => {
    if (!targetPlayer || betAmount <= 0 || betAmount > player.or) return;
    const newBet = { id: `bet_${Date.now()}`, odId: player.odId, betterName: player.playerName, targetId: targetPlayer.id, targetName: targetPlayer.playerName, amount: betAmount, prediction, resolved: false };
    await updatePlayer(playerIndex, { or: player.or - betAmount });
    await updateGame({ activeBets: [...currentBets, newBet] });
  };

  const resolveBet = async (bet, won) => {
    const betterIdx = allPlayers.findIndex(p => p && p.odId === bet.odId);
    if (betterIdx < 0) return;
    const winnings = won ? bet.amount * 2 : 0;
    if (winnings > 0) await db.ref(`games/${gameState.code}/players/${betterIdx}`).update({ or: (allPlayers[betterIdx].or || 0) + winnings });
    const newBets = currentBets.filter(b => b.id !== bet.id);
    await updateGame({ activeBets: newBets });
  };

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center text-gray-800" }, "üé∞ Paris"),
    !myBet && React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4 space-y-3" },
      React.createElement("h4", { className: "font-bold" }, "Nouveau Pari"),
      React.createElement("select", { value: targetPlayer?.id || '', onChange: e => setTargetPlayer(others.find(p => p.id === e.target.value)), className: "w-full p-2 border rounded-lg" },
        React.createElement("option", { value: "" }, "Choisir joueur..."),
        others.map(p => React.createElement("option", { key: p.id, value: p.id }, p.playerName))
      ),
      React.createElement("div", { className: "flex gap-2" },
        React.createElement("button", { onClick: () => setPrediction('win'), className: `flex-1 py-2 rounded-lg font-semibold ${prediction === 'win' ? 'bg-green-600 text-white' : 'bg-gray-200'}` }, "‚úÖ Victoire"),
        React.createElement("button", { onClick: () => setPrediction('lose'), className: `flex-1 py-2 rounded-lg font-semibold ${prediction === 'lose' ? 'bg-red-600 text-white' : 'bg-gray-200'}` }, "‚ùå D√©faite")
      ),
      React.createElement("div", { className: "flex items-center gap-3" },
        React.createElement("span", null, "Mise:"),
        React.createElement("button", { onClick: () => setBetAmount(Math.max(1, betAmount - 1)), className: "w-10 h-10 bg-gray-300 rounded-full" }, "-"),
        React.createElement("span", { className: "text-2xl font-bold" }, betAmount),
        React.createElement("button", { onClick: () => setBetAmount(Math.min(player.or, betAmount + 1)), className: "w-10 h-10 bg-gray-300 rounded-full" }, "+"),
        React.createElement("span", { className: "text-gray-500" }, `(max: ${player.or})`)
      ),
      React.createElement("button", { onClick: placeBet, disabled: !targetPlayer || !isMyTurn, className: `w-full py-3 rounded-xl font-bold ${targetPlayer && isMyTurn ? 'bg-yellow-500 text-white' : 'bg-gray-300'}` }, "Parier")
    ),
    myBet && React.createElement("div", { className: "bg-yellow-100 rounded-xl p-4" },
      React.createElement("p", { className: "font-bold" }, "Votre pari actif:"),
      React.createElement("p", null, `${myBet.amount} Or sur ${myBet.prediction === 'win' ? 'victoire' : 'd√©faite'} de ${myBet.targetName}`)
    ),
    currentBets.length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-700 mb-2" }, "Paris en cours"),
      React.createElement("div", { className: "space-y-2" },
        currentBets.filter(b => !b.resolved).map(b => React.createElement("div", { key: b.id, className: "p-3 bg-gray-100 rounded-lg flex justify-between items-center" },
          React.createElement("div", null,
            React.createElement("span", { className: "font-semibold" }, b.betterName),
            React.createElement("span", { className: "text-gray-600" }, ` parie ${b.amount} Or: ${b.targetName} ${b.prediction === 'win' ? 'gagne' : 'perd'}`)
          ),
          isMyTurn && React.createElement("div", { className: "flex gap-1" },
            React.createElement("button", { onClick: () => resolveBet(b, true), className: "px-2 py-1 bg-green-500 text-white rounded text-sm" }, "‚úì"),
            React.createElement("button", { onClick: () => resolveBet(b, false), className: "px-2 py-1 bg-red-500 text-white rounded text-sm" }, "‚úó")
          )
        ))
      )
    )
  );
}

// ============= EVENT TAB =============
function EventTab({ gameState, updateGame, isMyTurn }) {
  const [customBonus, setCustomBonus] = useState(0);
  const activeEvents = ensureArray(gameState.activeEvents);

  const triggerEvent = async () => {
    if (!isMyTurn) return;
    const eventText = MAJOR_EVENTS[Math.floor(Math.random() * MAJOR_EVENTS.length)];
    const newEvent = { id: `evt_${Date.now()}`, text: eventText, timestamp: Date.now() };
    await updateGame({ activeEvents: [...activeEvents, newEvent] });
  };

  const setBonus = async () => {
    await updateGame({ eventBonus: customBonus });
  };

  const clearEvents = async () => {
    await updateGame({ activeEvents: [] });
  };

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("h3", { className: "text-xl font-bold text-center text-gray-800" }, "üé≠ √âv√©nements"),
    React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold mb-2" }, "Bonus de tour actuel"),
      React.createElement("div", { className: "flex items-center justify-center gap-4" },
        React.createElement("button", { onClick: () => setCustomBonus(Math.max(-5, customBonus - 1)), className: "w-12 h-12 bg-red-500 text-white rounded-full font-bold" }, "-"),
        React.createElement("span", { className: "text-4xl font-bold" }, gameState.eventBonus || 0),
        React.createElement("button", { onClick: () => setCustomBonus(Math.min(10, customBonus + 1)), className: "w-12 h-12 bg-green-500 text-white rounded-full font-bold" }, "+")
      ),
      React.createElement("button", { onClick: setBonus, disabled: !isMyTurn, className: `w-full mt-3 py-2 rounded-lg font-semibold ${isMyTurn ? 'bg-purple-600 text-white' : 'bg-gray-300'}` }, `D√©finir bonus: ${customBonus >= 0 ? '+' : ''}${customBonus}`)
    ),
    React.createElement("button", { onClick: triggerEvent, disabled: !isMyTurn, className: `w-full py-4 rounded-xl font-bold text-lg ${isMyTurn ? 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white' : 'bg-gray-300'}` }, "üé≤ D√©clencher un √âv√©nement"),
    activeEvents.length > 0 && React.createElement("div", null,
      React.createElement("div", { className: "flex justify-between items-center mb-2" },
        React.createElement("h4", { className: "font-bold text-gray-700" }, "Historique"),
        React.createElement("button", { onClick: clearEvents, className: "text-red-500 text-sm" }, "Effacer")
      ),
      React.createElement("div", { className: "space-y-2 max-h-60 overflow-auto" },
        [...activeEvents].reverse().map(e => React.createElement("div", { key: e.id, className: "p-3 bg-yellow-50 border border-yellow-200 rounded-lg" },
          React.createElement("p", null, e.text)
        ))
      )
    )
  );
}

// ============= PERSONNAGE TAB =============
function PersonnageTab({ player, playerIndex, isMyTurn, updatePlayer }) {
  const [subTab, setSubTab] = useState('stats');
  const [newEffect, setNewEffect] = useState({ type: 'BLESS', stat: 'force' });

  const addEffect = async () => {
    if (!isMyTurn) return;
    const effect = { id: `eff_${Date.now()}`, type: newEffect.type, name: newEffect.type === 'BLESS' ? 'B√©n√©diction' : 'Mal√©diction', stat: newEffect.stat, delta: newEffect.type === 'BLESS' ? 2 : -2 };
    await updatePlayer(playerIndex, { effects: [...(player.effects || []), effect] });
  };

  const removeEffect = async (effId) => {
    if (!isMyTurn) return;
    await updatePlayer(playerIndex, { effects: (player.effects || []).filter(e => e.id !== effId) });
  };

  return React.createElement("div", { className: "space-y-4" },
    React.createElement("div", { className: "flex gap-2 mb-4" },
      React.createElement("button", { onClick: () => setSubTab('stats'), className: `flex-1 py-2 rounded-lg font-semibold ${subTab === 'stats' ? 'bg-blue-600 text-white' : 'bg-gray-200'}` }, "üìä Stats"),
      React.createElement("button", { onClick: () => setSubTab('skills'), className: `flex-1 py-2 rounded-lg font-semibold ${subTab === 'skills' ? 'bg-purple-600 text-white' : 'bg-gray-200'}` }, "‚öîÔ∏è Comp√©tences"),
      React.createElement("button", { onClick: () => setSubTab('etat'), className: `flex-1 py-2 rounded-lg font-semibold ${subTab === 'etat' ? 'bg-pink-600 text-white' : 'bg-gray-200'}` }, "üí´ √âtats")
    ),

    subTab === 'stats' && React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: "bg-gradient-to-r from-red-500 to-pink-500 rounded-xl p-4 text-white text-center" },
        React.createElement("div", { className: "text-sm opacity-80" }, "Points de Vie"),
        React.createElement("div", { className: "text-4xl font-bold" }, `${player.pvCurrent} / ${player.character?.pvMax}`),
        React.createElement("div", { className: "w-full bg-white bg-opacity-30 rounded-full h-3 mt-2" },
          React.createElement("div", { className: "bg-white h-3 rounded-full transition-all", style: { width: `${(player.pvCurrent / player.character?.pvMax) * 100}%` } })
        )
      ),
      React.createElement("div", { className: "grid grid-cols-2 gap-3" },
        Object.entries(STAT_NAMES).map(([k, n]) => {
          const base = player.baseStats?.[k] || 0;
          const bonus = (player.effects || []).filter(e => e.stat === k).reduce((s, e) => s + e.delta, 0);
          return React.createElement("div", { key: k, className: "bg-gray-100 rounded-xl p-3 text-center" },
            React.createElement("div", { className: "text-sm text-gray-600" }, n),
            React.createElement("div", { className: "text-2xl font-bold" }, base),
            bonus !== 0 && React.createElement("div", { className: `text-sm ${bonus > 0 ? 'text-green-600' : 'text-red-600'}` }, `${bonus > 0 ? '+' : ''}${bonus}`)
          );
        })
      ),
      React.createElement("div", { className: "bg-yellow-50 rounded-xl p-4" },
        React.createElement("h4", { className: "font-bold text-gray-800 mb-2" }, "üì¶ Ressources"),
        React.createElement("div", { className: "grid grid-cols-4 gap-2 text-center" },
          React.createElement("div", null, React.createElement("div", { className: "text-xl" }, "üí∞"), React.createElement("div", { className: "font-bold" }, player.or || 0)),
          React.createElement("div", null, React.createElement("div", { className: "text-xl" }, "ü•â"), React.createElement("div", { className: "font-bold" }, player.cuivre || 0)),
          React.createElement("div", null, React.createElement("div", { className: "text-xl" }, "ü•à"), React.createElement("div", { className: "font-bold" }, player.argent || 0)),
          React.createElement("div", null, React.createElement("div", { className: "text-xl" }, "‚¨õ"), React.createElement("div", { className: "font-bold" }, player.obsidienne || 0))
        )
      )
    ),

    subTab === 'skills' && React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: "bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl p-4 text-white" },
        React.createElement("h3", { className: "text-xl font-bold" }, player.character?.name),
        React.createElement("p", { className: "text-sm opacity-80" }, player.character?.role),
        React.createElement("p", { className: "text-sm italic mt-2" }, player.character?.concept)
      ),
      React.createElement("div", { className: "space-y-3" },
        (player.skills || []).map((skill, idx) => React.createElement("div", { key: skill.id || idx, className: "p-4 rounded-xl border-2 bg-blue-50 border-blue-300" },
          React.createElement("div", { className: "flex items-start gap-3" },
            React.createElement("div", { className: "text-2xl" }, idx === 0 ? 'üîÆ' : idx === 1 ? '‚öîÔ∏è' : 'üõ°Ô∏è'),
            React.createElement("div", { className: "flex-1" },
              React.createElement("div", { className: "font-bold text-gray-800" }, `Comp√©tence ${idx + 1}`),
              React.createElement("p", { className: "text-sm text-gray-600 mt-1" }, skill.description)
            )
          )
        ))
      )
    ),

    subTab === 'etat' && React.createElement("div", { className: "space-y-4" },
      React.createElement("div", { className: "bg-purple-50 rounded-xl p-4" },
        React.createElement("h3", { className: "text-lg font-bold text-gray-800 mb-3" }, "üí´ √âtats Actifs"),
        (player.effects || []).length === 0 ? React.createElement("p", { className: "text-gray-500 italic text-center py-4" }, "Aucun √©tat actif") :
        React.createElement("div", { className: "space-y-2 mb-4" },
          (player.effects || []).map(e => React.createElement("div", { key: e.id, className: `flex justify-between items-center p-3 rounded-lg ${e.type === 'BLESS' ? 'bg-green-100 border border-green-400' : 'bg-red-100 border border-red-400'}` },
            React.createElement("div", null,
              React.createElement("span", { className: e.type === 'BLESS' ? 'text-green-700 font-bold' : 'text-red-700 font-bold' }, `${e.type === 'BLESS' ? '‚ú®' : 'üíÄ'} ${e.name}`),
              React.createElement("span", { className: "text-gray-600 ml-2" }, `(${STAT_NAMES[e.stat]}: ${e.delta >= 0 ? '+' : ''}${e.delta})`)
            ),
            React.createElement("button", { onClick: () => removeEffect(e.id), disabled: !isMyTurn, className: "px-3 py-1 bg-red-500 text-white rounded text-sm" }, "‚úï")
          ))
        ),
        React.createElement("div", { className: "border-t border-purple-200 pt-4" },
          React.createElement("h4", { className: "font-semibold text-gray-700 mb-2" }, "Ajouter un √©tat"),
          React.createElement("div", { className: "grid grid-cols-2 gap-2 mb-2" },
            React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'BLESS' }), className: `py-2 rounded-lg font-semibold ${newEffect.type === 'BLESS' ? 'bg-green-600 text-white' : 'bg-gray-200'}` }, "‚ú® B√©n√©diction"),
            React.createElement("button", { onClick: () => setNewEffect({ ...newEffect, type: 'CURSE' }), className: `py-2 rounded-lg font-semibold ${newEffect.type === 'CURSE' ? 'bg-red-600 text-white' : 'bg-gray-200'}` }, "üíÄ Mal√©diction")
          ),
          React.createElement("select", { value: newEffect.stat, onChange: e => setNewEffect({ ...newEffect, stat: e.target.value }), className: "w-full p-2 border rounded-lg mb-2" },
            Object.entries(STAT_NAMES).map(([k, n]) => React.createElement("option", { key: k, value: k }, n))
          ),
          React.createElement("button", { onClick: addEffect, disabled: !isMyTurn, className: `w-full py-2 rounded-lg font-semibold ${isMyTurn ? 'bg-purple-600 text-white' : 'bg-gray-300 text-gray-500'}` }, "Ajouter l'√©tat")
        )
      )
    )
  );
}

// ============= PDV HISTORY TAB =============
function PdvHistoryTab({ player, gameState, players }) {
  const history = player.pdvHistory || [];
  const totals = useMemo(() => {
    const sums = {};
    history.forEach(e => { sums[e.source] = (sums[e.source] || 0) + e.amount; });
    return sums;
  }, [history]);

  const allPlayers = ensureArray(players);
  const ranking = useMemo(() => [...allPlayers].filter(p => p).sort((a, b) => (b?.pdv || 0) - (a?.pdv || 0)), [allPlayers]);
  const totalPdv = allPlayers.reduce((sum, p) => sum + (p?.pdv || 0), 0);
  const targetPdv = gameState.playerCount * 10;

  return React.createElement("div", { className: "space-y-6" },
    React.createElement("div", { className: "text-center" },
      React.createElement("h3", { className: "text-2xl font-bold text-gray-800" }, "üèÜ Points de Victoire"),
      React.createElement("div", { className: "text-5xl font-bold text-amber-500" }, player.pdv),
      React.createElement("div", { className: "bg-purple-100 rounded-lg p-3 mt-3" },
        React.createElement("div", { className: "text-sm text-purple-700 font-bold" }, `Total: ${totalPdv} / ${targetPdv} PDV`),
        React.createElement("div", { className: "w-full bg-purple-200 rounded-full h-3 mt-2" },
          React.createElement("div", { className: "bg-purple-600 h-3 rounded-full transition-all", style: { width: `${Math.min(100, (totalPdv / targetPdv) * 100)}%` } })
        )
      )
    ),
    React.createElement("div", { className: "bg-gray-50 rounded-xl p-4" },
      React.createElement("h4", { className: "font-bold text-gray-800 mb-3" }, "üìä R√©partition"),
      React.createElement("div", { className: "grid grid-cols-2 md:grid-cols-4 gap-3" },
        Object.entries(PDV_SOURCES).map(([k, info]) => React.createElement("div", { key: k, className: "bg-white rounded-lg p-3 text-center shadow" },
          React.createElement("div", { className: "text-2xl" }, info.emoji),
          React.createElement("div", { className: `text-2xl font-bold ${info.color}` }, totals[k] || 0),
          React.createElement("div", { className: "text-xs text-gray-500" }, info.label)
        ))
      )
    ),
    history.length > 0 && React.createElement("div", null,
      React.createElement("h4", { className: "font-bold text-gray-800 mb-3" }, `üìú Historique (${history.length})`),
      React.createElement("div", { className: "space-y-2 max-h-60 overflow-auto" },
        [...history].reverse().map(e => {
          const info = PDV_SOURCES[e.source] || PDV_SOURCES.BONUS;
          return React.createElement("div", { key: e.id, className: "flex items-center gap-3 bg-gray-50 rounded-lg p-3" },
            React.createElement("span", { className: "text-2xl" }, info.emoji),
            React.createElement("div", { className: "flex-1" },
              React.createElement("span", { className: `font-bold ${info.color}` }, `+${e.amount} PDV`),
              React.createElement("span", { className: "text-gray-500 text-sm ml-2" }, info.label),
              e.details && Object.keys(e.details).length > 0 && React.createElement("div", { className: "text-xs text-gray-400" }, Object.values(e.details).join(' ‚Ä¢ '))
            )
          );
        })
      )
    ),
    React.createElement("div", { className: "bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-4 text-white" },
      React.createElement("h4", { className: "font-bold mb-3" }, "üèÖ Classement"),
      React.createElement("div", { className: "space-y-2" },
        ranking.map((p, i) => React.createElement("div", { key: p?.id || i, className: `flex items-center gap-3 p-2 rounded-lg ${p?.id === player.id ? 'bg-white bg-opacity-20' : ''}` },
          React.createElement("span", { className: `text-xl font-bold ${i === 0 ? 'text-yellow-300' : i === 1 ? 'text-gray-300' : i === 2 ? 'text-amber-400' : ''}` }, `#${i + 1}`),
          React.createElement("span", { className: "flex-1" }, p?.playerName || 'Inconnu'),
          React.createElement("span", { className: "text-xl font-bold" }, p?.pdv || 0)
        ))
      )
    )
  );
}

// ============= RENDER =============
createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
